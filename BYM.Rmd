---
title: "Résultats_1"
author: "Edgar Lanoue"
date: "2024-08-19"
output: html_document
editor_options: 
  chunk_output_type: console
---
# Figures
fig correlation
fig: indice npq
fig: nbAcc_reelAttendus_gravAnnee

# Tableaux
tab: modBase_coef
tab: dic_avecNQC
tab: dic_avecNQC
tab: modBase_coef
tab: varPropSS
tab: coefs ind_covid
tab: coefs bernar
tab: coefs logis
tab: coef interac
tab: mrc coefs interac
tab: coefs 2var
tab: coef nbAccUV
###########################


Changer les liens vers vos données:
```{r}
path <- "C:/Users/edgar/OneDrive/Bureau/Ecole/HEC/E23/SAAQ/SR - Propre"

pathBrutes <- file.path(path, "Donnees", "Brutes")
pathBrutesWeb <- file.path(pathBrutes, "web")
pathTraitees <- file.path(path, "Donnees", "Traitees")
```

# CRS
```{r}
library(sf)
crs <- st_crs("NAD83")
projUTM <- st_crs("+proj=utm +zone=18 +datum=NAD83 +units=km +no_defs")
```

Pareil à travers tous les codes!
###########################

```{r}
library(vctrs)
library(osmdata)
library(mapview)
library(tidyverse)
library(sf)
library(tictoc)
library(sp)

library(cancensus)
library(INLA)
library(inlabru)

library(spdep)

library(INLA)
library(Matrix)
library(spatialreg)
library(SpatialEpi)

# ## Quick fix for stargazer <= 5.2.3 is.na() issue with long model names in R >= 4.2
# # Unload stargazer if loaded
# detach("package:stargazer",unload=T)
# # Delete it
# remove.packages("stargazer")
# # Download the source
# download.file("https://cran.r-project.org/src/contrib/stargazer_5.2.3.tar.gz", destfile = "stargazer_5.2.3.tar.gz")
# # Unpack
# untar("stargazer_5.2.3.tar.gz")
# # Read the sourcefile with .inside.bracket fun
# stargazer_src <- readLines("stargazer/R/stargazer-internal.R")
# # Move the length check 5 lines up so it precedes is.na(.)
# stargazer_src[1990] <- stargazer_src[1995]
# stargazer_src[1995] <- ""
# # Save back
# writeLines(stargazer_src, con="stargazer/R/stargazer-internal.R")
# # Compile and install the patched package
# install.packages("stargazer", repos = NULL, type="source")
library(stargazer)


library(tmap)
tmap_mode("view")
library(rlang)
```


# Importation données
```{r}
file.path(pathTraitees, "")
load(file.path(pathTraitees, "acc_PA_mun.Rda"))
load(file.path(pathTraitees, "acc_PA_mrc.Rda"))
load(file.path(pathTraitees, "acc_PM_mrc.Rda"))
load(file.path(pathTraitees, "qc_muncp.Rda"))
load(file.path(pathTraitees, "qc_mrc.Rda"))
load(file.path(pathTraitees, "data_acc_maj.Rda"))


acc_PA_mun <- acc_PA_mun %>% arrange(gravite, CD_MUN, CD_MRC) 
acc_PA_mrc <- acc_PA_mrc %>% arrange(gravite, CD_MRC) 
acc_PM_mrc <- acc_PM_mrc %>% arrange(gravite, CD_MRC) 


# table(acc_PM_mrc$CD_MRC==acc_PM_mrc %>% arrange(gravite, CD_MRC, as.character(An), Mois) %>% .$CD_MRC )
# Verif
  # sum(acc_PA_mrc$vktPopu)
  # sum(acc_PM_mrc$vktPopu)/12

# Voisinages
load(file.path(pathTraitees, "nb_mun.Rda"))
load(file.path(pathTraitees, "nb_mrc.Rda"))

# Construction des listes de voisinage contenant les poids
lw_mun_b <- nb2listw(nb_mun_maj, style = "B", zero.policy = T)
lw_mrc_b <- nb2listw(nb_mrc_maj, style = "B", zero.policy = T)
dim(data_acc)
```



# Fonctions utiles
```{r}
coefs_signif <- function(mod){
  temp <- mod$summary.fixed
  temp$rownames <- row.names(temp)
  family <- mod[["all.hyper"]][["family"]][[1]][["label"]]
  type <- mod$model.random
  coefs_signif <- data.frame(list(temp[(temp$`0.025quant` < 0 & temp$`0.975quant` < 0) | (temp$`0.025quant` > 0 & temp$`0.975quant` > 0),] %>% select(rownames, mean, `0.025quant`, `0.975quant`)))
  return(coefs_signif)
}


# Fonction qui retourne les coefficient significatifs en commun de 2 modèles, les coefficients significatifs de l'un et de l'autre

coefs_commun <- function(mod1, mod2){
  commun <- rownames(coefs_signif(mod2))[rownames(coefs_signif(mod2)) %in% rownames(coefs_signif(mod1))]
  dans1Seulement <- rownames(coefs_signif(mod1))[!rownames(coefs_signif(mod1)) %in% rownames(coefs_signif(mod2))]
  dans2Seulement <- rownames(coefs_signif(mod2))[!rownames(coefs_signif(mod2)) %in% rownames(coefs_signif(mod1))]
  return(list(enCommun=commun, dans1Seulement=dans1Seulement, dans2Seulement=dans2Seulement))
}

fV_carte <- function(jdD, fV, jdDCarte, nrow=NA, titre="Prédictions", id=NA, n=5, scales=F){
  temp <- cbind(jdD, fV)
  df_list <- temp %>% 
    select(An, mean) %>% 
    mutate(AnNum = as.numeric(as.character(An))) %>%
    group_split(AnNum)
  df <- data.frame(matrix(nrow=dim(df_list[[1]])[1], ncol=length(df_list)))
  colnames(df) <- as.character(unique(jdD$An))
  for (i in 1:length(df_list)){
    temp <- df_list[[i]] %>% select(mean)
    df[,i] <- temp
  }
  jdDCarte2 <- cbind(jdDCarte, df)
  t <- tm_shape(jdDCarte2) +
    tm_fill(paste0("X", colnames(df)),
            # midpoint = 0, 
            title = titre,
            id=id,
            n = n,
            style = "log10_pretty") +
    tm_facets(free.scales = scales, nrow = nrow) +
    tm_borders(lwd = 0.3, alpha = 0.4) + 
    tm_layout(panel.labels = as.numeric(colnames(df)))
  return(t)
}
check_overlap <- function(lower1, upper1, lower2, upper2) {
  # Check for NA values
  if (is.na(lower1) || is.na(upper1) || is.na(lower2) || is.na(upper2)) {
    return(FALSE)  # Return FALSE if any value is NA
  }
  
  # Check for overlap
  return(!(upper1 < lower2 || upper2 < lower1))
}

mod_tableauPropre <- function(mods, difSignificativité=F, difCred=F){
  len <- length(mods)
  coefs <- NULL
  dic <- NULL
  difIntervalle <- NULL
  df <- NULL
  for (i in 1:len){
    temp <- mods[[i]]$summary.fixed
    coefs <- c(coefs, row.names(temp))
    dic <- c(dic, round(mods[[i]]$dic$dic,3))
  }
  
  df <- tibble(coefs=unique(coefs))
  # nrow <- length(coefs)
  # df <- as.data.frame(matrix(NA, nrow = nrow, ncol = len))
  # rownames(df) <- coefs
  for (i in 1:len){
    temp <- mods[[i]]$summary.fixed
    temp$mean <- (round(temp$mean,3))
    temp$mean <- ifelse(
          (temp[,3] < 0 & temp[,5] < 0) | (temp[,3] > 0 & temp[,5] > 0),
          paste0(temp$mean, " *"),
          paste0(temp$mean)
        )
    temp$coefs <- row.names(temp)
    if(difCred == T){
      df <- left_join(df, temp[,c(1,3,5,8)], by=join_by(coefs==coefs))
    } else df <- left_join(df, temp[,c(1,8)], by=join_by(coefs==coefs))
  }
  if(difCred==T){
    if(len==2){
      for (i in 1:dim(df)[1]){
        difIntervalle = c(difIntervalle, check_overlap(df[i,3], df[i,4], df[i,6], df[i,7]))
      }
      df <- df[,c(1,2,5)]
    } else print("Length =! 2")
  }
  
  compteur=1
  Région <- "Région"
  Distribution <- "Distribution"
  iC <- "Covid-19"
  Gravité <- "Gravité"
  Exposition <- "Exposition"
  NQC <- "NQC"
  Modèle <- "Modèle"
  Interaction <- "Interaction"
  UV <- "Usag. Vul."
  unVeh <- "1 véh. impliqué"
  Mois <- "Période tempo."
  vÉ <- "VariableÉtudié"
  NAs <- rep(NA, length(names(mods))+1)
  for (i in names(mods)){
    Région <- c(Région, ifelse(grepl("mun", i), "Munic.", "MRC"))
    Distribution <- c(Distribution, mods[[compteur]][["all.hyper"]][["family"]][[1]][["label"]])
    iC <- c(iC, ifelse(grepl("iC", i), "Indic. tempo.", ifelse(grepl("npq", i), "ind_intervCOVID19", ifelse(any(grepl("iC", names(mods)))|any(grepl("npq", names(mods))),"Aucun", ""))))
    Gravité <- c(Gravité, ifelse(grepl("_M", i), "Mortel", ifelse(grepl("_GM", i), "Grave + Mortel", ifelse(grepl("_GL", i), "Grave + Léger", ifelse(grepl("_L", i), "Léger", ifelse(grepl("_G", i), "Grave", ""))))))
    Exposition <- c(Exposition, ifelse(grepl("_djma", i), "DJMA", "VKT"))
    NQC <- c(NQC, ifelse(grepl("_NQC", i), "Exclus", "Inclus"))
    Modèle <- c(Modèle, ifelse(grepl("bym", i), "BYM", ifelse(grepl("bernar", i), "Bernardinelli", ifelse(grepl("KH", i),"KH", ""))))
    Interaction <- c(Interaction, ifelse(grepl("_interac", i), "Avec", ifelse(any(grepl("_interac", names(mods))), "Sans", "")))
    UV <- c(UV, ifelse(grepl("ajUV", i), "nbAcc-nbAccUV", ifelse(grepl("UV", i), "nbAcc_UV", ifelse(any(grepl("UV", names(mods))),"nbAcc", ""))))
    unVeh <- c(unVeh, ifelse(grepl("aj1Veh", i), "nbAcc-nbAcc_1Veh", ifelse(grepl("1Veh", i), "nbAcc_1Veh", ifelse(any(grepl("1Veh", names(mods))),"nbAcc", ""))))
    Mois <- c(Mois, ifelse(grepl("mois", i), "Mois", ifelse(any(grepl("mois", names(mods))),"Année", "")))
    vÉ <- c(vÉ, ifelse(grepl("indUV", i), "indUV", ifelse(grepl("1Veh", i),"ind1Veh", ifelse(grepl("Disp", i),"ind_DisposFautif", ifelse(grepl("pts", i),"Pts moyens", "")))))
    
    compteur=compteur+1
  }
  Distribution <- gsub("poisson", "Poisson", Distribution)
  Distribution <- gsub("nbinomial", "BN", Distribution)
  Distribution <- gsub("zeroinflatedPoisson1", "ZIP", Distribution)
  
  df_titre <- t(data.frame(Modèle, Région, Distribution, Gravité, iC, Interaction, Exposition, NQC, UV, unVeh, Mois,vÉ, NAs))
  rownames(df_titre) <- NULL

  df_titre <- df_titre[apply(df_titre, 1, function(row) any(row[-1] != "")), ]
  colnames(df)[-1] <- paste("Modèle", 1:len)
  colnames(df)[1] <- "Coefficients"
  colnames(df_titre) <- colnames(df)
  df_titre <- as_tibble(df_titre)
  
  if(difCred==T){
    df_titre$coefsDistincts <- ""
    df <- df %>% mutate(coefsDistincts = ifelse(!difIntervalle, "<<", ""))
    df[dim(df)[1]+1,] <- rep(NA, dim(df)[2])
    df[dim(df)[1]+1,] <- t(data.frame(c("DIC", round(dic), "")))
  } else{
      df[dim(df)[1]+1,] <- rep(NA, dim(df)[2])
      df[dim(df)[1]+1,] <- t(data.frame(c("DIC", round(dic))))
  }
  
  df <- rbind(df_titre,df)
  
  if(difSignificativité==T){
    df <- df %>% mutate(difSignificativité = ifelse(
      rowSums(across(-Coefficients, ~ grepl("\\*", .))) > 0 & 
      rowSums(across(-Coefficients, ~ !grepl("\\*", .))) > 0, "***", ""))
  }
  df <- as.data.frame(df)
  return(df)
}

# table(acc_PA_mrc_M %>% filter(An==2014) %>% .$ind_covid)
# mods_sum <- temp
# var <- "SS"

compaVar <- function(var, mods_sum, bestFam=T){
  len <- dim(mods_sum)[2]
  tampon <- mods_sum[,-len] %>%
    group_by(!!sym(var)) %>%
    group_split()

  var_1 <- as.character(tampon[[1]][var][1,])
  var_2 <- as.character(tampon[[2]][var][1,])
  
  tampon_1 <- tampon[[1]] %>% select(-!!sym(var))
  tampon_2 <- tampon[[2]] %>% select(-!!sym(var))
  
  len <- dim(tampon_1)[2]
  df <- tampon_1 %>%
    inner_join(tampon_2, by = colnames(tampon_1)[-len], suffix = c("_1", "_2"))
  
  PGPP <- ifelse(df$DIC_1 > df$DIC_2, ">", ifelse(df$DIC_1 < df$DIC_2, "<", "="))
  exclude_cols <- c("Distribution", "DIC_1", "DIC_2")
  group_by_cols <- setdiff(colnames(df), exclude_cols)
  
  df <- df %>% group_by(across(all_of(group_by_cols))) %>%
    mutate(min_DIC_1_temp = min(DIC_1), min_DIC_2_temp = min(DIC_2)) %>%
    mutate(min_DIC_1 = ifelse(DIC_1==min_DIC_1_temp, "min_DIC_1", ""), 
           min_DIC_2 = ifelse(DIC_2==min_DIC_2_temp, "min_DIC_2", "")) %>%
    select(-min_DIC_1_temp, -min_DIC_2_temp)
  
  df_marked <- df %>%
    mutate(Mark = case_when(
      min_DIC_1 != "" & min_DIC_2 != "" ~ paste("*", Distribution, "*", sep=""),   # Both min_DIC_1 and min_DIC_2
      min_DIC_1 != "" ~ "*1*",                    # Only min_DIC_1
      min_DIC_2 != "" ~ "*2*",                    # Only min_DIC_2
      TRUE ~ ""                                  # Neither
    )) %>%
    select(-min_DIC_1, -min_DIC_2)
  
  df_marked <- df_marked %>%
    add_column("PGPP" = PGPP, .before = "DIC_2") %>%
    rename_with(
        ~ paste0("DIC_", c(var_1, var_2)), 
        .cols = c(DIC_1, DIC_2)
    )
  df_marked <- df_marked %>%
    mutate(across(starts_with("DIC"), round))
  colnames(df_marked)[c(len+1, len+3)] <- ""
  if(!bestFam){
    len <- dim(df_marked)[2]
    df_marked <- df_marked[,-len]
  }
  return(df_marked)
}

extractDIC <- function(mods, round=0, bestFam=T){
  DIC <- NULL
  for (i in mods){
    dic_mod <- round(i$dic$dic, round)
    DIC <- c(DIC, dic_mod)
    nom <- names(mods)
  }
  ret <- tibble(nom, DIC)
  
  compteur=1
  Région <- "Région"
  Distribution <- "Distribution"
  iC <- "Covid-19"
  Gravité <- "Gravité"
  Exposition <- "Exposition"
  NQC <- "NQC"
  SS <- "Structure spatiale"
  Modèle <- "Modèle"
  Interaction <- "Interaction"
  UV <- "Usag. Vul."
  unVeh <- "1 véh. impliqué"
  Mois <- "Mois"
  NAs <- rep(NA, length(names(mods))+1)
  for (i in names(mods)){
    Région <- c(Région, ifelse(grepl("mun", i), "Munic.", "MRC"))
    Distribution <- c(Distribution, mods[[compteur]][["all.hyper"]][["family"]][[1]][["label"]])
    iC <- c(iC, ifelse(grepl("iC", i), "Indic. tempo.", ifelse(grepl("npq", i), "ind_intervCOVID19", ifelse(any(grepl("iC", names(mods)))|any(grepl("npq", names(mods))),"Aucun", ""))))
    Gravité <- c(Gravité, 
                   ifelse(grepl("_M", i), "Mortel", 
                          ifelse(grepl("_GM", i), "Grave + Mortel",
                              ifelse(grepl("_GL", i), "Grave + Léger",   
                                   ifelse(grepl("_L", i), "Léger", 
                                          ifelse(grepl("_G", i), "Grave", ""))))))
    Exposition <- c(Exposition, ifelse(grepl("_djma", i), "DJMA", "VKT"))
    NQC <- c(NQC, ifelse(grepl("_NQC", i), "Exclus", "Inclus"))

    SS <- c(SS, ifelse(grepl("_sSS", i), "Sans_SS", ifelse(any(grepl("_sSS", names(mods))), "Avec_SS", "")))
    Modèle <- c(Modèle, ifelse(grepl("bym", i), "BYM", ifelse(grepl("bernar", i), "Bernardinelli", ifelse(grepl("KH", i),"KH", ""))))
    Interaction <- c(Interaction, ifelse(grepl("_interac", i), "Avec_Interac", ifelse(any(grepl("_interac", names(mods))),"Sans_Interac.", "")))
    UV <- c(UV, ifelse(grepl("ajUV", i), "nbAcc-nbAccUV", ifelse(grepl("UV", i), "nbAcc_UV", ifelse(any(grepl("UV", names(mods))),"nbAcc", ""))))
    unVeh <- c(unVeh, ifelse(grepl("aj1Veh", i), "nbAcc-nbAcc_1Veh", ifelse(grepl("1Veh", i), "nbAcc_1Veh", ifelse(any(grepl("1Veh", names(mods))),"nbAcc", ""))))
    Mois <- c(Mois, ifelse(grepl("mois", i), "Mois", ifelse(any(grepl("mois", names(mods))),"Année", "")))
    compteur=compteur+1
  }
  Distribution <- gsub("poisson", "Poisson", Distribution)
  Distribution <- gsub("nbinomial", "BN", Distribution)
  Distribution <- gsub("zeroinflatedPoisson1", "ZIP", Distribution)
  
  df_titre <- (data.frame(Modèle, Gravité, Région, Distribution, Exposition, NQC, iC, SS, UV, unVeh, Interaction, Mois))
  df_titre <- df_titre[-1,]
  df_titre <- df_titre[,!apply(df_titre, 2, function(col) all(col == ""))]
  ret <- cbind(df_titre, ret)
  
  exclude_cols <- c("Distribution", "DIC", "nom")
  group_by_cols <- setdiff(colnames(ret), exclude_cols)
  
  # df <- df %>% group_by(across(all_of(group_by_cols)))
  
  ret <- ret %>% group_by(across(all_of(group_by_cols))) %>%
    mutate(min = min(DIC)) %>%
    mutate(ind = ifelse(DIC==min, paste("*", Distribution, "*", sep=" "), "")) %>%
    select(-min)
  ret <- ret %>% select(-nom) %>% data.frame()
  colnames(ret)[dim(ret)[2]] <- "Meilleure distrib."
  if(bestFam==F){
    ret <- ret[,-dim(ret)[2]]
  }
  return(ret)
}
```




# Standardiser exposition
```{r}
# Rendre le facteur An en Année numérique
acc_PA_mun$Année <- as.numeric(as.character(acc_PA_mun$An))
acc_PA_mrc$Année <- as.numeric(as.character(acc_PA_mrc$An))
acc_PM_mrc$Année <- as.numeric(as.character(acc_PM_mrc$An))


# Par municipalité, par année
acc_PA_mun_M <- acc_PA_mun %>% 
  filter(gravite=="Mortel") %>%
  mutate(E_vkt=expected(population=vktPopu, cases=nbAcc, n.strata = 1), E_djma=expected(population=djmaPopu, cases=nbAcc, n.strata = 1))
acc_PA_mun_G <- acc_PA_mun %>% filter(gravite=="Grave") %>%
  mutate(E_vkt=expected(population=vktPopu, cases=nbAcc, n.strata = 1), E_djma=expected(population=djmaPopu, cases=nbAcc, n.strata = 1))
acc_PA_mun_L <- acc_PA_mun %>% filter(gravite=="Léger") %>%
  mutate(E_vkt=expected(population=vktPopu, cases=nbAcc, n.strata = 1), E_djma=expected(population=djmaPopu, cases=nbAcc, n.strata = 1))

# Par MRC, par année
acc_PA_mrc_M <- acc_PA_mrc %>% filter(gravite=="Mortel") %>%
  mutate(E_vkt=expected(population=vktPopu, cases=nbAcc, n.strata = 1), E_djma=expected(population=djmaPopu, cases=nbAcc, n.strata = 1))
acc_PA_mrc_G <- acc_PA_mrc %>% filter(gravite=="Grave") %>%
  mutate(E_vkt=expected(population=vktPopu, cases=nbAcc, n.strata = 1), E_djma=expected(population=djmaPopu, cases=nbAcc, n.strata = 1))
acc_PA_mrc_L <- acc_PA_mrc %>% filter(gravite=="Léger") %>%
  mutate(E_vkt=expected(population=vktPopu, cases=nbAcc, n.strata = 1), E_djma=expected(population=djmaPopu, cases=nbAcc, n.strata = 1))

# Par MRC, par mois
acc_PM_mrc_M <- acc_PM_mrc %>% filter(gravite=="Mortel") %>%
  mutate(E_vkt=expected(population=vktPopu, cases=nbAcc, n.strata = 1), E_djma=expected(population=djmaPopu, cases=nbAcc, n.strata = 1))
acc_PM_mrc_G <- acc_PM_mrc %>% filter(gravite=="Grave") %>%
  mutate(E_vkt=expected(population=vktPopu, cases=nbAcc, n.strata = 1), E_djma=expected(population=djmaPopu, cases=nbAcc, n.strata = 1))
acc_PM_mrc_L <- acc_PM_mrc %>% filter(gravite=="Léger") %>%
  mutate(E_vkt=expected(population=vktPopu, cases=nbAcc, n.strata = 1), E_djma=expected(population=djmaPopu, cases=nbAcc, n.strata = 1))

# Grave+Mortel (KSI) par MRC et par année
acc_PA_mrc_GM <- acc_PA_mrc_M
acc_PA_mrc_GM$nbAcc <- acc_PA_mrc_G %>% .$nbAcc + acc_PA_mrc_M %>% .$nbAcc
acc_PA_mrc_GM$nbConducteurs <- acc_PA_mrc_M$nbConducteurs + acc_PA_mrc_G$nbConducteurs
acc_PA_mrc_GM$VITESSE_AUTOR <- (acc_PA_mrc_M$VITESSE_AUTOR * acc_PA_mrc_M$nbConducteurs+acc_PA_mrc_G$VITESSE_AUTOR*acc_PA_mrc_G$nbConducteurs)/acc_PA_mrc_GM$nbConducteurs
acc_PA_mrc_GM$VITESSE_AUTOR <- ifelse(is.na(acc_PA_mrc_GM$VITESSE_AUTOR), 0, acc_PA_mrc_GM$VITESSE_AUTOR)
acc_PA_mrc_GM$ptsMoy <- (acc_PA_mrc_M$ptsMoy * acc_PA_mrc_M$ptsMoy + acc_PA_mrc_G$ptsMoy*acc_PA_mrc_G$nbConducteurs) / acc_PA_mrc_GM$nbConducteurs
acc_PA_mrc_GM$gravite <- "Mortel+Grave"
acc_PA_mrc_GM <- acc_PA_mrc_GM %>%
  mutate(E_vkt=expected(population=vktPopu, cases=nbAcc, n.strata = 1), E_djma=expected(population=djmaPopu, cases=nbAcc, n.strata = 1))

# Grave+Mortel (KSI) par MRC et par mois
acc_PM_mrc_GM <- acc_PM_mrc_M
acc_PM_mrc_GM$nbAcc <- acc_PM_mrc_G %>% .$nbAcc + acc_PM_mrc_M %>% .$nbAcc
acc_PM_mrc_GM$gravite <- "Mortel+Grave"
acc_PM_mrc_GM$nbConducteurs <- acc_PM_mrc_M$nbConducteurs + acc_PM_mrc_G$nbConducteurs
acc_PM_mrc_GM$VITESSE_AUTOR <- (acc_PM_mrc_M$VITESSE_AUTOR * acc_PM_mrc_M$nbConducteurs+acc_PM_mrc_G$VITESSE_AUTOR*acc_PM_mrc_G$nbConducteurs)/acc_PM_mrc_GM$nbConducteurs
acc_PM_mrc_GM$VITESSE_AUTOR <- ifelse(is.na(acc_PM_mrc_GM$VITESSE_AUTOR), 0, acc_PM_mrc_GM$VITESSE_AUTOR)
acc_PM_mrc_GM$ptsMoy <- (acc_PM_mrc_M$ptsMoy * acc_PM_mrc_M$ptsMoy + acc_PM_mrc_G$ptsMoy*acc_PM_mrc_G$nbConducteurs) / acc_PM_mrc_GM$nbConducteurs
acc_PM_mrc_GM <- acc_PM_mrc_GM %>%
  mutate(E_vkt=expected(population=vktPopu, cases=nbAcc, n.strata = 1), E_djma=expected(population=djmaPopu, cases=nbAcc, n.strata = 1))

# Grave+Mortel (KSI) par municipalité et par année
acc_PA_mun_GM <- acc_PA_mun_M 
acc_PA_mun_GM$nbAcc <- acc_PA_mun_G %>% .$nbAcc + acc_PA_mun_M %>% .$nbAcc
acc_PA_mun_GM$gravite <- "Mortel+Grave"
acc_PA_mun_GM$nbConducteurs <- acc_PA_mun_M$nbConducteurs + acc_PA_mun_G$nbConducteurs
acc_PA_mun_GM$VITESSE_AUTOR <- (acc_PA_mun_M$VITESSE_AUTOR * acc_PA_mun_M$nbConducteurs+acc_PA_mun_G$VITESSE_AUTOR*acc_PA_mun_G$nbConducteurs)/acc_PA_mun_GM$nbConducteurs
acc_PA_mun_GM$VITESSE_AUTOR <- ifelse(is.na(acc_PA_mun_GM$VITESSE_AUTOR), 0, acc_PA_mun_GM$VITESSE_AUTOR)
acc_PA_mun_GM$ptsMoy <- (acc_PA_mun_M$ptsMoy * acc_PA_mun_M$ptsMoy + acc_PA_mun_G$ptsMoy*acc_PA_mun_G$nbConducteurs) / acc_PA_mun_GM$nbConducteurs
acc_PA_mun_GM <- acc_PA_mun_GM %>%
  mutate(E_vkt=expected(population=vktPopu, cases=nbAcc, n.strata = 1), E_djma=expected(population=djmaPopu, cases=nbAcc, n.strata = 1))

# Grave+Léger (blessés) par municipalité et par année
acc_PA_mun_GL <- acc_PA_mun_G 
acc_PA_mun_GL$nbAcc <- acc_PA_mun_G %>% .$nbAcc + acc_PA_mun_L %>% .$nbAcc
acc_PA_mun_GL$gravite <- "Grave+Léger"
acc_PA_mun_GL$nbConducteurs <- acc_PA_mun_L$nbConducteurs + acc_PA_mun_G$nbConducteurs
acc_PA_mun_GL$VITESSE_AUTOR <- (acc_PA_mun_L$VITESSE_AUTOR * acc_PA_mun_L$nbConducteurs+acc_PA_mun_G$VITESSE_AUTOR*acc_PA_mun_G$nbConducteurs)/acc_PA_mun_GL$nbConducteurs
acc_PA_mun_GL$VITESSE_AUTOR <- ifelse(is.na(acc_PA_mun_GL$VITESSE_AUTOR), 0, acc_PA_mun_GL$VITESSE_AUTOR)
acc_PA_mun_GL$ptsMoy <- (acc_PA_mun_L$ptsMoy * acc_PA_mun_L$ptsMoy + acc_PA_mun_G$ptsMoy*acc_PA_mun_G$nbConducteurs) / acc_PA_mun_GL$nbConducteurs
acc_PA_mun_GL <- acc_PA_mun_GL %>%
  mutate(E_vkt=expected(population=vktPopu, cases=nbAcc, n.strata = 1),
         E_djma=expected(population=djmaPopu, cases=nbAcc, n.strata = 1))

# Grave+Léger (blessés) par MRC et par année
acc_PA_mrc_GL <- acc_PA_mrc_G 
acc_PA_mrc_GL$nbAcc <- acc_PA_mrc_G %>% .$nbAcc + acc_PA_mrc_L %>% .$nbAcc
acc_PA_mrc_GL$gravite <- "Grave+Léger"
acc_PA_mrc_GL$nbConducteurs <- acc_PA_mrc_L$nbConducteurs + acc_PA_mrc_G$nbConducteurs
acc_PA_mrc_GL$VITESSE_AUTOR <- (acc_PA_mrc_L$VITESSE_AUTOR * acc_PA_mrc_L$nbConducteurs+acc_PA_mrc_G$VITESSE_AUTOR*acc_PA_mrc_G$nbConducteurs)/acc_PA_mrc_GL$nbConducteurs
acc_PA_mrc_GL$VITESSE_AUTOR <- ifelse(is.na(acc_PA_mrc_GL$VITESSE_AUTOR), 0, acc_PA_mrc_GL$VITESSE_AUTOR)
acc_PA_mrc_GL$ptsMoy <- (acc_PA_mrc_L$ptsMoy * acc_PA_mrc_L$ptsMoy + acc_PA_mrc_G$ptsMoy*acc_PA_mrc_G$nbConducteurs) / acc_PA_mrc_GL$nbConducteurs
acc_PA_mrc_GL <- acc_PA_mrc_GL %>%
  mutate(E_vkt=expected(population=vktPopu, cases=nbAcc, n.strata = 1),
         E_djma=expected(population=djmaPopu, cases=nbAcc, n.strata = 1))




e_vkt_df_M <- acc_PA_mun_M %>% group_by(gravite, Année) %>%
  summarise(E_vkt=sum(E_vkt))
e_vkt_df_G <- acc_PA_mun_G %>% group_by(gravite, Année) %>%
  summarise(E_vkt=sum(E_vkt))
e_vkt_df_L <- acc_PA_mun_L %>% group_by(gravite, Année) %>%
  summarise(E_vkt=sum(E_vkt))
e_vkt_df_GM <- acc_PA_mun_GM %>% group_by(gravite, Année) %>%
  summarise(E_vkt=sum(E_vkt))

e_vkt_df <- rbind(e_vkt_df_L, e_vkt_df_G, e_vkt_df_M, e_vkt_df_GM)

e_vkt_df$gravite <- factor(e_vkt_df$gravite, levels = c("Léger", "Grave", "Mortel", "Mortel+Grave" ))


nbAcc_df_M <- acc_PA_mun_M %>% group_by(gravite, Année) %>%
  summarise(nbAcc=sum(nbAcc))
nbAcc_df_G <- acc_PA_mun_G %>% group_by(gravite, Année) %>%
  summarise(nbAcc=sum(nbAcc))
nbAcc_df_L <- acc_PA_mun_L %>% group_by(gravite, Année) %>%
  summarise(nbAcc=sum(nbAcc))
nbAcc_df_GM <- acc_PA_mun_GM %>% group_by(gravite, Année) %>%
  summarise(nbAcc=sum(nbAcc))
nbAcc_df <- rbind(nbAcc_df_L, nbAcc_df_G, nbAcc_df_M, nbAcc_df_GM)
nbAcc_df$gravite <- factor(nbAcc_df$gravite, levels = c("Léger", "Grave", "Mortel", "Mortel+Grave"))

# fig: nbAcc_reelAttendus_gravAnnee ####
ggplot() +
  geom_line(data=e_vkt_df, mapping=aes(x = Année, y = E_vkt, color = "Nombre d'accidents attendus"), lwd=1) +  # Line color
  geom_point(data=e_vkt_df, mapping=aes(x = Année, y = E_vkt, color = "Nombre d'accidents attendus"), size=2) +   # Add points on the line
  geom_line(data=nbAcc_df, mapping=aes(x = Année, y = nbAcc, color = "Nombre d'accidents"), lwd=1) +  # Line color
  geom_point(data=nbAcc_df, mapping=aes(x = Année, y = nbAcc, color = "Nombre d'accidents"), size=2) +  
  facet_wrap(~gravite, scales = "free_y", ncol=1) +
  labs(#title = "Nombre d'accidents, réels et attendus, selon la gravité et par année", 
       x = "Année", 
       y = "Nombre d'accidents, réels et attendus",
       color = "Légende") +
  theme_minimal() +  # Apply a minimal theme 
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    strip.text = element_text(face = "bold")
  )


# Verif
  acc_PA_mun_M$E_vkt[1]
  acc_PA_mun_M$vktPopu[1]/sum(acc_PA_mun_M$vktPopu) * sum(acc_PA_mun_M$nbAcc)
  # sum(acc_PA_mun_M$E_vkt)
  # summary(acc_PA_mun_M$E_vkt)
  # sum(acc_PA_mun_M$nbAcc)
  # summary(acc_PA_mun_M$nbAcc)
  # cor(acc_PA_mun_M$nbAcc, acc_PA_mun_M$E_vkt)


# Verif
  # sum(acc_PM_mrc_M$E_vkt)
  # sum(acc_PA_mrc_M$E_vkt)
  # 
  # acc_PA_mrc_M %>% select(An, CD_MRC, E_vkt) %>% arrange(An, CD_MRC)
  # acc_PM_mrc_M %>% group_by(An, CD_MRC) %>% summarise(sum(E_vkt))

# Création jdD G&M
  # Verif
  identical(acc_PA_mrc_G %>% select(-gravite, -nbAcc, -VITESSE_AUTOR, -ptsTot, -ptsMoy, -nbConducteurs, -E_vkt, -E_djma), acc_PA_mrc_M %>% select(-gravite, -nbAcc, -VITESSE_AUTOR, -ptsTot, -ptsMoy, -nbConducteurs, -E_vkt, -E_djma))
  
  identical(acc_PA_mun_G %>% select(-gravite, -nbAcc, -VITESSE_AUTOR, -ptsTot, -ptsMoy, -nbConducteurs, -E_vkt, -E_djma), acc_PA_mun_M %>% select(-gravite, -nbAcc, -VITESSE_AUTOR, -ptsTot, -ptsMoy, -nbConducteurs, -E_vkt, -E_djma))

 # acc_PA_mrc_G %>% arrange(CD_MRC) %>% .$nbAcc + acc_PA_mrc_M %>% arrange(CD_MRC) %>% .$nbAcc

# sum(acc_PA_mrc_GM$E_vkt)
# sum(acc_PA_mrc_GM$nbAcc)

# Compléter prétraitement pour BYM
mun <- as.integer(factor(acc_PA_mun_M$CD_MUN))
mrc <- as.integer(factor(acc_PA_mrc_M$CD_MRC))
mrc_PM <- as.integer(factor(acc_PM_mrc_M$CD_MRC))

W_mun <- as(lw_mun_b, "CsparseMatrix")
W_mrc <- as(lw_mrc_b, "CsparseMatrix")

```

# Moran - normalisées (SIR)
pas inclus dans le mémoire
```{r}
nb_mun_maj
nb_mrc_maj

lw_mun_w <- nb2listw(nb_mun_maj, style = "W", zero.policy = T)
lw_mrc_w <- nb2listw(nb_mrc_maj, style = "W", zero.policy = T)

library(spdep)

eps=0.01
gmoran_mun_pre <- moran.test(acc_PA_mun_M %>% filter(ind_covid=="Pre-Covid") %>% group_by(CD_MUN) %>% summarise(nbAcc=sum(nbAcc), nbAccVKT=sum(E_vkt)) %>% mutate(SIR=ifelse(nbAcc==0, eps/nbAccVKT, nbAcc/nbAccVKT)) %>% mutate(logSIR=log(SIR)) %>% .$logSIR, lw_mun_w,
                     alternative = "two.sided")

gmoran_mun_post <- moran.test(acc_PA_mun_M %>% filter(ind_covid=="Post-Covid") %>% group_by(CD_MUN) %>% summarise(nbAcc=sum(nbAcc), nbAccVKT=sum(E_vkt)) %>% mutate(SIR=ifelse(nbAcc==0, eps/nbAccVKT, nbAcc/nbAccVKT)) %>% mutate(logSIR=log(SIR)) %>% .$logSIR, lw_mun_w,
                     alternative = "two.sided")


gmoran_mrc_pre <- moran.test(acc_PA_mrc_M %>% filter(ind_covid=="Pre-Covid") %>% group_by(CD_MRC) %>% summarise(nbAcc=sum(nbAcc), nbAccVKT=sum(E_vkt)) %>% mutate(SIR=ifelse(nbAcc==0, eps/nbAccVKT, nbAcc/nbAccVKT)) %>% mutate(logSIR=log(SIR)) %>% .$logSIR, lw_mrc_w,
                     alternative = "two.sided")
gmoran_mrc_post <- moran.test(acc_PA_mrc_M %>% filter(ind_covid=="Post-Covid") %>% group_by(CD_MRC) %>% summarise(nbAcc=sum(nbAcc), nbAccVKT=sum(E_vkt)) %>% mutate(SIR=ifelse(nbAcc==0, eps/nbAccVKT, nbAcc/nbAccVKT)) %>% mutate(logSIR=log(SIR)) %>% .$logSIR, lw_mrc_w,
                     alternative = "two.sided")


gmoran_mun <- moran.test(acc_PA_mun_M %>% group_by(CD_MUN) %>% summarise(nbAcc=sum(nbAcc), nbAccVKT=sum(E_vkt)) %>% mutate(SIR=ifelse(nbAcc==0, eps/nbAccVKT, nbAcc/nbAccVKT)) %>% mutate(logSIR=log(SIR)) %>% .$logSIR, lw_mun_w,
                     alternative = "two.sided")
gmoran_mrc <- moran.test(acc_PA_mrc_M %>% group_by(CD_MRC) %>% summarise(nbAcc=sum(nbAcc), nbAccVKT=sum(E_vkt)) %>% mutate(SIR=ifelse(nbAcc==0, eps/nbAccVKT, nbAcc/nbAccVKT)) %>% mutate(logSIR=log(SIR)) %>% .$logSIR, lw_mrc_w,
                     alternative = "two.sided")

gmoran_mun_G <- moran.test(acc_PA_mun_G %>% group_by(CD_MUN) %>% summarise(nbAcc=sum(nbAcc), nbAccVKT=sum(E_vkt)) %>% mutate(SIR=ifelse(nbAcc==0, eps/nbAccVKT, nbAcc/nbAccVKT)) %>% mutate(logSIR=log(SIR)) %>% .$logSIR, lw_mun_w,
                     alternative = "two.sided")
gmoran_mrc_G <- moran.test(acc_PA_mrc_G %>% group_by(CD_MRC) %>% summarise(nbAcc=sum(nbAcc), nbAccVKT=sum(E_vkt)) %>% mutate(SIR=ifelse(nbAcc==0, eps/nbAccVKT, nbAcc/nbAccVKT)) %>% mutate(logSIR=log(SIR)) %>% .$logSIR, lw_mrc_w,
                     alternative = "two.sided")
gmoran_mun_L <- moran.test(acc_PA_mun_L %>% group_by(CD_MUN) %>% summarise(nbAcc=sum(nbAcc), nbAccVKT=sum(E_vkt)) %>% mutate(SIR=ifelse(nbAcc==0, eps/nbAccVKT, nbAcc/nbAccVKT)) %>% mutate(logSIR=log(SIR)) %>% .$logSIR, lw_mun_w,
                     alternative = "two.sided")
gmoran_mrc_L <- moran.test(acc_PA_mrc_L %>% group_by(CD_MRC) %>% summarise(nbAcc=sum(nbAcc), nbAccVKT=sum(E_vkt)) %>% mutate(SIR=ifelse(nbAcc==0, eps/nbAccVKT, nbAcc/nbAccVKT)) %>% mutate(logSIR=log(SIR)) %>% .$logSIR, lw_mrc_w,
                     alternative = "two.sided")




moran_i <- t(data.frame(gmoran_mun_L$estimate,
            gmoran_mrc_L$estimate, 
            gmoran_mun_G$estimate, 
            gmoran_mrc_G$estimate,
            gmoran_mun$estimate, 
            gmoran_mrc$estimate, 
            NA, 
            gmoran_mun_pre$estimate, 
            gmoran_mun_post$estimate,
            gmoran_mrc_pre$estimate,
            gmoran_mrc_post$estimate))

pval_i <- c(gmoran_mun_L$p.value,
            gmoran_mrc_L$p.value, 
            gmoran_mun_G$p.value, 
            gmoran_mrc_G$p.value,
            gmoran_mun$p.value, 
            gmoran_mrc$p.value, 
            NA, 
            gmoran_mun_pre$p.value, 
            gmoran_mun_post$p.value,
            gmoran_mrc_pre$p.value,
            gmoran_mrc_post$p.value)
#, gmoran_mun_pre_greater$p.value, gmoran_mun_post_greater$p.value, gmoran_mrc_pre_greater$p.value, gmoran_mrc_post_greater$p.value)

df <- data.frame(matrix(pval_i, ncol=1))
df$descr <- c("Accidents légers annuels des municipalités 2014-2022",
              "Accidents légers annuels des MRC 2014-2022",
              "Accidents graves annuels des municipalités 2014-2022",
              "Accidents graves annuels des MRC 2014-2022", 
              "Accidents mortels annuels des municipalités 2014-2022", 
              "Accidents mortels annuels des MRC 2014-2022",
              NA,
              "Accidents mortels annuels des municipalités pré-Covid", 
              "Accidents mortels annuels des municipalités post-Covid",
              "Accidents mortels annuels des MRC pre-Covid",
              "Accidents mortels annuels des MRC post-Covid")

colnames(df) <- c("Valeur-p", " ") #, "H0: Aucune autocorrélation spatiale positive")

stargazer(df %>% select(" ", `Valeur-p`), type="text", summary=F, rownames=F)

# Indice I local
pva <- function(pv) cbind("Aucun" = pv, 
    "FDR" = p.adjust(pv, "fdr"), "BY" = p.adjust(pv, "BY"),
    "Bonferroni" = p.adjust(pv, "bonferroni"))
f <- function(x) sum(x < 0.05, na.rm = T)
ajust.locM_g <- function(lmoran){
  lmoran |> 
      subset(select = "Pr(z > E(Ii))", drop = TRUE) |> 
      pva() -> pvsp
  apply(pvsp, 2, f)
}
ajust.locM <- function(lmoran){
  lmoran |> 
      subset(select = "Pr(z != E(Ii))", drop = TRUE) |> 
      pva() -> pvsp
  apply(pvsp, 2, f)
}

load(file.path(pathTraitees, "muncp_cc_cov.Rda"))
load(file.path(pathTraitees, "mrc_cc_cov.Rda"))
library(viridis)
library(ggpubr)

map_mun_pre <- muncp_cc_cov
map_mun_pre$nbAcc <- acc_PA_mun_M %>% filter(ind_covid=="Pre-Covid") %>% group_by(CD_MUN) %>% summarise(nbAcc=sum(nbAcc), nbAccVKT=sum(E_vkt)) %>% mutate(SIR=ifelse(nbAcc==0, eps/nbAccVKT, nbAcc/nbAccVKT)) %>% mutate(logSIR=log(SIR)) %>% .$logSIR
lmoran_mun_pre <- localmoran(map_mun_pre$nbAcc, lw_mun_w)

map_mrc_pre <- mrc_cc_cov
map_mrc_pre$nbAcc <- acc_PA_mrc_M %>% filter(ind_covid=="Pre-Covid") %>% group_by(CD_MRC) %>% summarise(nbAcc=sum(nbAcc), nbAccVKT=sum(E_vkt)) %>% mutate(SIR=ifelse(nbAcc==0, eps/nbAccVKT, nbAcc/nbAccVKT)) %>% mutate(logSIR=log(SIR)) %>% .$logSIR
lmoran_mrc_pre <- localmoran(map_mrc_pre$nbAcc, lw_mrc_w)

map_mun_post <- muncp_cc_cov
map_mun_post$nbAcc <- acc_PA_mun_M %>% filter(ind_covid=="Post-Covid") %>% group_by(CD_MUN) %>% summarise(nbAcc=sum(nbAcc), nbAccVKT=sum(E_vkt)) %>% mutate(SIR=ifelse(nbAcc==0, eps/nbAccVKT, nbAcc/nbAccVKT)) %>% mutate(logSIR=log(SIR)) %>% .$logSIR
lmoran_mun_post <- localmoran(map_mun_post$nbAcc, lw_mun_w)

map_mrc_post <- mrc_cc_cov
map_mrc_post$nbAcc <- acc_PA_mrc_M %>% filter(ind_covid=="Post-Covid") %>% group_by(CD_MRC) %>% summarise(nbAcc=sum(nbAcc), nbAccVKT=sum(E_vkt)) %>% mutate(SIR=ifelse(nbAcc==0, eps/nbAccVKT, nbAcc/nbAccVKT)) %>% mutate(logSIR=log(SIR)) %>% .$logSIR
lmoran_mrc_post <- localmoran(map_mrc_post$nbAcc, lw_mrc_w)

map_mun_M <- muncp_cc_cov
map_mun_M$nbAcc <- acc_PA_mun_M %>% filter(gravite=="Mortel") %>% group_by(CD_MUN) %>% summarise(nbAcc=sum(nbAcc), nbAccVKT=sum(E_vkt)) %>% mutate(SIR=ifelse(nbAcc==0, eps/nbAccVKT, nbAcc/nbAccVKT)) %>% mutate(logSIR=log(SIR)) %>% .$logSIR
lmoran_mun_M <- localmoran(map_mun_pre$nbAcc, lw_mun_w)
map_mrc_M <- mrc_cc_cov
map_mrc_M$nbAcc <- acc_PA_mrc_M %>% filter(gravite=="Mortel") %>% group_by(CD_MRC) %>% summarise(nbAcc=sum(nbAcc), nbAccVKT=sum(E_vkt)) %>% mutate(SIR=ifelse(nbAcc==0, eps/nbAccVKT, nbAcc/nbAccVKT)) %>% mutate(logSIR=log(SIR)) %>% .$logSIR
lmoran_mrc_M <- localmoran(map_mrc_M$nbAcc, lw_mrc_w)

map_mun_G <- muncp_cc_cov
map_mun_G$nbAcc <- acc_PA_mun_G %>% filter(gravite=="Grave") %>% group_by(CD_MUN) %>% summarise(nbAcc=sum(nbAcc), nbAccVKT=sum(E_vkt)) %>% mutate(SIR=ifelse(nbAcc==0, eps/nbAccVKT, nbAcc/nbAccVKT)) %>% mutate(logSIR=log(SIR)) %>% .$logSIR
lmoran_mun_G <- localmoran(map_mun_pre$nbAcc, lw_mun_w)
map_mrc_G <- mrc_cc_cov
map_mrc_G$nbAcc <- acc_PA_mrc_G %>% filter(gravite=="Grave") %>% group_by(CD_MRC) %>% summarise(nbAcc=sum(nbAcc), nbAccVKT=sum(E_vkt)) %>% mutate(SIR=ifelse(nbAcc==0, eps/nbAccVKT, nbAcc/nbAccVKT)) %>% mutate(logSIR=log(SIR)) %>% .$logSIR
lmoran_mrc_G <- localmoran(map_mrc_G$nbAcc, lw_mrc_w)

map_mun_L <- muncp_cc_cov
map_mun_L$nbAcc <- acc_PA_mun_L %>% filter(gravite=="Léger") %>% group_by(CD_MUN) %>% summarise(nbAcc=sum(nbAcc), nbAccVKT=sum(E_vkt)) %>% mutate(SIR=ifelse(nbAcc==0, eps/nbAccVKT, nbAcc/nbAccVKT)) %>% mutate(logSIR=log(SIR)) %>% .$logSIR
lmoran_mun_L <- localmoran(map_mun_pre$nbAcc, lw_mun_w)
map_mrc_L <- mrc_cc_cov
map_mrc_L$nbAcc <- acc_PA_mrc_L %>% filter(gravite=="Léger") %>% group_by(CD_MRC) %>% summarise(nbAcc=sum(nbAcc), nbAccVKT=sum(E_vkt)) %>% mutate(SIR=ifelse(nbAcc==0, eps/nbAccVKT, nbAcc/nbAccVKT)) %>% mutate(logSIR=log(SIR)) %>% .$logSIR
lmoran_mrc_L <- localmoran(map_mrc_L$nbAcc, lw_mrc_w)


# acc_PA_mun_M %>% group_by(CD_MUN) %>% summarise(nbAcc=sum(nbAcc), nbAccVKT=sum(E_vkt)) %>% mutate(logSIR=nbAcc/nbAccVKT) %>%
  # arrange(desc(SIR)) %>% data.frame()

diagM_mun_M <- moran.plot(map_mun_M$nbAcc, lw_mun_w, xlab = "I round turnout", 
               ylab = "lagged turnout", main="Standardisé par rangée")
diagM_mrc_M <- moran.plot(map_mrc_M$nbAcc, lw_mrc_w, xlab = "I round turnout", 
               ylab = "lagged turnout", main="Standardisé par rangée")

table(diagM_mun_M$is_inf)
table(diagM_mrc_M$is_inf)

p_diagMunM <- ggplot(diagM_mun_M) +
  geom_point(aes(x=x, y=wx)) + 
  geom_hline(yintercept = mean(diagM_mun_M$wx),linetype = 2) +
  geom_vline(xintercept = mean(diagM_mun_M$x),linetype = 2) +
  geom_abline(intercept= lm(wx~x, diagM_mun_M)$coefficients[1], slope= lm(wx~x, diagM_mun_M)$coefficients[2]) +
  geom_point(data= diagM_mun_M[diagM_mun_M$is_inf==T,], mapping=aes(x=x, y=wx), colour="red", size=2) + 
  labs(x = "ln(SIR) d'accidents mortels par municipalités", y = "Moyenne lissée spatialement") +
  ggtitle("Diagramme de Moran du nombre d'accidents \nmortels par municipalités") +
  theme(plot.title = element_text(hjust = 0.5, face="bold"))

p_diagMrcM <- ggplot(diagM_mrc_M) +
  geom_point(aes(x=x, y=wx)) + 
  geom_hline(yintercept = mean(diagM_mrc_M$wx),linetype = 2) +
  geom_vline(xintercept = mean(diagM_mrc_M$x),linetype = 2) +
  geom_abline(intercept= lm(wx~x, diagM_mrc_M)$coefficients[1], slope= lm(wx~x, diagM_mrc_M)$coefficients[2]) +
  geom_point(data= diagM_mrc_M[diagM_mrc_M$is_inf==T,], mapping=aes(x=x, y=wx), colour="red", size=2) + 
  labs(x = "ln(SIR) d'accidents mortels par MRC", y = "Moyenne lissée spatialement") +
  ggtitle("Diagramme de Moran du nombre d'accidents \nmortels par MRC") +
  theme(plot.title = element_text(hjust = 0.5, face="bold"))
  
map_mun_M$is_inf <- diagM_mun_M$is_inf
map_mrc_M$is_inf <- diagM_mrc_M$is_inf
inf_mun <- ggplot(map_mun_M) +
  geom_sf(aes(fill=is_inf)) +
  scale_fill_viridis("magma",discrete=TRUE) +
  ggtitle("Valeurs extrêmes (points rouges) \npar municipalité sur une carte") +
  guides(fill=guide_legend(title="Valeurs extrêmes")) +
  theme(plot.title = element_text(hjust = 0.5, face="bold")) +
  xlim(-80, -68) + ylim(45, 49) +
  theme(legend.position = "none")
inf_mrc <- ggplot(map_mrc_M) +
  geom_sf(aes(fill=is_inf)) +
  scale_fill_viridis("magma",discrete=TRUE) +
  ggtitle("Valeurs extrêmes (points rouges) \npar MRC sur une carte") +
  guides(fill=guide_legend(title="Valeurs extrêmes")) +
  theme(plot.title = element_text(hjust = 0.5, face="bold")) +
  # xlim(-76, -70) + ylim(45, 47.5) +
  xlim(-80, -68) + ylim(45, 49) +
  theme(legend.position = "none")

ggarrange(p_diagMunM, inf_mun, p_diagMrcM, inf_mrc)

```

```{r}
ajust.locM(lmoran_mun_M)
ajust.locM(lmoran_mun_G)
ajust.locM(lmoran_mun_L)

ajust.locM(lmoran_mrc_M); ajust.locM(lmoran_mrc_pre); ajust.locM(lmoran_mrc_post)

ajust.locM(lmoran_mrc_G)
ajust.locM(lmoran_mrc_L)

df <- t(data.frame(mun_M=ajust.locM(lmoran_mun_M), mun_G=ajust.locM(lmoran_mun_G), mun_L=ajust.locM(lmoran_mun_L), mrc_M=ajust.locM(lmoran_mrc_M), mrc_G=ajust.locM(lmoran_mrc_G), mrc_L=ajust.locM(lmoran_mrc_L)))
rownames(df) <- c("Accidents mortels annuels des municipalités 2014-2022",
              "Accidents graves annuels des municipalités 2014-2022",
              "Accidents légers annuels des municipalités 2014-2022",
              "Accidents mortels annuels des MRC 2014-2022", 
              "Accidents graves annuels des MRC 2014-2022", 
              "Accidents légers annuels des MRC 2014-2022")

stargazer(df, type="text", summary=F)

# verif
  sum(map_mun_pre$nbAcc) + sum(map_mun_post$nbAcc) 
  sum(map_mrc_pre$nbAcc) + sum(map_mrc_post$nbAcc) 

library(tmap)
tmap_mode("view")

map_mun_pre %>% head
map_mun_pre$lmZ <- lmoran_mun_pre[, "Z.Ii"] # z-scores
map_mrc_pre$lmZ <- lmoran_mrc_pre[, "Z.Ii"] # z-scores
map_mun_post$lmZ <- lmoran_mun_post[, "Z.Ii"] # z-scores
map_mrc_post$lmZ <- lmoran_mrc_post[, "Z.Ii"] # z-scores
map_mun_post$lmZ <- lmoran_mun_post[, "Z.Ii"] # z-scores
map_mrc_post$lmZ <- lmoran_mrc_post[, "Z.Ii"] # z-scores
map_mun_M$lmZ <- lmoran_mun_M[, "Z.Ii"] # z-scores
map_mrc_M$lmZ <- lmoran_mrc_M[, "Z.Ii"] # z-scores


p_mun_pre <- tm_shape(map_mun_pre) + 
  tm_polygons(col = "lmZ",
    title = "Municipalité - PréCovid", style = "fixed",
    breaks = c(-Inf, -1.96, 1.96, Inf),
    labels = c("ACS négative", "Aucune ACS", "ACS positive "),
    palette =  c("blue", "white", "red"),
    id="MUS_NM_MUN") +
  tm_layout(legend.outside = TRUE) 

p_mrc_pre <- tm_shape(map_mrc_pre) + 
  tm_polygons(col = "lmZ",
    title = "MRC - PréCovid", 
    style = "fixed",
    breaks = c(-Inf, -1.96, 1.96, Inf),
    labels = c("ACS négative", "Aucune ACS", "ACS positive"),
    palette =  c("blue", "white", "red"),
    id="MRS_NM_MRC") +
  tm_layout(legend.outside = TRUE) 

p_mun_post <- tm_shape(map_mun_post) + 
  tm_polygons(col = "lmZ",
    title = "Municipalité - PostCovid", style = "fixed",
    breaks = c(-Inf, -1.96, 1.96, Inf),
    labels = c("ACS négative", "Aucune ACS", "ACS positive "),
    palette =  c("blue", "white", "red"),
    id="MUS_NM_MUN") +
  tm_layout(legend.outside = TRUE) 

p_mrc_post <- tm_shape(map_mrc_post) + 
  tm_polygons(col = "lmZ",
    title = "Municipalité - PréCovid", 
    style = "fixed",
    breaks = c(-Inf, -1.96, 1.96, Inf),
    labels = c("ACS négative", "Aucune ACS", "ACS positive"),
    palette =  c("blue", "white", "red"),
    id="MRS_NM_MRC") +
  tm_layout(legend.outside = TRUE) #+
  # tm_view(view.legend.position = c("left", "top"))

p_mun <- tm_shape(map_mun_M) + 
  tm_polygons(col = "lmZ",
    title = "Municipalité", style = "fixed",
    breaks = c(-Inf, -1.96, 1.96, Inf),
    labels = c("ACS négative", "Aucune ACS", "ACS positive "),
    palette =  c("blue", "white", "red"),
    id="MUS_NM_MUN") +
  tm_layout(legend.outside = TRUE) 

p_mrc <- tm_shape(map_mrc_M) + 
  tm_polygons(col = "lmZ",
    title = "MRC", 
    style = "fixed",
    breaks = c(-Inf, -1.96, 1.96, Inf),
    labels = c("ACS négative", "Aucune ACS", "ACS positive"),
    palette =  c("blue", "white", "red"),
    id="MRS_NM_MRC") +
  tm_layout(legend.outside = TRUE)

tmap_arrange(p_mun_pre, p_mun_post, p_mrc_pre, p_mrc_post, sync=T, ncol=2)
tmap_arrange(p_mun, p_mrc, sync=T)
```

# Retirer NQC
```{r}
load(file.path(pathTraitees, "qc_muncp_NQC.Rda"))
load(file.path(pathTraitees, "qc_mrc_NQC.Rda"))

# Verif
  # sum(acc_PA_mrc$vktPopu)
  # sum(acc_PM_mrc$vktPopu)/12

# Voisinages
load(file.path(pathTraitees, "nb_mun_NQC.Rda"))
load(file.path(pathTraitees, "nb_mrc_NQC.Rda"))

# Construction des listes de voisinage contenant les poids
lw_mun_b_NQC <- nb2listw(nb_mun_maj_NQC, style = "B", zero.policy = T)
lw_mrc_b_NQC <- nb2listw(nb_mrc_maj_NQC, style = "B", zero.policy = T)

acc_PA_mun_NQC <- acc_PA_mun %>% filter(CD_RA != 10) %>%
  filter(!CD_MUN %in% c(97914, 97912, 97806, 97808, 97040))
acc_PA_mrc_NQC <- acc_PA_mrc %>% filter(CD_RA != 10)
acc_PM_mrc_NQC <- acc_PM_mrc %>% filter(CD_RA != 10)

acc_PA_mun_NQC_M <- acc_PA_mun_M %>% filter(CD_RA != 10) %>%
  filter(!CD_MUN %in% c(97914, 97912, 97806, 97808, 97040))
acc_PA_mun_NQC_G <- acc_PA_mun_G %>% filter(CD_RA != 10) %>%
  filter(!CD_MUN %in% c(97914, 97912, 97806, 97808, 97040))
acc_PA_mun_NQC_L <- acc_PA_mun_L %>% filter(CD_RA != 10) %>%
  filter(!CD_MUN %in% c(97914, 97912, 97806, 97808, 97040))
acc_PA_mun_NQC_GM <- acc_PA_mun_GM %>% filter(CD_RA != 10) %>%
  filter(!CD_MUN %in% c(97914, 97912, 97806, 97808, 97040))
acc_PA_mun_NQC_GL <- acc_PA_mun_GL %>% filter(CD_RA != 10) %>%
  filter(!CD_MUN %in% c(97914, 97912, 97806, 97808, 97040))
acc_PA_mrc_NQC_M <- acc_PA_mrc_M %>% filter(CD_RA != 10)
acc_PA_mrc_NQC_G <- acc_PA_mrc_G %>% filter(CD_RA != 10)
acc_PA_mrc_NQC_L <- acc_PA_mrc_L %>% filter(CD_RA != 10)
acc_PA_mrc_NQC_GM <- acc_PA_mrc_GM %>% filter(CD_RA != 10)
acc_PA_mrc_NQC_GL <- acc_PA_mrc_GL %>% filter(CD_RA != 10)
acc_PM_mrc_NQC_M <- acc_PM_mrc_M %>% filter(CD_RA != 10)
acc_PM_mrc_NQC_G <- acc_PM_mrc_G %>% filter(CD_RA != 10)
acc_PM_mrc_NQC_L <- acc_PM_mrc_L %>% filter(CD_RA != 10)
acc_PM_mrc_NQC_GM <- acc_PM_mrc_GM %>% filter(CD_RA != 10)

mun_NQC <- as.integer(factor(acc_PA_mun_NQC_M$CD_MUN))
mrc_NQC <- as.integer(factor(acc_PA_mrc_NQC_M$CD_MRC))
mrc_PM_NQC <- as.integer(factor(acc_PM_mrc_NQC_M$CD_MRC))

W_mun_NQC <- as(lw_mun_b_NQC, "CsparseMatrix")
W_mrc_NQC <- as(lw_mrc_b_NQC, "CsparseMatrix")
```

# Standardiser exposition sans NQC
```{r}
# Rendre le facteur An en Année numérique
acc_PA_mun_NQC$Année <- as.numeric(as.character(acc_PA_mun_NQC$An))
acc_PA_mrc_NQC$Année <- as.numeric(as.character(acc_PA_mrc_NQC$An))
acc_PM_mrc_NQC$Année <- as.numeric(as.character(acc_PM_mrc_NQC$An))


# Par municipalité, par année
acc_PA_mun_NQC_M <- acc_PA_mun_NQC %>% 
  filter(gravite=="Mortel") %>%
  mutate(E_vkt=expected(population=vktPopu, cases=nbAcc, n.strata = 1), E_djma=expected(population=djmaPopu, cases=nbAcc, n.strata = 1))
acc_PA_mun_NQC_G <- acc_PA_mun_NQC %>% filter(gravite=="Grave") %>%
  mutate(E_vkt=expected(population=vktPopu, cases=nbAcc, n.strata = 1), E_djma=expected(population=djmaPopu, cases=nbAcc, n.strata = 1))
acc_PA_mun_NQC_L <- acc_PA_mun_NQC %>% filter(gravite=="Léger") %>%
  mutate(E_vkt=expected(population=vktPopu, cases=nbAcc, n.strata = 1), E_djma=expected(population=djmaPopu, cases=nbAcc, n.strata = 1))

# Par MRC, par année
acc_PA_mrc_NQC_M <- acc_PA_mrc_NQC %>% filter(gravite=="Mortel") %>%
  mutate(E_vkt=expected(population=vktPopu, cases=nbAcc, n.strata = 1), E_djma=expected(population=djmaPopu, cases=nbAcc, n.strata = 1))
acc_PA_mrc_NQC_G <- acc_PA_mrc_NQC %>% filter(gravite=="Grave") %>%
  mutate(E_vkt=expected(population=vktPopu, cases=nbAcc, n.strata = 1), E_djma=expected(population=djmaPopu, cases=nbAcc, n.strata = 1))
acc_PA_mrc_NQC_L <- acc_PA_mrc_NQC %>% filter(gravite=="Léger") %>%
  mutate(E_vkt=expected(population=vktPopu, cases=nbAcc, n.strata = 1), E_djma=expected(population=djmaPopu, cases=nbAcc, n.strata = 1))

# Par MRC, par mois
acc_PM_mrc_NQC_M <- acc_PM_mrc_NQC %>% filter(gravite=="Mortel") %>%
  mutate(E_vkt=expected(population=vktPopu, cases=nbAcc, n.strata = 1), E_djma=expected(population=djmaPopu, cases=nbAcc, n.strata = 1))
acc_PM_mrc_NQC_G <- acc_PM_mrc_NQC %>% filter(gravite=="Grave") %>%
  mutate(E_vkt=expected(population=vktPopu, cases=nbAcc, n.strata = 1), E_djma=expected(population=djmaPopu, cases=nbAcc, n.strata = 1))
acc_PM_mrc_NQC_L <- acc_PM_mrc_NQC %>% filter(gravite=="Léger") %>%
  mutate(E_vkt=expected(population=vktPopu, cases=nbAcc, n.strata = 1), E_djma=expected(population=djmaPopu, cases=nbAcc, n.strata = 1))

# Grave+Mortel (KSI) par MRC et par année
acc_PA_mrc_NQC_GM <- acc_PA_mrc_NQC_M
acc_PA_mrc_NQC_GM$nbAcc <- acc_PA_mrc_NQC_G %>% .$nbAcc + acc_PA_mrc_NQC_M %>% .$nbAcc
acc_PA_mrc_NQC_GM$nbConducteurs <- acc_PA_mrc_NQC_M$nbConducteurs + acc_PA_mrc_NQC_G$nbConducteurs
acc_PA_mrc_NQC_GM$VITESSE_AUTOR <- (acc_PA_mrc_NQC_M$VITESSE_AUTOR * acc_PA_mrc_NQC_M$nbConducteurs+acc_PA_mrc_NQC_G$VITESSE_AUTOR*acc_PA_mrc_NQC_G$nbConducteurs)/acc_PA_mrc_NQC_GM$nbConducteurs
acc_PA_mrc_NQC_GM$VITESSE_AUTOR <- ifelse(is.na(acc_PA_mrc_NQC_GM$VITESSE_AUTOR), 0, acc_PA_mrc_NQC_GM$VITESSE_AUTOR)
acc_PA_mrc_NQC_GM$ptsMoy <- (acc_PA_mrc_NQC_M$ptsMoy * acc_PA_mrc_NQC_M$ptsMoy + acc_PA_mrc_NQC_G$ptsMoy*acc_PA_mrc_NQC_G$nbConducteurs) / acc_PA_mrc_NQC_GM$nbConducteurs
acc_PA_mrc_NQC_GM$gravite <- "Mortel+Grave"
acc_PA_mrc_NQC_GM <- acc_PA_mrc_NQC_GM %>%
  mutate(E_vkt=expected(population=vktPopu, cases=nbAcc, n.strata = 1), E_djma=expected(population=djmaPopu, cases=nbAcc, n.strata = 1))

# Grave+Mortel (KSI) par MRC et par mois
acc_PM_mrc_NQC_GM <- acc_PM_mrc_NQC_M
acc_PM_mrc_NQC_GM$nbAcc <- acc_PM_mrc_NQC_G %>% .$nbAcc + acc_PM_mrc_NQC_M %>% .$nbAcc
acc_PM_mrc_NQC_GM$gravite <- "Mortel+Grave"
acc_PM_mrc_NQC_GM$nbConducteurs <- acc_PM_mrc_NQC_M$nbConducteurs + acc_PM_mrc_NQC_G$nbConducteurs
acc_PM_mrc_NQC_GM$VITESSE_AUTOR <- (acc_PM_mrc_NQC_M$VITESSE_AUTOR * acc_PM_mrc_NQC_M$nbConducteurs+acc_PM_mrc_NQC_G$VITESSE_AUTOR*acc_PM_mrc_NQC_G$nbConducteurs)/acc_PM_mrc_NQC_GM$nbConducteurs
acc_PM_mrc_NQC_GM$VITESSE_AUTOR <- ifelse(is.na(acc_PM_mrc_NQC_GM$VITESSE_AUTOR), 0, acc_PM_mrc_NQC_GM$VITESSE_AUTOR)
acc_PM_mrc_NQC_GM$ptsMoy <- (acc_PM_mrc_NQC_M$ptsMoy * acc_PM_mrc_NQC_M$ptsMoy + acc_PM_mrc_NQC_G$ptsMoy*acc_PM_mrc_NQC_G$nbConducteurs) / acc_PM_mrc_NQC_GM$nbConducteurs
acc_PM_mrc_NQC_GM <- acc_PM_mrc_NQC_GM %>%
  mutate(E_vkt=expected(population=vktPopu, cases=nbAcc, n.strata = 1), E_djma=expected(population=djmaPopu, cases=nbAcc, n.strata = 1))

# Grave+Mortel (KSI) par municipalité et par année
acc_PA_mun_NQC_GM <- acc_PA_mun_NQC_M 
acc_PA_mun_NQC_GM$nbAcc <- acc_PA_mun_NQC_G %>% .$nbAcc + acc_PA_mun_NQC_M %>% .$nbAcc
acc_PA_mun_NQC_GM$gravite <- "Mortel+Grave"
acc_PA_mun_NQC_GM$nbConducteurs <- acc_PA_mun_NQC_M$nbConducteurs + acc_PA_mun_NQC_G$nbConducteurs
acc_PA_mun_NQC_GM$VITESSE_AUTOR <- (acc_PA_mun_NQC_M$VITESSE_AUTOR * acc_PA_mun_NQC_M$nbConducteurs+acc_PA_mun_NQC_G$VITESSE_AUTOR*acc_PA_mun_NQC_G$nbConducteurs)/acc_PA_mun_NQC_GM$nbConducteurs
acc_PA_mun_NQC_GM$VITESSE_AUTOR <- ifelse(is.na(acc_PA_mun_NQC_GM$VITESSE_AUTOR), 0, acc_PA_mun_NQC_GM$VITESSE_AUTOR)
acc_PA_mun_NQC_GM$ptsMoy <- (acc_PA_mun_NQC_M$ptsMoy * acc_PA_mun_NQC_M$ptsMoy + acc_PA_mun_NQC_G$ptsMoy*acc_PA_mun_NQC_G$nbConducteurs) / acc_PA_mun_NQC_GM$nbConducteurs
acc_PA_mun_NQC_GM <- acc_PA_mun_NQC_GM %>%
  mutate(E_vkt=expected(population=vktPopu, cases=nbAcc, n.strata = 1), E_djma=expected(population=djmaPopu, cases=nbAcc, n.strata = 1))

# Grave+Léger (blessés) par municipalité et par année
acc_PA_mun_NQC_GL <- acc_PA_mun_NQC_G 
acc_PA_mun_NQC_GL$nbAcc <- acc_PA_mun_NQC_G %>% .$nbAcc + acc_PA_mun_NQC_L %>% .$nbAcc
acc_PA_mun_NQC_GL$gravite <- "Grave+Léger"
acc_PA_mun_NQC_GL$nbConducteurs <- acc_PA_mun_NQC_L$nbConducteurs + acc_PA_mun_NQC_G$nbConducteurs
acc_PA_mun_NQC_GL$VITESSE_AUTOR <- (acc_PA_mun_NQC_L$VITESSE_AUTOR * acc_PA_mun_NQC_L$nbConducteurs+acc_PA_mun_NQC_G$VITESSE_AUTOR*acc_PA_mun_NQC_G$nbConducteurs)/acc_PA_mun_NQC_GL$nbConducteurs
acc_PA_mun_NQC_GL$VITESSE_AUTOR <- ifelse(is.na(acc_PA_mun_NQC_GL$VITESSE_AUTOR), 0, acc_PA_mun_NQC_GL$VITESSE_AUTOR)
acc_PA_mun_NQC_GL$ptsMoy <- (acc_PA_mun_NQC_L$ptsMoy * acc_PA_mun_NQC_L$ptsMoy + acc_PA_mun_NQC_G$ptsMoy*acc_PA_mun_NQC_G$nbConducteurs) / acc_PA_mun_NQC_GL$nbConducteurs
acc_PA_mun_NQC_GL <- acc_PA_mun_NQC_GL %>%
  mutate(E_vkt=expected(population=vktPopu, cases=nbAcc, n.strata = 1),
         E_djma=expected(population=djmaPopu, cases=nbAcc, n.strata = 1))

# Grave+Léger (blessés) par MRC et par année
acc_PA_mrc_NQC_GL <- acc_PA_mrc_NQC_G 
acc_PA_mrc_NQC_GL$nbAcc <- acc_PA_mrc_NQC_G %>% .$nbAcc + acc_PA_mrc_NQC_L %>% .$nbAcc
acc_PA_mrc_NQC_GL$gravite <- "Grave+Léger"
acc_PA_mrc_NQC_GL$nbConducteurs <- acc_PA_mrc_NQC_L$nbConducteurs + acc_PA_mrc_NQC_G$nbConducteurs
acc_PA_mrc_NQC_GL$VITESSE_AUTOR <- (acc_PA_mrc_NQC_L$VITESSE_AUTOR * acc_PA_mrc_NQC_L$nbConducteurs+acc_PA_mrc_NQC_G$VITESSE_AUTOR*acc_PA_mrc_NQC_G$nbConducteurs)/acc_PA_mrc_NQC_GL$nbConducteurs
acc_PA_mrc_NQC_GL$VITESSE_AUTOR <- ifelse(is.na(acc_PA_mrc_NQC_GL$VITESSE_AUTOR), 0, acc_PA_mrc_NQC_GL$VITESSE_AUTOR)
acc_PA_mrc_NQC_GL$ptsMoy <- (acc_PA_mrc_NQC_L$ptsMoy * acc_PA_mrc_NQC_L$ptsMoy + acc_PA_mrc_NQC_G$ptsMoy*acc_PA_mrc_NQC_G$nbConducteurs) / acc_PA_mrc_NQC_GL$nbConducteurs
acc_PA_mrc_NQC_GL <- acc_PA_mrc_NQC_GL %>%
  mutate(E_vkt=expected(population=vktPopu, cases=nbAcc, n.strata = 1),
         E_djma=expected(population=djmaPopu, cases=nbAcc, n.strata = 1))
```

# changer noms des covariables
```{r}
nouvNom <- readxl::read_excel(file.path(pathBrutes, "misc", "variables presentations.xlsx"))[1:15,]
# rename_vector <- nouvNom %>%
#   select(Variables, anciensNom) %>% # Select relevant columns
#   deframe() # Convert to a named vector
rename_vector <- setNames(nouvNom$Variables, nouvNom$anciensNom)
rename_vector <- setNames(names(rename_vector), rename_vector)

acc_PA_mun_M <- acc_PA_mun_M %>% dplyr::rename(rename_vector)
acc_PA_mun_G <- acc_PA_mun_G %>% dplyr::rename(rename_vector)
acc_PA_mun_L <- acc_PA_mun_L %>% dplyr::rename(rename_vector)
acc_PA_mun_GM <- acc_PA_mun_GM %>% dplyr::rename(rename_vector)
acc_PA_mun_GL <- acc_PA_mun_GL %>% dplyr::rename(rename_vector)
acc_PA_mrc_M <- acc_PA_mrc_M %>% dplyr::rename(rename_vector)
acc_PA_mrc_G <- acc_PA_mrc_G %>% dplyr::rename(rename_vector)
acc_PA_mrc_L <- acc_PA_mrc_L %>% dplyr::rename(rename_vector)
acc_PA_mrc_GM <- acc_PA_mrc_GM %>% dplyr::rename(rename_vector)
acc_PA_mrc_GL <- acc_PA_mrc_GL %>% dplyr::rename(rename_vector)
acc_PM_mrc_M <- acc_PM_mrc_M %>% dplyr::rename(rename_vector)
acc_PM_mrc_G <- acc_PM_mrc_G %>% dplyr::rename(rename_vector)
acc_PM_mrc_L <- acc_PM_mrc_L %>% dplyr::rename(rename_vector)
acc_PM_mrc_GM <- acc_PM_mrc_GM %>% dplyr::rename(rename_vector)

acc_PA_mun_NQC_M <- acc_PA_mun_NQC_M %>% dplyr::rename(rename_vector)
acc_PA_mun_NQC_G <- acc_PA_mun_NQC_G %>% dplyr::rename(rename_vector)
acc_PA_mun_NQC_L <- acc_PA_mun_NQC_L %>% dplyr::rename(rename_vector)
acc_PA_mun_NQC_GM <- acc_PA_mun_NQC_GM %>% dplyr::rename(rename_vector)
acc_PA_mun_NQC_GL <- acc_PA_mun_NQC_GL %>% dplyr::rename(rename_vector)
acc_PA_mrc_NQC_M <- acc_PA_mrc_NQC_M %>% dplyr::rename(rename_vector)
acc_PA_mrc_NQC_G <- acc_PA_mrc_NQC_G %>% dplyr::rename(rename_vector)
acc_PA_mrc_NQC_L <- acc_PA_mrc_NQC_L %>% dplyr::rename(rename_vector)
acc_PA_mrc_NQC_GM <- acc_PA_mrc_NQC_GM %>% dplyr::rename(rename_vector)
acc_PA_mrc_NQC_GL <- acc_PA_mrc_NQC_GL %>% dplyr::rename(rename_vector)
acc_PM_mrc_NQC_M <- acc_PM_mrc_NQC_M %>% dplyr::rename(rename_vector)
acc_PM_mrc_NQC_G <- acc_PM_mrc_NQC_G %>% dplyr::rename(rename_vector)
acc_PM_mrc_NQC_L <- acc_PM_mrc_NQC_L %>% dplyr::rename(rename_vector)
acc_PM_mrc_NQC_GM <- acc_PM_mrc_NQC_GM %>% dplyr::rename(rename_vector)

# Verif
  # acc_PA_mun_M$nombreAccidents_VKT[1]
  # acc_PA_mun_M$vktPopu[1]/sum(acc_PA_mun_M$vktPopu) * sum(acc_PA_mun_M$nombreAccidents)
  # acc_PA_mun_NQC_M$nombreAccidents_VKT[1]
  # acc_PA_mun_NQC_M$vktPopu[1]/sum(acc_PA_mun_NQC_M$vktPopu) * sum(acc_PA_mun_NQC_M$nombreAccidents)
  # sum(acc_PA_mrc_GM$nombreAccidents_VKT)
  # sum(acc_PA_mrc_GM$nombreAccidents)
  # sum(acc_PA_mrc_NQC_GM$nombreAccidents_VKT)
  # sum(acc_PA_mrc_NQC_GM$nombreAccidents)

# Comparaison route du MTMD et OSM
# acc_PA_mun_M$motorway[955] +
#   acc_PA_mun_M$trunk[955]+
#   acc_PA_mun_M$primary[955]+
#   acc_PA_mun_M$secondary[955] 
# 
# acc_PA_mun_M$routeQc[955]
```

# Corrélation
```{r}
library(spatialreg)
library(SpatialEpi)
library(reshape)

df_mun <- acc_PA_mun_M %>% filter (An == 2022) %>%
  select(
         "Longueur motorway / Superficie / 100"=motorway_divAreaDiv100, 
         "Longueur trunk / Superficie / 100"=trunk_divAreaDiv100,
         "Longueur primary / Superficie / 100"=primary_divAreaDiv100,
         "Longueur secondary / Superficie / 100"=secondary_divAreaDiv100,  
         # "Longueur tertiary / Superficie / 100"=tertiary_divAreaDiv100, 
         # "Longueur  routes OSM sommées / Superficie / 100"=sommeRoute_divAreaDiv100,
         "Longueur routes MTMD / Superficie / 100"=denistéLinéaire_routesMTMD, 
         # "Nb. de feux de circul. / Superficie "=fC_divArea,
         # "Nb. de panneaux d'arrêt / Superficie "=stop_divArea,
         "Nb. feux circul. + 0.5*panneaux d'arrêt / Superficie "=fCStopPond_divArea,
         "Nombre d'hôpitaux / Superficie * 10"=hosp_divAreaTimes10,
         "Densité de population / 100"=pp_dnst_div100, 
         pourcentage_moins5Ans, 
         pourcentage_femmes,
         pourcentage_jeunes, 
         pourcentage_65AnsEtPlus, 
         pourcentage_baccalaureatOuPlus, 
         pourcentage_secondaireOuMoins,
         pourcentage_chomeurs,
         pourcentage_beneficiPrestC19,
         revenuMedian, 
         ptsMoyens,
         vitesseAutorisee,
         nombreAccidents_DJMA, 
         nombreAccidents_VKT, 
         nombreAccidents)


df_mun <- acc_PA_mun_M %>% filter (An == 2022) %>%
  select(
         "Longueur motorway / Superficie / 100"=motorway_divAreaDiv100, 
         "Longueur trunk / Superficie / 100"=trunk_divAreaDiv100,
         "Longueur primary / Superficie / 100"=primary_divAreaDiv100,
         "Longueur secondary / Superficie / 100"=secondary_divAreaDiv100,  
         "Longueur tertiary / Superficie / 100"=tertiary_divAreaDiv100,
         "Longueur  routes OSM sommées / Superficie / 100"=sommeRoute_divAreaDiv100,
         "Longueur routes MTMD / Superficie / 100"=denistéLinéaire_routesMTMD, 
         "Nb. de feux de circul. / Superficie "=fC_divArea,
         "Nb. de panneaux d'arrêt / Superficie "=stop_divArea,
         "Nb. feux circul. + 0.5*panneaux d'arrêt / Superficie "=fCStopPond_divArea,
         "Nombre d'hôpitaux / Superficie * 10"=hosp_divAreaTimes10,
         "Densité de population / 100"=pp_dnst_div100, 
         pourcentage_moins5Ans, 
         pourcentage_femmes,
         pourcentage_jeunes, 
         pourcentage_65AnsEtPlus, 
         pourcentage_baccalaureatOuPlus, 
         pourcentage_secondaireOuMoins,
         pourcentage_chomeurs,
         pourcentage_beneficiPrestC19,
         revenuMedian, 
         ptsMoyens,
         vitesseAutorisee,
         nombreAccidents_DJMA, 
         nombreAccidents_VKT, 
         nombreAccidents)

cor_matrix <- cor(df_mun)
cor_upper <- cor_matrix
cor_upper[lower.tri(cor_upper, diag = TRUE)] <- NA
high_cor_pairs <- which(abs(cor_upper) > 0.8, arr.ind = TRUE)
result_mun <- data.frame(
  var1 = rownames(cor_matrix)[high_cor_pairs[, 1]],
  var2 = colnames(cor_matrix)[high_cor_pairs[, 2]],
  correlation = cor_matrix[high_cor_pairs]
)
stargazer(result_mun, type="text", summary=F)


# Melt the matrix into long format
cor_melt <- melt(cor_matrix)

# Plot the heatmap
cor_mun <- ggplot(cor_melt, aes(x = X1, y = X2, fill = value)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", midpoint = 0,
                       limit = c(-1, 1), space = "Lab", name = "Corrélation") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
  coord_fixed() +
  labs(x = NULL, y = NULL, title="Municipalité") +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold")
  ) 


df_mrc <- acc_PA_mrc_M %>% filter (An == 2022) %>%
  select(#"Longueur motorway / Superficie / 100"=motorway_divAreaDiv100, 
         # "Longueur trunk / Superficie / 100"=trunk_divAreaDiv100,
         # "Longueur primary / Superficie / 100"=primary_divAreaDiv100,
         #"Longueur secondary / Superficie / 100"=secondary_divAreaDiv100,  
         #"Longueur tertiary / Superficie / 100"=tertiary_divAreaDiv100, 
         # "Longueur  routes OSM sommées / Superficie / 100"=sommeRoute_divAreaDiv100, 
         "Longueur routes MTMD / Superficie / 100"=denistéLinéaire_routesMTMD, 
         # "Nb. de feux de circul. / Superficie "=fC_divArea, 
         # "Nb. de panneaux d'arrêt / Superficie "=stop_divArea, 
         "Nb. feux circul. + 0.5*panneaux d'arrêt / Superficie "=fCStopPond_divArea,
         # "Nombre d'hôpitaux / Superficie * 10"=hosp_divAreaTimes10,
         "Densité de population / 100"=pp_dnst_div100,
         pourcentage_moins5Ans, 
         pourcentage_femmes,
         pourcentage_jeunes, 
         # pourcentage_65AnsEtPlus, 
         pourcentage_baccalaureatOuPlus, 
         pourcentage_secondaireOuMoins,
         pourcentage_chomeurs,
         pourcentage_beneficiPrestC19,
         revenuMedian, 
         ptsMoyens,
         vitesseAutorisee,
         nombreAccidents_DJMA, 
         nombreAccidents_VKT, 
         nombreAccidents)


df_mrc <- acc_PA_mrc_M %>% filter (An == 2022) %>%
  select("Longueur motorway / Superficie / 100"=motorway_divAreaDiv100,
         "Longueur trunk / Superficie / 100"=trunk_divAreaDiv100,
         "Longueur primary / Superficie / 100"=primary_divAreaDiv100,
         "Longueur secondary / Superficie / 100"=secondary_divAreaDiv100,
         "Longueur tertiary / Superficie / 100"=tertiary_divAreaDiv100,
         "Longueur  routes OSM sommées / Superficie / 100"=sommeRoute_divAreaDiv100,
         "Longueur routes MTMD / Superficie / 100"=denistéLinéaire_routesMTMD, 
         "Nb. de feux de circul. / Superficie "=fC_divArea,
         "Nb. de panneaux d'arrêt / Superficie "=stop_divArea,
         "Nb. feux circul. + 0.5*panneaux d'arrêt / Superficie "=fCStopPond_divArea,
         "Nombre d'hôpitaux / Superficie * 10"=hosp_divAreaTimes10,
         "Densité de population / 100"=pp_dnst_div100,
         pourcentage_moins5Ans, 
         pourcentage_femmes,
         pourcentage_jeunes, 
         pourcentage_65AnsEtPlus,
         pourcentage_baccalaureatOuPlus, 
         pourcentage_secondaireOuMoins,
         pourcentage_chomeurs,
         pourcentage_beneficiPrestC19,
         revenuMedian, 
         ptsMoyens,
         vitesseAutorisee,
         nombreAccidents_DJMA, 
         nombreAccidents_VKT, 
         nombreAccidents)

cor_matrix <- cor(df_mrc)
cor_upper <- cor_matrix
cor_upper[lower.tri(cor_upper, diag = TRUE)] <- NA
high_cor_pairs <- which(abs(cor_upper) > 0.7, arr.ind = TRUE)
result_mrc <- data.frame(
  var1 = rownames(cor_matrix)[high_cor_pairs[, 1]],
  var2 = colnames(cor_matrix)[high_cor_pairs[, 2]],
  correlation = cor_matrix[high_cor_pairs]
)
result_mrc

# Melt the matrix into long format
cor_melt <- melt(cor_matrix)

# Plot the heatmap
cor_mrc <- ggplot(cor_melt, aes(x = X1, y = X2, fill = value)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", midpoint = 0,
                       limit = c(-1, 1), space = "Lab", name = "Corrélation") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
  coord_fixed() +
  labs(x = NULL, y = NULL, title="MRC") +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold")
  ) 



# fig correlation ####
ggarrange(cor_mun, cor_mrc, ncol=1)
cor_mun
cor_mrc
```


# Modèle de base

## Formule

```{r}
form <- formula(nombreAccidents ~ 
                  denistéLinéaire_routesMTMD +
                  pourcentage_moins5Ans +
                  pourcentage_femmes +
                  pourcentage_jeunes +
                  pourcentage_baccalaureatOuPlus +
                  pourcentage_secondaireOuMoins +
                  pourcentage_chomeurs +
                  revenuMedian +
                  ptsMoyens +
                  vitesseAutorisee)
  

```

# Modèles de base

Toutes les observations (nb régions \* années sont inclus)

Pour Grave/Mortel et municipalités/MRC

## Base

```{r}
# Poisson vs NB vs ZIP
## Mortel
bymPoi_mun_M <- inla(update(form, . ~ . + f(mun, model = "bym", graph = W_mun, scale.model=TRUE)),
                family = "poisson",
                E = `nombreAccidents_VKT`,
                data = acc_PA_mun_M,
                control.compute = list(dic = TRUE))
summary(bymPoi_mun_M)
bymNB_mun_M <- inla(update(form, . ~ . + f(mun, model = "bym", graph = W_mun, scale.model=TRUE)),
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mun_M,
                control.compute = list(dic = TRUE))
bymZIP_mun_M <- inla(update(form, . ~ . + f(mun, model = "bym", graph = W_mun, scale.model=TRUE)),
                family = "zeroinflatedpoisson1",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mun_M,
                control.compute = list(dic = TRUE))

## Grave
bymPoi_mun_G <- inla(update(form, . ~ . + f(mun, model = "bym", graph = W_mun, scale.model=TRUE)),
                family = "poisson",
                E = `nombreAccidents_VKT`,
                data = acc_PA_mun_G,
                control.compute = list(dic = TRUE))
bymNB_mun_G <- inla(update(form, . ~ . + f(mun, model = "bym", graph = W_mun, scale.model=TRUE)),
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mun_G,
                control.compute = list(dic = TRUE))
bymZIP_mun_G <- inla(update(form, . ~ . + f(mun, model = "bym", graph = W_mun, scale.model=TRUE)),
                family = "zeroinflatedpoisson1",
                E = `nombreAccidents_VKT`,
                data = acc_PA_mun_G,
                control.compute = list(dic = TRUE))

## Léger
bymPoi_mun_L <- inla(update(form, . ~ . + f(mun, model = "bym", graph = W_mun, scale.model=TRUE)),
                family = "poisson",
                E = `nombreAccidents_VKT`,
                data = acc_PA_mun_L,
                control.compute = list(dic = TRUE))
bymNB_mun_L <- inla(update(form, . ~ . + f(mun, model = "bym", graph = W_mun, scale.model=TRUE)),
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mun_L,
                control.compute = list(dic = TRUE))
bymZIP_mun_L <- inla(update(form, . ~ . + f(mun, model = "bym", graph = W_mun, scale.model=TRUE)),
                family = "zeroinflatedpoisson1",
                E = `nombreAccidents_VKT`,
                data = acc_PA_mun_L,
                control.compute = list(dic = TRUE))

## Grave + Mortel
bymPoi_mun_GM <- inla(update(form, . ~ . + f(mun, model = "bym", graph = W_mun, scale.model=TRUE)),
                family = "poisson",
                E = `nombreAccidents_VKT`,
                data = acc_PA_mun_GM,
                control.compute = list(dic = TRUE))
bymNB_mun_GM <- inla(update(form, . ~ . + f(mun, model = "bym", graph = W_mun, scale.model=TRUE)),
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mun_GM,
                control.compute = list(dic = TRUE))
bymZIP_mun_GM <- inla(update(form, . ~ . + f(mun, model = "bym", graph = W_mun, scale.model=TRUE)),
                family = "zeroinflatedpoisson1",
                E = `nombreAccidents_VKT`,
                data = acc_PA_mun_GM,
                control.compute = list(dic = TRUE))

# MRC
## Mortel
bymPoi_mrc_M <- inla(update(form, . ~ . + f(mrc, model = "bym", graph = W_mrc, scale.model=TRUE)),
                family = "poisson",
                E = `nombreAccidents_VKT`,
                data = acc_PA_mrc_M,
                control.compute = list(dic = TRUE))
bymNB_mrc_M <- inla(update(form, . ~ . + f(mrc, model = "bym", graph = W_mrc, scale.model=TRUE)),
                family = "nbinomial",
                E = `nombreAccidents_VKT`,
                data = acc_PA_mrc_M,
                control.compute = list(dic = TRUE))
# bymNB_mrc_M <- inla(update(form, . ~ . ),
#                 family = "nbinomial",
#                 E = `nombreAccidents_VKT`,
#                 data = acc_PA_mrc_M,
#                 control.compute = list(dic = TRUE))
bymZIP_mrc_M <- inla(update(form, . ~ . + f(mrc, model = "bym", graph = W_mrc, scale.model=TRUE)),
                family = "zeroinflatedpoisson1",
                E = `nombreAccidents_VKT`,
                data = acc_PA_mrc_M,
                control.compute = list(dic = TRUE))

## Grave
bymPoi_mrc_G <- inla(update(form, . ~ . + f(mrc, model = "bym", graph = W_mrc, scale.model=TRUE)),
                family = "poisson",
                E = `nombreAccidents_VKT`,
                data = acc_PA_mrc_G,
                control.compute = list(dic = TRUE))
bymNB_mrc_G <- inla(update(form, . ~ . + f(mrc, model = "bym", graph = W_mrc, scale.model=TRUE)),
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mrc_G,
                control.compute = list(dic = TRUE))
bymZIP_mrc_G <- inla(update(form, . ~ . + f(mrc, model = "bym", graph = W_mrc, scale.model=TRUE)),
                family = "zeroinflatedpoisson1",
                E = `nombreAccidents_VKT`,
                data = acc_PA_mrc_G,
                control.compute = list(dic = TRUE))

## Léger
bymPoi_mrc_L <- inla(update(form, . ~ . + f(mrc, model = "bym", graph = W_mrc, scale.model=TRUE)),
                family = "poisson",
                E = `nombreAccidents_VKT`,
                data = acc_PA_mrc_L,
                control.compute = list(dic = TRUE))
bymNB_mrc_L <- inla(update(form, . ~ . + f(mrc, model = "bym", graph = W_mrc, scale.model=TRUE)),
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mrc_L,
                control.compute = list(dic = TRUE))
bymZIP_mrc_L <- inla(update(form, . ~ . + f(mrc, model = "bym", graph = W_mrc, scale.model=TRUE)),
                family = "zeroinflatedpoisson1",
                E = `nombreAccidents_VKT`,
                data = acc_PA_mrc_L,
                control.compute = list(dic = TRUE))

## Grave + Mortel
bymPoi_mrc_GM <- inla(update(form, . ~ . + f(mrc, model = "bym", graph = W_mrc, scale.model=TRUE)),
                family = "poisson",
                E = `nombreAccidents_VKT`,
                data = acc_PA_mrc_GM,
                control.compute = list(dic = TRUE))
bymNB_mrc_GM <- inla(update(form, . ~ . + f(mrc, model = "bym", graph = W_mrc, scale.model=TRUE)),
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mrc_GM,
                control.compute = list(dic = TRUE))
bymZIP_mrc_GM <- inla(update(form, . ~ . + f(mrc, model = "bym", graph = W_mrc, scale.model=TRUE)),
                family = "zeroinflatedpoisson1",
                E = `nombreAccidents_VKT`,
                data = acc_PA_mrc_GM,
                control.compute = list(dic = TRUE))

################# DJMA #################

# Poisson vs NB vs ZIP
## Mortel
bymPoi_mun_djma_M <- inla(update(form, . ~ . + f(mun, model = "bym", graph = W_mun, scale.model=TRUE)),
                family = "poisson",
                E = `nombreAccidents_DJMA`,
                data = acc_PA_mun_M,
                control.compute = list(dic = TRUE))
bymNB_mun_djma_M <- inla(update(form, . ~ . + f(mun, model = "bym", graph = W_mun, scale.model=TRUE)),
                family = "nbinomial",
                E=`nombreAccidents_DJMA`,
                data = acc_PA_mun_M,
                control.compute = list(dic = TRUE))
bymZIP_mun_djma_M <- inla(update(form, . ~ . + f(mun, model = "bym", graph = W_mun, scale.model=TRUE)),
                family = "zeroinflatedpoisson1",
                E=`nombreAccidents_DJMA`,
                data = acc_PA_mun_M,
                control.compute = list(dic = TRUE))

## Grave
bymPoi_mun_djma_G <- inla(update(form, . ~ . + f(mun, model = "bym", graph = W_mun, scale.model=TRUE)),
                family = "poisson",
                E = `nombreAccidents_DJMA`,
                data = acc_PA_mun_G,
                control.compute = list(dic = TRUE))
bymNB_mun_djma_G <- inla(update(form, . ~ . + f(mun, model = "bym", graph = W_mun, scale.model=TRUE)),
                family = "nbinomial",
                E=`nombreAccidents_DJMA`,
                data = acc_PA_mun_G,
                control.compute = list(dic = TRUE))
bymZIP_mun_djma_G <- inla(update(form, . ~ . + f(mun, model = "bym", graph = W_mun, scale.model=TRUE)),
                family = "zeroinflatedpoisson1",
                E = `nombreAccidents_DJMA`,
                data = acc_PA_mun_G,
                control.compute = list(dic = TRUE))

## Léger
bymPoi_mun_djma_L <- inla(update(form, . ~ . + f(mun, model = "bym", graph = W_mun, scale.model=TRUE)),
                family = "poisson",
                E = `nombreAccidents_DJMA`,
                data = acc_PA_mun_L,
                control.compute = list(dic = TRUE))
bymNB_mun_djma_L <- inla(update(form, . ~ . + f(mun, model = "bym", graph = W_mun, scale.model=TRUE)),
                family = "nbinomial",
                E=`nombreAccidents_DJMA`,
                data = acc_PA_mun_L,
                control.compute = list(dic = TRUE))
bymZIP_mun_djma_L <- inla(update(form, . ~ . + f(mun, model = "bym", graph = W_mun, scale.model=TRUE)),
                family = "zeroinflatedpoisson1",
                E = `nombreAccidents_DJMA`,
                data = acc_PA_mun_L,
                control.compute = list(dic = TRUE))

## Grave + Mortel
bymPoi_mun_djma_GM <- inla(update(form, . ~ . + f(mun, model = "bym", graph = W_mun, scale.model=TRUE)),
                family = "poisson",
                E = `nombreAccidents_DJMA`,
                data = acc_PA_mun_GM,
                control.compute = list(dic = TRUE))
bymNB_mun_djma_GM <- inla(update(form, . ~ . + f(mun, model = "bym", graph = W_mun, scale.model=TRUE)),
                family = "nbinomial",
                E=`nombreAccidents_DJMA`,
                data = acc_PA_mun_GM,
                control.compute = list(dic = TRUE))
bymZIP_mun_djma_GM <- inla(update(form, . ~ . + f(mun, model = "bym", graph = W_mun, scale.model=TRUE)),
                family = "zeroinflatedpoisson1",
                E = `nombreAccidents_DJMA`,
                data = acc_PA_mun_GM,
                control.compute = list(dic = TRUE))

# MRC
## Mortel
bymPoi_mrc_djma_M <- inla(update(form, . ~ . + f(mrc, model = "bym", graph = W_mrc, scale.model=TRUE)),
                family = "poisson",
                E = `nombreAccidents_DJMA`,
                data = acc_PA_mrc_M,
                control.compute = list(dic = TRUE))
bymNB_mrc_djma_M <- inla(update(form, . ~ . + f(mrc, model = "bym", graph = W_mrc, scale.model=TRUE)),
                family = "nbinomial",
                E = `nombreAccidents_DJMA`,
                data = acc_PA_mrc_M,
                control.compute = list(dic = TRUE))
# bymNB_mrc_M <- inla(update(form, . ~ . ),
#                 family = "nbinomial",
#                 E = `nombreAccidents_DJMA`,
#                 data = acc_PA_mrc_M,
#                 control.compute = list(dic = TRUE))
bymZIP_mrc_djma_M <- inla(update(form, . ~ . + f(mrc, model = "bym", graph = W_mrc, scale.model=TRUE)),
                family = "zeroinflatedpoisson1",
                E = `nombreAccidents_DJMA`,
                data = acc_PA_mrc_M,
                control.compute = list(dic = TRUE))

## Grave
bymPoi_mrc_djma_G <- inla(update(form, . ~ . + f(mrc, model = "bym", graph = W_mrc, scale.model=TRUE)),
                family = "poisson",
                E = `nombreAccidents_DJMA`,
                data = acc_PA_mrc_G,
                control.compute = list(dic = TRUE))
bymNB_mrc_djma_G <- inla(update(form, . ~ . + f(mrc, model = "bym", graph = W_mrc, scale.model=TRUE)),
                family = "nbinomial",
                E=`nombreAccidents_DJMA`,
                data = acc_PA_mrc_G,
                control.compute = list(dic = TRUE))
bymZIP_mrc_djma_G <- inla(update(form, . ~ . + f(mrc, model = "bym", graph = W_mrc, scale.model=TRUE)),
                family = "zeroinflatedpoisson1",
                E = `nombreAccidents_DJMA`,
                data = acc_PA_mrc_G,
                control.compute = list(dic = TRUE))

## Léger
bymPoi_mrc_djma_L <- inla(update(form, . ~ . + f(mrc, model = "bym", graph = W_mrc, scale.model=TRUE)),
                family = "poisson",
                E = `nombreAccidents_DJMA`,
                data = acc_PA_mrc_L,
                control.compute = list(dic = TRUE))
bymNB_mrc_djma_L <- inla(update(form, . ~ . + f(mrc, model = "bym", graph = W_mrc, scale.model=TRUE)),
                family = "nbinomial",
                E=`nombreAccidents_DJMA`,
                data = acc_PA_mrc_L,
                control.compute = list(dic = TRUE))
bymZIP_mrc_djma_L <- inla(update(form, . ~ . + f(mrc, model = "bym", graph = W_mrc, scale.model=TRUE)),
                family = "zeroinflatedpoisson1",
                E = `nombreAccidents_DJMA`,
                data = acc_PA_mrc_L,
                control.compute = list(dic = TRUE))

## Grave + Mortel
bymPoi_mrc_djma_GM <- inla(update(form, . ~ . + f(mrc, model = "bym", graph = W_mrc, scale.model=TRUE)),
                family = "poisson",
                E = `nombreAccidents_DJMA`,
                data = acc_PA_mrc_GM,
                control.compute = list(dic = TRUE))
bymNB_mrc_djma_GM <- inla(update(form, . ~ . + f(mrc, model = "bym", graph = W_mrc, scale.model=TRUE)),
                family = "nbinomial",
                E=`nombreAccidents_DJMA`,
                data = acc_PA_mrc_GM,
                control.compute = list(dic = TRUE))
bymZIP_mrc_djma_GM <- inla(update(form, . ~ . + f(mrc, model = "bym", graph = W_mrc, scale.model=TRUE)),
                family = "zeroinflatedpoisson1",
                E = `nombreAccidents_DJMA`,
                data = acc_PA_mrc_GM,
                control.compute = list(dic = TRUE))
```


## Sans NQC
```{r}
# Poisson vs NB vs ZIP
## Mortel
bymPoi_mun_NQC_M <- inla(update(form, . ~ . + f(mun_NQC, model = "bym", graph = W_mun_NQC, scale.model=TRUE)),
                family = "poisson",
                E = `nombreAccidents_VKT`,
                data = acc_PA_mun_NQC_M,
                control.compute = list(dic = TRUE))
summary(bymPoi_mun_NQC_M)

bymNB_mun_NQC_M <- inla(update(form, . ~ . + f(mun_NQC, model = "bym", graph = W_mun_NQC, scale.model=TRUE)),
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mun_NQC_M,
                control.compute = list(dic = TRUE))
summary(bymNB_mun_NQC_M)

bymZIP_mun_NQC_M <- inla(update(form, . ~ . + f(mun_NQC, model = "bym", graph = W_mun_NQC, scale.model=TRUE)),
                family = "zeroinflatedpoisson1",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mun_NQC_M,
                control.compute = list(dic = TRUE))

## Grave
bymPoi_mun_NQC_G <- inla(update(form, . ~ . + f(mun_NQC, model = "bym", graph = W_mun_NQC, scale.model=TRUE)),
                family = "poisson",
                E = `nombreAccidents_VKT`,
                data = acc_PA_mun_NQC_G,
                control.compute = list(dic = TRUE))
bymNB_mun_NQC_G <- inla(update(form, . ~ . + f(mun_NQC, model = "bym", graph = W_mun_NQC, scale.model=TRUE)),
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mun_NQC_G,
                control.compute = list(dic = TRUE))
bymZIP_mun_NQC_G <- inla(update(form, . ~ . + f(mun_NQC, model = "bym", graph = W_mun_NQC, scale.model=TRUE)),
                family = "zeroinflatedpoisson1",
                E = `nombreAccidents_VKT`,
                data = acc_PA_mun_NQC_G,
                control.compute = list(dic = TRUE))

## Léger
bymPoi_mun_NQC_L <- inla(update(form, . ~ . + f(mun_NQC, model = "bym", graph = W_mun_NQC, scale.model=TRUE)),
                family = "poisson",
                E = `nombreAccidents_VKT`,
                data = acc_PA_mun_NQC_L,
                control.compute = list(dic = TRUE))
bymNB_mun_NQC_L <- inla(update(form, . ~ . + f(mun_NQC, model = "bym", graph = W_mun_NQC, scale.model=TRUE)),
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mun_NQC_L,
                control.compute = list(dic = TRUE))
bymZIP_mun_NQC_L <- inla(update(form, . ~ . + f(mun_NQC, model = "bym", graph = W_mun_NQC, scale.model=TRUE)),
                family = "zeroinflatedpoisson1",
                E = `nombreAccidents_VKT`,
                data = acc_PA_mun_NQC_L,
                control.compute = list(dic = TRUE))

## Grave + Mortel
bymPoi_mun_NQC_GM <- inla(update(form, . ~ . + f(mun_NQC, model = "bym", graph = W_mun_NQC, scale.model=TRUE)),
                family = "poisson",
                E = `nombreAccidents_VKT`,
                data = acc_PA_mun_NQC_GM,
                control.compute = list(dic = TRUE))
bymNB_mun_NQC_GM <- inla(update(form, . ~ . + f(mun_NQC, model = "bym", graph = W_mun_NQC, scale.model=TRUE)),
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mun_NQC_GM,
                control.compute = list(dic = TRUE))
bymZIP_mun_NQC_GM <- inla(update(form, . ~ . + f(mun_NQC, model = "bym", graph = W_mun_NQC, scale.model=TRUE)),
                family = "zeroinflatedpoisson1",
                E = `nombreAccidents_VKT`,
                data = acc_PA_mun_NQC_GM,
                control.compute = list(dic = TRUE))

# MRC
## Mortel
bymPoi_mrc_NQC_M <- inla(update(form, . ~ . + f(mrc_NQC, model = "bym", graph = W_mrc_NQC, scale.model=TRUE)),
                family = "poisson",
                E = `nombreAccidents_VKT`,
                data = acc_PA_mrc_NQC_M,
                control.compute = list(dic = TRUE))
bymNB_mrc_NQC_M <- inla(update(form, . ~ . + f(mrc_NQC, model = "bym", graph = W_mrc_NQC, scale.model=TRUE)),
                family = "nbinomial",
                E = `nombreAccidents_VKT`,
                data = acc_PA_mrc_NQC_M,
                control.compute = list(dic = TRUE))
# bymNB_mrc_NQC_M <- inla(update(form, . ~ . ),
#                 family = "nbinomial",
#                 E = `nombreAccidents_VKT`,
#                 data = acc_PA_mrc_NQC_M,
#                 control.compute = list(dic = TRUE))
bymZIP_mrc_NQC_M <- inla(update(form, . ~ . + f(mrc_NQC, model = "bym", graph = W_mrc_NQC, scale.model=TRUE)),
                family = "zeroinflatedpoisson1",
                E = `nombreAccidents_VKT`,
                data = acc_PA_mrc_NQC_M,
                control.compute = list(dic = TRUE))

## Grave
bymPoi_mrc_NQC_G <- inla(update(form, . ~ . + f(mrc_NQC, model = "bym", graph = W_mrc_NQC, scale.model=TRUE)),
                family = "poisson",
                E = `nombreAccidents_VKT`,
                data = acc_PA_mrc_NQC_G,
                control.compute = list(dic = TRUE))
bymNB_mrc_NQC_G <- inla(update(form, . ~ . + f(mrc_NQC, model = "bym", graph = W_mrc_NQC, scale.model=TRUE)),
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mrc_NQC_G,
                control.compute = list(dic = TRUE))
bymZIP_mrc_NQC_G <- inla(update(form, . ~ . + f(mrc_NQC, model = "bym", graph = W_mrc_NQC, scale.model=TRUE)),
                family = "zeroinflatedpoisson1",
                E = `nombreAccidents_VKT`,
                data = acc_PA_mrc_NQC_G,
                control.compute = list(dic = TRUE))

## Léger
bymPoi_mrc_NQC_L <- inla(update(form, . ~ . + f(mrc_NQC, model = "bym", graph = W_mrc_NQC, scale.model=TRUE)),
                family = "poisson",
                E = `nombreAccidents_VKT`,
                data = acc_PA_mrc_NQC_L,
                control.compute = list(dic = TRUE))
bymNB_mrc_NQC_L <- inla(update(form, . ~ . + f(mrc_NQC, model = "bym", graph = W_mrc_NQC, scale.model=TRUE)),
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mrc_NQC_L,
                control.compute = list(dic = TRUE))
bymZIP_mrc_NQC_L <- inla(update(form, . ~ . + f(mrc_NQC, model = "bym", graph = W_mrc_NQC, scale.model=TRUE)),
                family = "zeroinflatedpoisson1",
                E = `nombreAccidents_VKT`,
                data = acc_PA_mrc_NQC_L,
                control.compute = list(dic = TRUE))

## Grave + Mortel
bymPoi_mrc_NQC_GM <- inla(update(form, . ~ . + f(mrc_NQC, model = "bym", graph = W_mrc_NQC, scale.model=TRUE)),
                family = "poisson",
                E = `nombreAccidents_VKT`,
                data = acc_PA_mrc_NQC_GM,
                control.compute = list(dic = TRUE))
bymNB_mrc_NQC_GM <- inla(update(form, . ~ . + f(mrc_NQC, model = "bym", graph = W_mrc_NQC, scale.model=TRUE)),
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mrc_NQC_GM,
                control.compute = list(dic = TRUE))
bymZIP_mrc_NQC_GM <- inla(update(form, . ~ . + f(mrc_NQC, model = "bym", graph = W_mrc_NQC, scale.model=TRUE)),
                family = "zeroinflatedpoisson1",
                E = `nombreAccidents_VKT`,
                data = acc_PA_mrc_NQC_GM,
                control.compute = list(dic = TRUE))

################# DJMA #################

# Poisson vs NB vs ZIP
## Mortel
bymPoi_mun_NQC_djma_M <- inla(update(form, . ~ . + f(mun_NQC, model = "bym", graph = W_mun_NQC, scale.model=TRUE)),
                family = "poisson",
                E = `nombreAccidents_DJMA`,
                data = acc_PA_mun_NQC_M,
                control.compute = list(dic = TRUE))
bymNB_mun_NQC_djma_M <- inla(update(form, . ~ . + f(mun_NQC, model = "bym", graph = W_mun_NQC, scale.model=TRUE)),
                family = "nbinomial",
                E=`nombreAccidents_DJMA`,
                data = acc_PA_mun_NQC_M,
                control.compute = list(dic = TRUE))
bymZIP_mun_NQC_djma_M <- inla(update(form, . ~ . + f(mun_NQC, model = "bym", graph = W_mun_NQC, scale.model=TRUE)),
                family = "zeroinflatedpoisson1",
                E=`nombreAccidents_DJMA`,
                data = acc_PA_mun_NQC_M,
                control.compute = list(dic = TRUE))

## Grave
bymPoi_mun_NQC_djma_G <- inla(update(form, . ~ . + f(mun_NQC, model = "bym", graph = W_mun_NQC, scale.model=TRUE)),
                family = "poisson",
                E = `nombreAccidents_DJMA`,
                data = acc_PA_mun_NQC_G,
                control.compute = list(dic = TRUE))
bymNB_mun_NQC_djma_G <- inla(update(form, . ~ . + f(mun_NQC, model = "bym", graph = W_mun_NQC, scale.model=TRUE)),
                family = "nbinomial",
                E=`nombreAccidents_DJMA`,
                data = acc_PA_mun_NQC_G,
                control.compute = list(dic = TRUE))
bymZIP_mun_NQC_djma_G <- inla(update(form, . ~ . + f(mun_NQC, model = "bym", graph = W_mun_NQC, scale.model=TRUE)),
                family = "zeroinflatedpoisson1",
                E = `nombreAccidents_DJMA`,
                data = acc_PA_mun_NQC_G,
                control.compute = list(dic = TRUE))

## Léger
bymPoi_mun_NQC_djma_L <- inla(update(form, . ~ . + f(mun_NQC, model = "bym", graph = W_mun_NQC, scale.model=TRUE)),
                family = "poisson",
                E = `nombreAccidents_DJMA`,
                data = acc_PA_mun_NQC_L,
                control.compute = list(dic = TRUE))
bymNB_mun_NQC_djma_L <- inla(update(form, . ~ . + f(mun_NQC, model = "bym", graph = W_mun_NQC, scale.model=TRUE)),
                family = "nbinomial",
                E=`nombreAccidents_DJMA`,
                data = acc_PA_mun_NQC_L,
                control.compute = list(dic = TRUE))
bymZIP_mun_NQC_djma_L <- inla(update(form, . ~ . + f(mun_NQC, model = "bym", graph = W_mun_NQC, scale.model=TRUE)),
                family = "zeroinflatedpoisson1",
                E = `nombreAccidents_DJMA`,
                data = acc_PA_mun_NQC_L,
                control.compute = list(dic = TRUE))

## Grave + Mortel
bymPoi_mun_NQC_djma_GM <- inla(update(form, . ~ . + f(mun_NQC, model = "bym", graph = W_mun_NQC, scale.model=TRUE)),
                family = "poisson",
                E = `nombreAccidents_DJMA`,
                data = acc_PA_mun_NQC_GM,
                control.compute = list(dic = TRUE))
bymNB_mun_NQC_djma_GM <- inla(update(form, . ~ . + f(mun_NQC, model = "bym", graph = W_mun_NQC, scale.model=TRUE)),
                family = "nbinomial",
                E=`nombreAccidents_DJMA`,
                data = acc_PA_mun_NQC_GM,
                control.compute = list(dic = TRUE))
bymZIP_mun_NQC_djma_GM <- inla(update(form, . ~ . + f(mun_NQC, model = "bym", graph = W_mun_NQC, scale.model=TRUE)),
                family = "zeroinflatedpoisson1",
                E = `nombreAccidents_DJMA`,
                data = acc_PA_mun_NQC_GM,
                control.compute = list(dic = TRUE))

# MRC
## Mortel
bymPoi_mrc_NQC_djma_M <- inla(update(form, . ~ . + f(mrc_NQC, model = "bym", graph = W_mrc_NQC, scale.model=TRUE)),
                family = "poisson",
                E = `nombreAccidents_DJMA`,
                data = acc_PA_mrc_NQC_M,
                control.compute = list(dic = TRUE))

bymNB_mrc_NQC_djma_M <- inla(update(form, . ~ . + f(mrc_NQC, model = "bym", graph = W_mrc_NQC, scale.model=TRUE)),
                family = "nbinomial",
                E = `nombreAccidents_DJMA`,
                data = acc_PA_mrc_NQC_M,
                control.compute = list(dic = TRUE))
# bymNB_mrc_NQC_M <- inla(update(form, . ~ . ),
#                 family = "nbinomial",
#                 E = `nombreAccidents_DJMA`,
#                 data = acc_PA_mrc_NQC_M,
#                 control.compute = list(dic = TRUE))
bymZIP_mrc_NQC_djma_M <- inla(update(form, . ~ . + f(mrc_NQC, model = "bym", graph = W_mrc_NQC, scale.model=TRUE)),
                family = "zeroinflatedpoisson1",
                E = `nombreAccidents_DJMA`,
                data = acc_PA_mrc_NQC_M,
                control.compute = list(dic = TRUE))

## Grave
bymPoi_mrc_NQC_djma_G <- inla(update(form, . ~ . + f(mrc_NQC, model = "bym", graph = W_mrc_NQC, scale.model=TRUE)),
                family = "poisson",
                E = `nombreAccidents_DJMA`,
                data = acc_PA_mrc_NQC_G,
                control.compute = list(dic = TRUE))
bymNB_mrc_NQC_djma_G <- inla(update(form, . ~ . + f(mrc_NQC, model = "bym", graph = W_mrc_NQC, scale.model=TRUE)),
                family = "nbinomial",
                E=`nombreAccidents_DJMA`,
                data = acc_PA_mrc_NQC_G,
                control.compute = list(dic = TRUE))
bymZIP_mrc_NQC_djma_G <- inla(update(form, . ~ . + f(mrc_NQC, model = "bym", graph = W_mrc_NQC, scale.model=TRUE)),
                family = "zeroinflatedpoisson1",
                E = `nombreAccidents_DJMA`,
                data = acc_PA_mrc_NQC_G,
                control.compute = list(dic = TRUE))

## Léger
bymPoi_mrc_NQC_djma_L <- inla(update(form, . ~ . + f(mrc_NQC, model = "bym", graph = W_mrc_NQC, scale.model=TRUE)),
                family = "poisson",
                E = `nombreAccidents_DJMA`,
                data = acc_PA_mrc_NQC_L,
                control.compute = list(dic = TRUE))
bymNB_mrc_NQC_djma_L <- inla(update(form, . ~ . + f(mrc_NQC, model = "bym", graph = W_mrc_NQC, scale.model=TRUE)),
                family = "nbinomial",
                E=`nombreAccidents_DJMA`,
                data = acc_PA_mrc_NQC_L,
                control.compute = list(dic = TRUE))
bymZIP_mrc_NQC_djma_L <- inla(update(form, . ~ . + f(mrc_NQC, model = "bym", graph = W_mrc_NQC, scale.model=TRUE)),
                family = "zeroinflatedpoisson1",
                E = `nombreAccidents_DJMA`,
                data = acc_PA_mrc_NQC_L,
                control.compute = list(dic = TRUE))

## Grave + Mortel
bymPoi_mrc_NQC_djma_GM <- inla(update(form, . ~ . + f(mrc_NQC, model = "bym", graph = W_mrc_NQC, scale.model=TRUE)),
                family = "poisson",
                E = `nombreAccidents_DJMA`,
                data = acc_PA_mrc_NQC_GM,
                control.compute = list(dic = TRUE))
bymNB_mrc_NQC_djma_GM <- inla(update(form, . ~ . + f(mrc_NQC, model = "bym", graph = W_mrc_NQC, scale.model=TRUE)),
                family = "nbinomial",
                E=`nombreAccidents_DJMA`,
                data = acc_PA_mrc_NQC_GM,
                control.compute = list(dic = TRUE))
bymZIP_mrc_NQC_djma_GM <- inla(update(form, . ~ . + f(mrc_NQC, model = "bym", graph = W_mrc_NQC, scale.model=TRUE)),
                family = "zeroinflatedpoisson1",
                E = `nombreAccidents_DJMA`,
                data = acc_PA_mrc_NQC_GM,
                control.compute = list(dic = TRUE))
summary(bymZIP_mrc_NQC_djma_GM)
```

### Liste modèles VKT
```{r}
# mods_M <- list(bymPoi_mun_M = bymPoi_mun_M,
#                bymNB_mun_M = bymNB_mun_M,
#                bymZIP_mun_M = bymZIP_mun_M,
#                bymPoi_mrc_M = bymPoi_mrc_M,
#                bymNB_mrc_M = bymNB_mrc_M,
#                bymZIP_mrc_M = bymZIP_mrc_M
#              )
# 
# mods_G <- list(bymPoi_mun_G = bymPoi_mun_G,
#              bymNB_mun_G = bymNB_mun_G,
#              bymZIP_mun_G = bymZIP_mun_G,
#              bymPoi_mrc_G = bymPoi_mrc_G,
#              bymNB_mrc_G = bymNB_mrc_G,
#              bymZIP_mrc_G = bymZIP_mrc_G
#              )
# 
# mods_GM <- list(bymPoi_mun_GM = bymPoi_mun_GM,
#              bymNB_mun_GM = bymNB_mun_GM,
#              bymZIP_mun_GM = bymZIP_mun_GM,
#              bymPoi_mrc_GM = bymPoi_mrc_GM,
#              bymNB_mrc_GM = bymNB_mrc_GM,
#              bymZIP_mrc_GM = bymZIP_mrc_GM
#              )
# 
# 
# mods_L <- list(bymPoi_mun_L = bymPoi_mun_L,
#              bymNB_mun_L = bymNB_mun_L,
#              bymZIP_mun_L = bymZIP_mun_L,
#              bymPoi_mrc_L = bymPoi_mrc_L,
#              bymNB_mrc_L = bymNB_mrc_L,
#              bymZIP_mrc_L = bymZIP_mrc_L
#              )
```

### Liste modèles DJMA
```{r}
# mods_djma_M <- list(bymPoi_mun_djma_M = bymPoi_mun_djma_M,
#              bymNB_mun_djma_M = bymNB_mun_djma_M,
#              bymZIP_mun_djma_M = bymZIP_mun_djma_M,
#              bymPoi_mrc_djma_M = bymPoi_mrc_djma_M,
#              bymNB_mrc_djma_M = bymNB_mrc_djma_M,
#              bymZIP_mrc_djma_M = bymZIP_mrc_djma_M
#              )
# 
# mods_djma_G <- list(bymPoi_mun_djma_G = bymPoi_mun_djma_G,
#              bymNB_mun_djma_G = bymNB_mun_djma_G,
#              bymZIP_mun_djma_G = bymZIP_mun_djma_G,
#              bymPoi_mrc_djma_G = bymPoi_mrc_djma_G,
#              bymNB_mrc_djma_G = bymNB_mrc_djma_G,
#              bymZIP_mrc_djma_G = bymZIP_mrc_djma_G
#              )
# 
# mods_djma_GM <- list(bymPoi_mun_djma_GM = bymPoi_mun_djma_GM,
#              bymNB_mun_djma_GM = bymNB_mun_djma_GM,
#              bymZIP_mun_djma_GM = bymZIP_mun_djma_GM,
#              bymPoi_mrc_djma_GM = bymPoi_mrc_djma_GM,
#              bymNB_mrc_djma_GM = bymNB_mrc_djma_GM,
#              bymZIP_mrc_djma_GM = bymZIP_mrc_djma_GM
#              )
# 
# mods_djma_L <- list(bymPoi_mun_djma_L = bymPoi_mun_djma_L,
#              bymNB_mun_djma_L = bymNB_mun_djma_L,
#              bymZIP_mun_djma_L = bymZIP_mun_djma_L,
#              bymPoi_mrc_djma_L = bymPoi_mrc_djma_L,
#              bymNB_mrc_djma_L = bymNB_mrc_djma_L,
#              bymZIP_mrc_djma_L = bymZIP_mrc_djma_L
#              )
# 
# 
# # stargazer(mod_tableauPropre(mods_M), type="text", summary=F, rownames=F)
# # stargazer(mod_tableauPropre(mods_djma_M), type="text", summary=F)
# #
# # stargazer(mod_tableauPropre(mods_G), type="text", summary=F)
# # stargazer(mod_tableauPropre(mods_djma_G), type="text", summary=F)
# #
# # stargazer(mod_tableauPropre(mods_GM), type="text", summary=F)
# # stargazer(mod_tableauPropre(mods_djma_GM), type="text", summary=F)
# #
# # stargazer(mod_tableauPropre(mods_L), type="text", summary=F)
# # stargazer(mod_tableauPropre(mods_djma_L), type="text", summary=F)
```

### Listes modèles NQC (DJMA et VKT)
```{r}
# mods_NQC_M <- list(bymPoi_mun_NQC_M = bymPoi_mun_NQC_M,
#                bymNB_mun_NQC_M = bymNB_mun_NQC_M,
#                bymZIP_mun_NQC_M = bymZIP_mun_NQC_M,
#                bymPoi_mrc_NQC_M = bymPoi_mrc_NQC_M,
#                bymNB_mrc_NQC_M = bymNB_mrc_NQC_M,
#                bymZIP_mrc_NQC_M = bymZIP_mrc_NQC_M
#              )
# 
# mods_NQC_G <- list(bymPoi_mun_NQC_G = bymPoi_mun_NQC_G,
#              bymNB_mun_NQC_G = bymNB_mun_NQC_G,
#              bymZIP_mun_NQC_G = bymZIP_mun_NQC_G,
#              bymPoi_mrc_NQC_G = bymPoi_mrc_NQC_G,
#              bymNB_mrc_NQC_G = bymNB_mrc_NQC_G,
#              bymZIP_mrc_NQC_G = bymZIP_mrc_NQC_G
#              )
# 
# mods_NQC_GM <- list(bymPoi_mun_NQC_GM = bymPoi_mun_NQC_GM,
#              bymNB_mun_NQC_GM = bymNB_mun_NQC_GM,
#              bymZIP_mun_NQC_GM = bymZIP_mun_NQC_GM,
#              bymPoi_mrc_NQC_GM = bymPoi_mrc_NQC_GM,
#              bymNB_mrc_NQC_GM = bymNB_mrc_NQC_GM,
#              bymZIP_mrc_NQC_GM = bymZIP_mrc_NQC_GM
#              )
# 
# 
# mods_NQC_L <- list(bymPoi_mun_NQC_L = bymPoi_mun_NQC_L,
#              bymNB_mun_NQC_L = bymNB_mun_NQC_L,
#              bymZIP_mun_NQC_L = bymZIP_mun_NQC_L,
#              bymPoi_mrc_NQC_L = bymPoi_mrc_NQC_L,
#              bymNB_mrc_NQC_L = bymNB_mrc_NQC_L,
#              bymZIP_mrc_NQC_L = bymZIP_mrc_NQC_L
#              )
# 
# mods_NQC_djma_M <- list(bymPoi_mun_NQC_djma_M = bymPoi_mun_NQC_djma_M,
#              bymNB_mun_NQC_djma_M = bymNB_mun_NQC_djma_M,
#              bymZIP_mun_NQC_djma_M = bymZIP_mun_NQC_djma_M,
#              bymPoi_mrc_NQC_djma_M = bymPoi_mrc_NQC_djma_M,
#              bymNB_mrc_NQC_djma_M = bymNB_mrc_NQC_djma_M,
#              bymZIP_mrc_NQC_djma_M = bymZIP_mrc_NQC_djma_M
#              )
# 
# mods_NQC_djma_G <- list(bymPoi_mun_NQC_djma_G = bymPoi_mun_NQC_djma_G,
#              bymNB_mun_NQC_djma_G = bymNB_mun_NQC_djma_G,
#              bymZIP_mun_NQC_djma_G = bymZIP_mun_NQC_djma_G,
#              bymPoi_mrc_NQC_djma_G = bymPoi_mrc_NQC_djma_G,
#              bymNB_mrc_NQC_djma_G = bymNB_mrc_NQC_djma_G,
#              bymZIP_mrc_NQC_djma_G = bymZIP_mrc_NQC_djma_G
#              )
# 
# mods_NQC_djma_GM <- list(bymPoi_mun_NQC_djma_GM = bymPoi_mun_NQC_djma_GM,
#              bymNB_mun_NQC_djma_GM = bymNB_mun_NQC_djma_GM,
#              bymZIP_mun_NQC_djma_GM = bymZIP_mun_NQC_djma_GM,
#              bymPoi_mrc_NQC_djma_GM = bymPoi_mrc_NQC_djma_GM,
#              bymNB_mrc_NQC_djma_GM = bymNB_mrc_NQC_djma_GM,
#              bymZIP_mrc_NQC_djma_GM = bymZIP_mrc_NQC_djma_GM
#              )
# 
# mods_NQC_djma_L <- list(bymPoi_mun_NQC_djma_L = bymPoi_mun_NQC_djma_L,
#              bymNB_mun_NQC_djma_L = bymNB_mun_NQC_djma_L,
#              bymZIP_mun_NQC_djma_L = bymZIP_mun_NQC_djma_L,
#              bymPoi_mrc_NQC_djma_L = bymPoi_mrc_NQC_djma_L,
#              bymNB_mrc_NQC_djma_L = bymNB_mrc_NQC_djma_L,
#              bymZIP_mrc_NQC_djma_L = bymZIP_mrc_NQC_djma_L
#              )
# 
# 
# # stargazer(mod_tableauPropre(mods_NQC_M), type="text", summary=F, rownames=F)
# # stargazer(mod_tableauPropre(mods_NQC_djma_M), type="text", summary=F)
# #
# # stargazer(mod_tableauPropre(mods_NQC_G), type="text", summary=F)
# # stargazer(mod_tableauPropre(mods_NQC_djma_G), type="text", summary=F)
# #
# # stargazer(mod_tableauPropre(mods_NQC_GM), type="text", summary=F)
# # stargazer(mod_tableauPropre(mods_NQC_djma_GM), type="text", summary=F)
# #
# # stargazer(mod_tableauPropre(mods_NQC_L), type="text", summary=F)
# # stargazer(mod_tableauPropre(mods_NQC_djma_L), type="text", summary=F)
```

## DIC

```{r}
# Catégorie <- c("Inclusion NQC", "Type d'exposition", "Gravité", "Distribution", "Total")
# `Nombre de classes` <- c(2,2,4,3,48)
# 
# df <- tibble(Catégorie, `Nombre de classes`)
# 
# stargazer(df, summary=F, type="text", rownames = F)
```

### Exposition: VKT vs DJMA
```{r}

# tab: dic_avecNQC ####
# Avec NQC - inclus dans mémoire
temp <- extractDIC(vctrs::vec_c(mods_M, mods_G, mods_GM, mods_L, mods_djma_M, mods_djma_G, mods_djma_GM, mods_djma_L))
stargazer(compaVar("Exposition", temp, bestFam = T), type="text", summary=F, rownames = F)

# Sans NQC - pas inclus car semblable
temp <- extractDIC(vctrs::vec_c(mods_NQC_M, mods_NQC_G, mods_NQC_GM, mods_NQC_L, mods_NQC_djma_M, mods_NQC_djma_G, mods_NQC_djma_GM, mods_NQC_djma_L),1)
stargazer(compaVar("Exposition", temp), type="text", summary=F, rownames = F)
```
clairement, VKT > DJMA, du moins du côté du DIC
Même chose lorsqu'on enlève NQC

### NQC
```{r}
# temp <- extractDIC(vctrs::vec_c(mods_M,
#                                 mods_G,
#                                 mods_GM,
#                                 mods_L,
#                                 mods_djma_M,
#                                 mods_djma_G,
#                                 mods_djma_GM,
#                                 mods_djma_L,
#                                 mods_NQC_M,
#                                 mods_NQC_G,
#                                 mods_NQC_GM,
#                                 mods_NQC_L,
#                                 mods_NQC_djma_M,
#                                 mods_NQC_djma_G, mods_NQC_djma_GM, mods_NQC_djma_L), 1)
# 
# stargazer(compaVar("NQC", temp), type="text", summary=F, rownames = F)

```
Dans tous les cas, en excluant NQC, on obtient un meilleur DIC (pas nécesssairement que le modèle est vrm mieux, mais p-ê a cause de moins de données, simplification du modèle, mais p-ê aussi que la région n'était pas représentative et ajoutait du bruit, donc meilleur modèle).

Dans presque tous les cas, BN est mieux, sauf pour les accidents mortels


### SS Comparaison avec modèles sans structure spatiale
```{r}
bymNB_mun_NQC_M_sSS <- inla(update(form, . ~ . + f(mun_NQC, model="iid")) ,
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mun_NQC_M,
                control.compute = list(dic = TRUE))
bymNB_mrc_NQC_M_sSS <- inla(update(form, . ~ . + f(mrc_NQC, model="iid")),
                family = "nbinomial",
                E = `nombreAccidents_VKT`,
                data = acc_PA_mrc_NQC_M,
                control.compute = list(dic = TRUE))
bymNB_mun_NQC_G_sSS <- inla(update(form, . ~ . + f(mun_NQC, model="iid")),
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mun_NQC_G,
                control.compute = list(dic = TRUE))
bymNB_mrc_NQC_G_sSS <- inla(update(form, . ~ . + f(mrc_NQC, model="iid")),
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mrc_NQC_G,
                control.compute = list(dic = TRUE))
bymNB_mun_NQC_GM_sSS <- inla(update(form, . ~ . + f(mun_NQC, model="iid")),
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mun_NQC_GM,
                control.compute = list(dic = TRUE))
bymNB_mrc_NQC_GM_sSS <- inla(update(form, . ~ . + f(mrc_NQC, model="iid")),
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mrc_NQC_GM,
                control.compute = list(dic = TRUE))
bymNB_mun_NQC_L_sSS <- inla(update(form, . ~ . + f(mun_NQC, model="iid")),
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mun_NQC_L,
                control.compute = list(dic = TRUE))
bymNB_mrc_NQC_L_sSS <- inla(update(form, . ~ . + f(mrc_NQC, model="iid")),
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mrc_NQC_L,
                control.compute = list(dic = TRUE))

bymNB_mun_M_sSS <- inla(update(form, . ~ . + f(mun, model="iid")),
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mun_M,
                control.compute = list(dic = TRUE))
bymNB_mrc_M_sSS <- inla(update(form, . ~ . + f(mrc, model="iid")),
                family = "nbinomial",
                E = `nombreAccidents_VKT`,
                data = acc_PA_mrc_M,
                control.compute = list(dic = TRUE))
bymNB_mun_G_sSS <- inla(update(form, . ~ . + f(mun, model="iid")),
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mun_G,
                control.compute = list(dic = TRUE))
bymNB_mrc_G_sSS <- inla(update(form, . ~ . + f(mrc, model="iid")),
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mrc_G,
                control.compute = list(dic = TRUE))
bymNB_mun_GM_sSS <- inla(update(form, . ~ . + f(mun, model="iid")),
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mun_GM,
                control.compute = list(dic = TRUE))
bymNB_mrc_GM_sSS <- inla(update(form, . ~ . + f(mrc, model="iid")),
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mrc_GM,
                control.compute = list(dic = TRUE))
bymNB_mun_L_sSS <- inla(update(form, . ~ . + f(mun, model="iid")),
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mun_L,
                control.compute = list(dic = TRUE))
bymNB_mrc_L_sSS <- inla(update(form, . ~ . + f(mrc, model="iid")),
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mrc_L,
                control.compute = list(dic = TRUE))


mods_SS <- list(
  bymNB_mun_M=bymNB_mun_M,
  bymNB_mun_M_sSS=bymNB_mun_M_sSS,
  bymNB_mrc_M=bymNB_mrc_M,
  bymNB_mrc_M_sSS=bymNB_mrc_M_sSS,
  bymNB_mun_G=bymNB_mun_G,
  bymNB_mun_G_sSS=bymNB_mun_G_sSS,
  bymNB_mrc_G=bymNB_mrc_G,
  bymNB_mrc_G_sSS=bymNB_mrc_G_sSS,
  bymNB_mun_GM=bymNB_mun_GM,
  bymNB_mun_GM_sSS=bymNB_mun_GM_sSS,
  bymNB_mrc_GM=bymNB_mrc_GM,
  bymNB_mrc_GM_sSS=bymNB_mrc_GM_sSS,
  bymNB_mun_L=bymNB_mun_L,
  bymNB_mun_L_sSS=bymNB_mun_L_sSS,
  bymNB_mrc_L=bymNB_mrc_L,
  bymNB_mrc_L_sSS=bymNB_mrc_L_sSS
)

mods_SS_NQC <- list(
  bymNB_mun_NQC_M=bymNB_mun_NQC_M,
  bymNB_mun_NQC_M_sSS=bymNB_mun_NQC_M_sSS,
  bymNB_mrc_NQC_M=bymNB_mrc_NQC_M,
  bymNB_mrc_NQC_M_sSS=bymNB_mrc_NQC_M_sSS,
  bymNB_mun_NQC_G=bymNB_mun_NQC_G,
  bymNB_mun_NQC_G_sSS=bymNB_mun_NQC_G_sSS,
  bymNB_mrc_NQC_G=bymNB_mrc_NQC_G,
  bymNB_mrc_NQC_G_sSS=bymNB_mrc_NQC_G_sSS,
  bymNB_mun_NQC_GM=bymNB_mun_NQC_GM,
  bymNB_mun_NQC_GM_sSS=bymNB_mun_NQC_GM_sSS,
  bymNB_mrc_NQC_GM=bymNB_mrc_NQC_GM,
  bymNB_mrc_NQC_GM_sSS=bymNB_mrc_NQC_GM_sSS,
  bymNB_mun_NQC_L=bymNB_mun_NQC_L,
  bymNB_mun_NQC_L_sSS=bymNB_mun_NQC_L_sSS,
  bymNB_mrc_NQC_L=bymNB_mrc_NQC_L,
  bymNB_mrc_NQC_L_sSS=bymNB_mrc_NQC_L_sSS
)


# tab: dic_SS ####
stargazer(extractDIC(mods_SS, bestFam = F) %>% 
            select(-Modèle, -Distribution, -NQC, -Exposition), type="latex", summary=F, rownames = F)


stargazer(compaVar("SS", extractDIC(mods_SS, bestFam = T), bestFam = F), type="text", summary=F, rownames = F)

stargazer(compaVar("SS", extractDIC(mods_SS_NQC, bestFam = T), bestFam = F), type="text", summary=F, rownames = F)
```
Munic. le modèle avec SS est mieux
MRC, le modèle sans SS est mieux

```{r}
# # # head(marg.hyper)
# # marg.hyper <- inla.hyperpar.sample(100000, bymNB_mun_G) # produces precision directly
# # 
# # perc.var.u1 <- mean(1/marg.hyper[,3] / (1/marg.hyper[,1]+1/marg.hyper[,2]+1/marg.hyper[,3]))
# # perc.var.u1
# # 
# # mean(marg.hyper[,3])
# # mean(marg.hyper[,2])
# # mean(marg.hyper[,1])
# # bymNB_mun_G$summary.hyperpar$mean
# 

pourcVar <- function(modele){
  marg.hyper <- inla.hyperpar.sample(100000, modele)
  perc.var.u1 <- mean(1/marg.hyper[,3] /
                        (1/marg.hyper[,2]+1/marg.hyper[,3]))
  perc.var.u1
}

# test <- left_join(acc_PA_mun_NQC_M, acc_PA_mrc_NQC_M %>% select(An, CD_MRC, nombreAccidents_VKT) %>% distinct(nombreAccidents_VKT, .keep_all = T), by = join_by(An==An, CD_MRC==CD_MRC))
# view(test)

marg.hyper <- inla.hyperpar.sample(100000, bymNB_mun_M)
head(marg.hyper)
pourcVar(bymNB_mun_M)
pourcVar(bymNB_mun_NQC_M)
pourcVar(bymNB_mrc_M)
pourcVar(bymNB_mrc_NQC_M)

pourcVar(bymNB_mun_G)
pourcVar(bymNB_mun_NQC_G)
pourcVar(bymNB_mrc_G)
pourcVar(bymNB_mrc_NQC_G)

pourcVar(bymNB_mrc_L)
pourcVar(bymNB_mrc_NQC_L)
pourcVar(bymNB_mun_L)
pourcVar(bymNB_mun_NQC_L)

pourcVar(bymNB_mun_GM)
pourcVar(bymNB_mun_NQC_GM)
pourcVar(bymNB_mrc_GM)
pourcVar(bymNB_mrc_NQC_GM)

Gravité <- c(rep(c("Mortel", "Grave", "Grave + Mortel", "Léger"), 2))
Région <- c(rep("Munic.", 4), rep("MRC", 4))
propVar <- c(pourcVar(bymNB_mun_NQC_M),
              pourcVar(bymNB_mun_NQC_G),
              pourcVar(bymNB_mun_NQC_GM),
              pourcVar(bymNB_mun_NQC_L),
              pourcVar(bymNB_mrc_NQC_M),
              pourcVar(bymNB_mrc_NQC_G),
              pourcVar(bymNB_mrc_NQC_GM),
              pourcVar(bymNB_mrc_NQC_L)
              )


df <- tibble(Gravité, Région, `Prop. variance expliquée par SS`=round(propVar,3))

# tab: varPropSS
stargazer(df, summary=F, type="text", rownames = F)
```
La proportion de la variance expliquée par la structure spatiale n'est élevée que pour les munic.

y a t il des diff de coefs signifs pour MRC - avec SS et sans
```{r}
# mod_tableauPropre(list(bymNB_mrc_NQC_M = bymNB_mrc_NQC_M,
#                        bymNB_mrc_NQC_M_sSS = bymNB_mrc_NQC_M_sSS), difSignificativité = T)
# mod_tableauPropre(list(bymNB_mrc_NQC_G = bymNB_mrc_NQC_G,
#                        bymNB_mrc_NQC_GM_sSS = bymNB_mrc_NQC_GM_sSS), difSignificativité = T)
# 
# mod_tableauPropre(list(bymNB_mrc_NQC_GM = bymNB_mrc_NQC_GM,
#                        bymNB_mrc_NQC_GM_sSS = bymNB_mrc_NQC_GM_sSS), difSignificativité = T)
# mod_tableauPropre(list(bymNB_mrc_NQC_L = bymNB_mrc_NQC_L,
#                        bymNB_mrc_NQC_L_sSS = bymNB_mrc_NQC_L_sSS), difSignificativité = T)

```
dif très négligeable


#### Comparaison coefs
VKT, NB - inclusion NQC vs pas
```{r}
# mod_tableauPropre(list(bymNB_mun_M = bymNB_mun_M,
#                        bymNB_mun_NQC_M = bymNB_mun_NQC_M), difSignificativité = T)
# mod_tableauPropre(list(bymNB_mrc_M = bymNB_mrc_M,
#                        bymNB_mrc_NQC_M = bymNB_mrc_NQC_M), difSignificativité = T)
# 
# mod_tableauPropre(list(bymNB_mun_G = bymNB_mun_G,
#                        bymNB_mun_NQC_G = bymNB_mun_NQC_G), difSignificativité = T)
# mod_tableauPropre(list(bymNB_mrc_G = bymNB_mrc_G,
#                        bymNB_mrc_NQC_G = bymNB_mrc_NQC_G), difSignificativité = T)
# 
# mod_tableauPropre(list(bymNB_mun_L = bymNB_mun_L,
#                        bymNB_mun_NQC_L = bymNB_mun_NQC_L), difSignificativité = T)
# mod_tableauPropre(list(bymNB_mrc_L = bymNB_mrc_L,
#                        bymNB_mrc_NQC_L = bymNB_mrc_NQC_L), difSignificativité = T)
# 
# mod_tableauPropre(list(bymNB_mun_GM = bymNB_mun_GM,
#                        bymNB_mun_NQC_GM = bymNB_mun_NQC_GM), difSignificativité = T)
# mod_tableauPropre(list(bymNB_mrc_GM = bymNB_mrc_GM,
#                        bymNB_mrc_NQC_GM = bymNB_mrc_NQC_GM), difSignificativité = T)
```
Mortel
  mun - jeunes signif sans 
  mrc - secondaire signif avec
  
Grave
  mun - aucune diff
  mrc - plusieurs dif! 65Ans+, bacc, secondaire, chomeurs signifs avec
  
Leger
  mun - bacc signif sans
  mrc - densitéLinéaire
  
G+M
  mun - jeunes signig sans
  mrc - 65Ans+, bacc, secondaire, chomeurs signifs avec

Semble y avoir plusieurs dif de G_mrc, vérifions la SS


## Comparaison coefs

```{r}
mMun <- mod_tableauPropre(list(
                       bymNB_mun_NQC_M = bymNB_mun_NQC_M,
                       bymNB_mun_NQC_G = bymNB_mun_NQC_G,
                       bymNB_mun_NQC_L = bymNB_mun_NQC_L), difSignificativité = F)

mMRC <- mod_tableauPropre(list(bymNB_mrc_NQC_M = bymNB_mrc_NQC_M,
                       bymNB_mrc_NQC_G = bymNB_mrc_NQC_G,
                       # bymNB_mrc_NQC_GM = bymNB_mrc_NQC_GM,
                       bymNB_mrc_NQC_L = bymNB_mrc_NQC_L), difSignificativité = F)
df <- cbind(mMun, mMRC %>% select(-Coefficients))


# tab: modBase_coef ####
stargazer(df %>% data.frame %>% filter(!(Coefficients %in% c("Modèle", "Distribution", "Exposition", "NQC"))), summary=F, type="text", rownames = F)


# mMun <- mod_tableauPropre(list(bymNB_mun_NQC_M = bymNB_mun_NQC_M,
#                        bymNB_mun_NQC_G = bymNB_mun_NQC_G,
#                        # bymNB_mun_NQC_GM = bymNB_mun_NQC_GM,
#                        bymNB_mun_NQC_L = bymNB_mun_NQC_L), difSignificativité = T)
#
# mMRC <- mod_tableauPropre(list(bymNB_mrc_NQC_M = bymNB_mrc_NQC_M,
#                        bymNB_mrc_NQC_G = bymNB_mrc_NQC_G,
#                        # bymNB_mrc_NQC_GM = bymNB_mrc_NQC_GM,
#                        bymNB_mrc_NQC_L = bymNB_mrc_NQC_L), difSignificativité = T)
# df <- cbind(mMun, mMRC %>% select(-Coefficients))
# colnames(df)[c(5, 9)] <- "difSignif"

# mod_tableauPropre(list(bymNB_mun_NQC_M = bymNB_mun_NQC_M,
#                        bymPoi_mun_NQC_M = bymPoi_mun_NQC_M), difSignificativité = T)
# 
# mod_tableauPropre(list(bymNB_mun_NQC_G = bymNB_mun_NQC_G,
#                        bymPoi_mun_NQC_G = bymPoi_mun_NQC_G), difSignificativité = T)
# 
# mod_tableauPropre(list(bymNB_mun_NQC_L = bymNB_mun_NQC_L,
#                        bymPoi_mun_NQC_L = bymPoi_mun_NQC_L), difSignificativité = T)
```

# Stats NQC
```{r}
# # acc_PJ <- data_acc %>%
# #   distinct(NO_SEQ_COLL, .keep_all = T) %>%
# #   # mutate(An = year(DT_ACCDN)) %>%
# #   # group_by(An, gravite, REG_ADM, MRC, CD_MUNCP) %>%
# #   # mutate(vitesse_autor = replace_na(VITESSE_AUTOR, round(mean(VITESSE_AUTOR, na.rm = TRUE)))) %>%
# #   # group_by(An, gravite) %>%
# #   # mutate(vitesse_autor = replace_na(vitesse_autor, round(mean(VITESSE_AUTOR, na.rm = TRUE)))) %>%
# #   group_by(DT_ACCDN, gravite, REG_ADM, MRC, CD_MUNCP) %>%
# #   summarise(nbAcc = length(DT_ACCDN), 
# #             nbMorts = sum(NB_MORTS), 
# #             nbGraves=sum(NB_BLESSES_GRAVES),  
# #             nbLegers=sum(NB_BLESSES_LEGERS), 
# #             nbVeh=sum(NB_VEH_IMPLIQUES_ACCDN), 
# #             nb1Veh=sum(NB_VEH_IMPLIQUES_ACCDN==1), 
# #             nbVic=sum(NB_VICTIMES_TOTAL), 
# #             nbVic_Piet=sum(NB_VICTIMES_PIETON), 
# #             nbVic_Velo=sum(NB_VICTIMES_VELO), 
# #             nbDec_Piet = sum(NB_DECES_PIETON), 
# #             nbDec_Velo = sum(NB_DECES_VELO), 
# #             nbDec_Moto = sum(NB_DECES_MOTO), 
# #             nbDeces = sum(NB_MORTS), 
# #             nbAcc_Piet = sum(NB_DECES_PIETON > 0), 
# #             nbAcc_Velo = sum(NB_DECES_VELO > 0), 
# #             nbAcc_Moto = sum(NB_DECES_MOTO > 0)) %>%
# #             # points = sum(points),
# #             # vitesse_autor = sum(vitesse_autor),
# #             # vitesse_autor = sum(VITESSE_AUTOR, na.rm=T)) %>%
# #   mutate(An = year(DT_ACCDN))
# # 
# # acc_PJ %>% filter(REG_ADM == 10, gravite=="Mortel") %>% view
# 
# acc_PA_mrc_M %>% filter(CD_RA == 10) %>%
#   group_by(An) %>%
#   summarise(nombreAccidents_NQC=sum(nombreAccidents), Popu_NQC=Pplt_21) %>%
#   left_join(acc_PA_mrc_M %>% group_by(An) %>%
#     summarise(nombreAccidents_Qc=sum(nombreAccidents), Popu_Qc=sum(Pplt_21))) %>%
#   mutate(nbAccPourc = nombreAccidents_NQC/nombreAccidents_Qc*100, 
#          popuPourc=Popu_NQC/Popu_Qc*100)
# 
# acc_PA_mrc_G %>% filter(CD_RA == 10) %>%
#   group_by(An) %>%
#   summarise(nombreAccidents_NQC=sum(nombreAccidents), Popu_NQC=Pplt_21) %>%
#   left_join(acc_PA_mrc_G %>% group_by(An) %>%
#     summarise(nombreAccidents_Qc=sum(nombreAccidents), Popu_Qc=sum(Pplt_21))) %>%
#   mutate(nbAccPourc = nombreAccidents_NQC/nombreAccidents_Qc*100, popuPourc=Popu_NQC/Popu_Qc*100)
# 
# acc_PA_mrc_L %>% filter(CD_RA == 10) %>%
#   group_by(An) %>%
#   summarise(nombreAccidents_NQC=sum(nombreAccidents), Popu_NQC=Pplt_21) %>%
#   left_join(acc_PA_mrc_L %>% group_by(An) %>%
#     summarise(nombreAccidents_Qc=sum(nombreAccidents), Popu_Qc=sum(Pplt_21))) %>%
#   mutate(nbAccPourc = nombreAccidents_NQC/nombreAccidents_Qc*100, popuPourc=Popu_NQC/Popu_Qc*100)
```




# Entrainement des modèles de bases finaux
```{r}
bymNB_mun_NQC_M <- inla(update(form, . ~ . + f(mun_NQC, model = "bym", graph = W_mun_NQC, scale.model=TRUE)), 
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mun_NQC_M,
                control.compute = list(dic = TRUE))
bymNB_mun_NQC_M$dic$dic
bymNB_mrc_NQC_M <- inla(update(form, . ~ . + f(mrc_NQC, model = "bym", graph = W_mrc_NQC, scale.model=TRUE)), 
                family = "nbinomial",
                E = `nombreAccidents_VKT`,
                data = acc_PA_mrc_NQC_M,
                control.compute = list(dic = TRUE))
bymNB_mun_NQC_G <- inla(update(form, . ~ . + f(mun_NQC, model = "bym", graph = W_mun_NQC, scale.model=TRUE)), 
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mun_NQC_G,
                control.compute = list(dic = TRUE))
bymNB_mrc_NQC_G <- inla(update(form, . ~ . + f(mrc_NQC, model = "bym", graph = W_mrc_NQC, scale.model=TRUE)), 
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mrc_NQC_G,
                control.compute = list(dic = TRUE))
bymNB_mun_NQC_GM <- inla(update(form, . ~ . + f(mun_NQC, model = "bym", graph = W_mun_NQC, scale.model=TRUE)), 
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mun_NQC_GM,
                control.compute = list(dic = TRUE))
bymNB_mrc_NQC_GM <- inla(update(form, . ~ . + f(mrc_NQC, model = "bym", graph = W_mrc_NQC, scale.model=TRUE)), 
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mrc_NQC_GM,
                control.compute = list(dic = TRUE))
bymNB_mun_NQC_L <- inla(update(form, . ~ . + f(mun_NQC, model = "bym", graph = W_mun_NQC, scale.model=TRUE)), 
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mun_NQC_L,
                control.compute = list(dic = TRUE))
bymNB_mrc_NQC_L <- inla(update(form, . ~ . + f(mrc_NQC, model = "bym", graph = W_mrc_NQC, scale.model=TRUE)), 
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mrc_NQC_L,
                control.compute = list(dic = TRUE))

mods <- list(
  bymNB_mun_NQC_M=bymNB_mun_NQC_M,
  bymNB_mrc_NQC_M=bymNB_mrc_NQC_M,
  bymNB_mun_NQC_G=bymNB_mun_NQC_G,
  bymNB_mrc_NQC_G=bymNB_mrc_NQC_G,
  bymNB_mun_NQC_GM=bymNB_mun_NQC_GM,
  bymNB_mrc_NQC_GM=bymNB_mrc_NQC_GM,
  bymNB_mun_NQC_L=bymNB_mun_NQC_L,
  bymNB_mrc_NQC_L=bymNB_mrc_NQC_L)

stargazer(mod_tableauPropre(mods), type="latex", summary=F, rownames=F)
extractDIC(mods)

extractDIC(list(
  bymNB_mun_NQC_M=bymNB_mun_NQC_M))

```


Entrainons les modeles que nous garderons


# Q.1 Existe-t-il un effet covid significatif


## 1.1 Effet temporel (2020)
```{r}
bymNB_mun_NQC_M_iC <- inla(update(form, . ~ . + ind_covid + f(mun_NQC, model = "bym", graph = W_mun_NQC, scale.model=TRUE)), 
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mun_NQC_M,
                control.compute = list(dic = TRUE))

  # bymNB_mun_M_iC <- inla(update(form, . ~ . + ind_covid + f(mun, model = "bym", graph = W_mun, scale.model=TRUE)), 
  #                 family = "nbinomial",
  #                 E=`nombreAccidents_VKT`,
  #                 data = acc_PA_mun_M,
  #                 control.compute = list(dic = TRUE))
  # 
  # stargazer(mod_tableauPropre(list(bymNB_mun_NQC_M_iC=bymNB_mun_NQC_M_iC,
  #                                  bymNB_mun_M_iC=bymNB_mun_M_iC), difSignificativité = T), summary=F, type="text")

bymNB_mrc_NQC_M_iC <- inla(update(form, . ~ . + ind_covid + f(mrc_NQC, model = "bym", graph = W_mrc_NQC, scale.model=TRUE)), 
                family = "nbinomial",
                E = `nombreAccidents_VKT`,
                data = acc_PA_mrc_NQC_M,
                control.compute = list(dic = TRUE))
bymNB_mun_NQC_G_iC <- inla(update(form, . ~ . + ind_covid + f(mun_NQC, model = "bym", graph = W_mun_NQC, scale.model=TRUE)), 
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mun_NQC_G,
                control.compute = list(dic = TRUE))
bymNB_mrc_NQC_G_iC <- inla(update(form, . ~ . + ind_covid + f(mrc_NQC, model = "bym", graph = W_mrc_NQC, scale.model=TRUE)), 
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mrc_NQC_G,
                control.compute = list(dic = TRUE))

  # bymNB_mrc_G_iC <- inla(update(form, . ~ . + ind_covid + f(mrc, model = "bym", graph = W_mrc, scale.model=TRUE)), 
  #               family = "nbinomial",
  #               E=`nombreAccidents_VKT`,
  #               data = acc_PA_mrc_G,
  #               control.compute = list(dic = TRUE))
  # stargazer(mod_tableauPropre(list(bymNB_mrc_NQC_G_iC=bymNB_mrc_NQC_G_iC,
  #                                  bymNB_mrc_G_iC=bymNB_mrc_G_iC), difSignificativité = T), summary=F, type="text")
  
bymNB_mun_NQC_GM_iC <- inla(update(form, . ~ . + ind_covid + f(mun_NQC, model = "bym", graph = W_mun_NQC, scale.model=TRUE)), 
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mun_NQC_GM,
                control.compute = list(dic = TRUE))
bymNB_mrc_NQC_GM_iC <- inla(update(form, . ~ . + ind_covid + f(mrc_NQC, model = "bym", graph = W_mrc_NQC, scale.model=TRUE)), 
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mrc_NQC_GM,
                control.compute = list(dic = TRUE))
bymNB_mun_NQC_L_iC <- inla(update(form, . ~ . + ind_covid + f(mun_NQC, model = "bym", graph = W_mun_NQC, scale.model=TRUE)), 
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mun_NQC_L,
                control.compute = list(dic = TRUE))
bymNB_mrc_NQC_L_iC <- inla(update(form, . ~ . + ind_covid + f(mrc_NQC, model = "bym", graph = W_mrc_NQC, scale.model=TRUE)), 
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mrc_NQC_L,
                control.compute = list(dic = TRUE))

mods_iC <- list(
  bymNB_mun_NQC_M_iC=bymNB_mun_NQC_M_iC,
  # bymNB_mrc_NQC_M_iC=bymNB_mrc_NQC_M_iC,
  bymNB_mun_NQC_G_iC=bymNB_mun_NQC_G_iC,
  # bymNB_mrc_NQC_G_iC=bymNB_mrc_NQC_G_iC,
  bymNB_mun_NQC_GM_iC=bymNB_mun_NQC_GM_iC,
  # bymNB_mrc_NQC_GM_iC=bymNB_mrc_NQC_GM_iC,
  bymNB_mun_NQC_L_iC=bymNB_mun_NQC_L_iC)
  # bymNB_mrc_NQC_L_iC=bymNB_mrc_NQC_L_iC)

extractDIC(vctrs::vec_c(mods_iC))

stargazer(compaVar("iC", extractDIC(vctrs::vec_c(mods, mods_iC)), bestFam = F), type="text", summary=F, rownames = F)

stargazer(mod_tableauPropre(list(bymNB_mun_NQC_M=bymNB_mun_NQC_M,
                                 bymNB_mun_NQC_M_iC=bymNB_mun_NQC_M_iC), difSignificativité = T), type="text", summary=F, rownames=F)
  
  
  stargazer(mod_tableauPropre(list(bymNB_mun_NQC_G=bymNB_mun_NQC_G,
                                   bymNB_mun_NQC_G_iC=bymNB_mun_NQC_G_iC), difSignificativité = T), type="text", summary=F, rownames=F)
  
  stargazer(mod_tableauPropre(list(bymNB_mun_NQC_L=bymNB_mun_NQC_L,
                                   bymNB_mun_NQC_L_iC=bymNB_mun_NQC_L_iC), difSignificativité = T), type="text", summary=F, rownames=F)
  
  stargazer(mod_tableauPropre(list(bymNB_mun_NQC_GM=bymNB_mun_NQC_GM,
                                   bymNB_mun_NQC_GM_iC=bymNB_mun_NQC_GM_iC), difSignificativité = T), type="text", summary=F, rownames=F)
  
# tab: coefs ind_covid
stargazer(mod_tableauPropre(mods_iC) %>% filter(
  Coefficients %in% c("Gravité", "ind_covidPost-Covid", "DIC") | is.na(Coefficients)
  ), type="latex", summary=F, rownames=F)

  pourcVar(bymNB_mun_NQC_M)
  pourcVar(bymNB_mun_NQC_M_iC)
  pourcVar(bymNB_mrc_NQC_M)
  pourcVar(bymNB_mrc_NQC_M_iC)
  
  
```
Dans tous les cas, ajouter l'indicateur temporel de 2020 améliore le DIC.
Dorénavant, plus de G+M car G et M ne suivent pas la même tendance du tout!

```{r}
mun_NQC_pre <- as.integer(factor(acc_PA_mun_NQC_M %>% filter(ind_covid=="Pre-Covid") %>% .$CD_MUN))
mun_NQC_post <- as.integer(factor(acc_PA_mun_NQC_M %>% filter(ind_covid=="Post-Covid") %>% .$CD_MUN))

bymNB_mun_NQC_M_iC_pre <- inla(update(form, . ~ f(mun_NQC_pre, model = "bym", graph = W_mun_NQC, scale.model=TRUE)), 
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mun_NQC_M %>% filter(ind_covid=="Pre-Covid"),
                control.compute = list(dic = TRUE))

bymNB_mun_NQC_M_iC_post <- inla(update(form, . ~ f(mun_NQC_post, model = "bym", graph = W_mun_NQC, scale.model=TRUE)), 
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mun_NQC_M %>% filter(ind_covid=="Post-Covid"),
                control.compute = list(dic = TRUE))

pre <- cbind(qc_muncp_NQC, bymNB_mun_NQC_M_iC_pre$summary.random$mun_NQC_pre[1:dim(qc_muncp_NQC)[1],])
post <- cbind(qc_muncp_NQC, bymNB_mun_NQC_M_iC_post$summary.random$mun_NQC_post[1:dim(qc_muncp_NQC)[1],])

library(leafsync)
library(RColorBrewer)
# color_palette <- colorRampPalette(brewer.pal(9, "Blues"))(100)

sync(mapview(pre, zcol="mean"), 
     mapview(post, zcol="mean"))

mod_tableauPropre(list(bymNB_mun_NQC_M_iC_pre=bymNB_mun_NQC_M_iC_pre,
                  bymNB_mun_NQC_M_iC_post=bymNB_mun_NQC_M_iC_post))

```

demande Nicolas
```{r}
acc_PA_mun_NQC_M$ind_tempo <- ifelse(acc_PA_mun_NQC_M$An %in% c(2020, 2021), "Covid", "autre") 
bymNB_mun_NQC_M_iC_autre <- inla(update(form, . ~ . + f(mun_NQC, model = "bym", graph = W_mun_NQC, scale.model=TRUE) + ind_tempo), 
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mun_NQC_M,
                control.compute = list(dic = TRUE))

summary(bymNB_mun_NQC_M_iC_autre)
stargazer(mod_tableauPropre((list(bymNB_mun_NQC_M_iC_autre=bymNB_mun_NQC_M_iC_autre))), type="text", summary=F)
```

## 1.2 NPQ
## Rendre l'effet nqp par année et par région
```{r}
library(haven)
qc_npi <- read_dta("C:/Users/edgar/Downloads/QCnPI with 3 dimensions_2020_2022.dta")

qc_npq_moy <- qc_npi %>% group_by(Region, Year) %>% summarise(avg_CP1 = mean(CovidPolicy1), avg_CP2=mean(CovidPolicy2))
plot_avg_CP1 <- ggplot(qc_npq_moy, aes(x = as.factor(Year), y = avg_CP1, fill = as.factor(Year))) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~ Region) +
  labs(title = "Average CP1 per Year by Region",
       x = "Year",
       y = "Average CP1",
       fill = "Year") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
plot_avg_CP1

plot_avg_CP2 <- ggplot(qc_npq_moy, aes(x = as.factor(Year), y = avg_CP2, fill = as.factor(Year))) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~ Region) +
  labs(title = "Average CP2 per Year by Region",
       x = "Year",
       y = "Average CP1",
       fill = "Year") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
plot_avg_CP2

df <- data.frame(Year=2014:2022)
n <- dim(df)[1] + length(unique(qc_npq_moy$Region))
n_An <- dim(df)[1]
compteur=1
qc_npq_moy_sep <- qc_npq_moy %>%
  group_by(Region) %>%
  group_split()
df_complet <- data.frame(Region = rep(NA, n), Year = rep(NA, n), avg_CP1 = rep(NA, n), avg_CP2 = rep(NA, n))

for (i in qc_npq_moy_sep) {
  temp <- right_join(i, df)
  temp[, 1] <- apply(temp[, 1], 2, function(x) zoo::na.locf(x, na.rm = FALSE, fromLast = F))
  temp$avg_CP1 <- ifelse(is.na(temp$avg_CP1), 0, temp$avg_CP1)
  temp$avg_CP2 <- ifelse(is.na(temp$avg_CP2), 0, temp$avg_CP2)
  temp <- temp %>% arrange(Year)
  df_complet[((compteur-1)*n_An+1):((compteur)*n_An),] <- temp
  compteur = compteur+1
}
qc_npq_moy <- df_complet

cor(qc_npq_moy %>% filter(Year%in% 2020:2022) %>% .$avg_CP1, qc_npq_moy %>% filter(Year%in% 2020:2022) %>% .$avg_CP2)

qc_npq_moy$YearF <- as.factor(qc_npq_moy$Year)
qc_npq_moy$RegionF <- as.factor(qc_npq_moy$Region)

acc_PA_mun_NQC_M <- left_join(acc_PA_mun_NQC_M, qc_npq_moy, join_by(CD_RA==RegionF, An==YearF))
acc_PA_mun_NQC_G <- left_join(acc_PA_mun_NQC_G, qc_npq_moy, join_by(CD_RA==RegionF, An==YearF))
acc_PA_mun_NQC_L <- left_join(acc_PA_mun_NQC_L, qc_npq_moy, join_by(CD_RA==RegionF, An==YearF))
acc_PA_mun_NQC_GM <- left_join(acc_PA_mun_NQC_GM, qc_npq_moy, join_by(CD_RA==RegionF, An==YearF))
acc_PA_mrc_NQC_M <- left_join(acc_PA_mrc_NQC_M, qc_npq_moy, join_by(CD_RA==RegionF, An==YearF))
acc_PA_mrc_NQC_G <- left_join(acc_PA_mrc_NQC_G, qc_npq_moy, join_by(CD_RA==RegionF, An==YearF))
acc_PA_mrc_NQC_L <- left_join(acc_PA_mrc_NQC_L, qc_npq_moy, join_by(CD_RA==RegionF, An==YearF))
acc_PA_mrc_NQC_GM <- left_join(acc_PA_mrc_NQC_GM, qc_npq_moy, join_by(CD_RA==RegionF, An==YearF))

qc_npq_moy_plot <- left_join(qc_npq_moy %>% filter(Year%in% 2020:2022), acc_PA_mun_M %>% select(CD_RA, `Abréviation courante`) %>% distinct(CD_RA, .keep_all = T), join_by(RegionF==CD_RA))


# fig: indice npq ####
ggplot(qc_npq_moy_plot, aes(x = as.factor(Year), y = avg_CP1, fill = as.factor(Year))) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~ `Abréviation courante`) +
  labs(
    #title = "Indice des interventions liées à la COVID-19 par année et par région administrative",
    x = "Année",
    y = "Indice des interventions COVID",
    fill = "Année"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_blank(), # Removes x-axis tick labels
    strip.text = element_text(face = "bold"), # Makes facet titles bold
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14)
  )


```

```{r}
bymNB_mun_NQC_M_npq <- inla(update(form, . ~ . + avg_CP1 + f(mun_NQC, model = "bym", graph = W_mun_NQC, scale.model=TRUE)), 
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mun_NQC_M,
                control.compute = list(dic = TRUE))
bymNB_mrc_NQC_M_npq <- inla(update(form, . ~ . + avg_CP1 + f(mrc_NQC, model = "bym", graph = W_mrc_NQC, scale.model=TRUE)), 
                family = "nbinomial",
                E = `nombreAccidents_VKT`,
                data = acc_PA_mrc_NQC_M,
                control.compute = list(dic = TRUE))
bymNB_mun_NQC_G_npq <- inla(update(form, . ~ . + avg_CP1 + f(mun_NQC, model = "bym", graph = W_mun_NQC, scale.model=TRUE)), 
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mun_NQC_G,
                control.compute = list(dic = TRUE))
bymNB_mrc_NQC_G_npq <- inla(update(form, . ~ . + avg_CP1 + f(mrc_NQC, model = "bym", graph = W_mrc_NQC, scale.model=TRUE)), 
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mrc_NQC_G,
                control.compute = list(dic = TRUE))
bymNB_mun_NQC_GM_npq <- inla(update(form, . ~ . + avg_CP1 + f(mun_NQC, model = "bym", graph = W_mun_NQC, scale.model=TRUE)), 
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mun_NQC_GM,
                control.compute = list(dic = TRUE))
bymNB_mrc_NQC_GM_npq <- inla(update(form, . ~ . + avg_CP1 + f(mrc_NQC, model = "bym", graph = W_mrc_NQC, scale.model=TRUE)), 
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mrc_NQC_GM,
                control.compute = list(dic = TRUE))
bymNB_mun_NQC_L_npq <- inla(update(form, . ~ . + avg_CP1 + f(mun_NQC, model = "bym", graph = W_mun_NQC, scale.model=TRUE)), 
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mun_NQC_L,
                control.compute = list(dic = TRUE))
bymNB_mrc_NQC_L_npq <- inla(update(form, . ~ . + avg_CP1 + f(mrc_NQC, model = "bym", graph = W_mrc_NQC, scale.model=TRUE)), 
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mrc_NQC_L,
                control.compute = list(dic = TRUE))

mods_npq <- list(
  bymNB_mun_NQC_M_npq=bymNB_mun_NQC_M_npq,
  # bymNB_mrc_NQC_M_npq=bymNB_mrc_NQC_M_npq,
  bymNB_mun_NQC_G_npq=bymNB_mun_NQC_G_npq,
  # bymNB_mrc_NQC_G_npq=bymNB_mrc_NQC_G_npq,
  bymNB_mun_NQC_GM_npq=bymNB_mun_NQC_GM_npq,
  # bymNB_mrc_NQC_GM_npq=bymNB_mrc_NQC_GM_npq,
  bymNB_mun_NQC_L_npq=bymNB_mun_NQC_L_npq)
  # bymNB_mrc_NQC_L_npq=bymNB_mrc_NQC_L_npq)

# extractDIC(vctrs::vec_c(mods_npq))
# 
# stargazer(compaVar("iC", extractDIC(vctrs::vec_c(mods_iC, mods_npq), round = 2)), type="text", rownames=F, summary=F)
# stargazer(compaVar("iC", extractDIC(vctrs::vec_c(mods, mods_npq), round = 2)), type="text", rownames=F, summary=F)
# 
#   stargazer(mod_tableauPropre(list(bymNB_mun_NQC_M=bymNB_mun_NQC_M,
#                                  bymNB_mun_NQC_M_npq=bymNB_mun_NQC_M_npq), difSignificativité = T), type="text", summary=F, rownames=F)
#   
#   
#   stargazer(mod_tableauPropre(list(bymNB_mun_NQC_G=bymNB_mun_NQC_G,
#                                    bymNB_mun_NQC_G_npq=bymNB_mun_NQC_G_npq), difSignificativité = T), type="text", summary=F, rownames=F)
#   
#   stargazer(mod_tableauPropre(list(bymNB_mun_NQC_L=bymNB_mun_NQC_L,
#                                    bymNB_mun_NQC_L_npq=bymNB_mun_NQC_L_npq), difSignificativité = T), type="text", summary=F, rownames=F)
#   
#   stargazer(mod_tableauPropre(list(bymNB_mun_NQC_GM=bymNB_mun_NQC_GM,
#                                    bymNB_mun_NQC_GM_npq=bymNB_mun_NQC_GM_npq), difSignificativité = T), type="text", summary=F, rownames=F)
#   
# 
# stargazer(mod_tableauPropre(mods_npq), type="text", summary=F, rownames=F)


# tab: coefs ind_CP1
stargazer(mod_tableauPropre(mods_npq) %>% filter(
  Coefficients %in% c("Gravité", "avg_CP1") | is.na(Coefficients)) %>% mutate(across(everything(), ~replace(., . == "avg_CP1", "ind_intervCOVID19"))
  ), type="latex", summary=F, rownames=F)

bymNB_mrc_NQC_M_npq$summary.fixed[13,]
inla.pmarginal(0, bymNB_mrc_NQC_M_npq$marginals.fixed$avg_CP1)
inla.qmarginal(0.025, bymNB_mrc_NQC_M_npq$marginals.fixed$avg_CP1)
inla.qmarginal(0.975, bymNB_mrc_NQC_M_npq$marginals.fixed$avg_CP1)
inla.qmarginal(0.127, bymNB_mrc_NQC_M_npq$marginals.fixed$avg_CP1)

```
On confirme le retrait de G+M

```{r}
mods_mun_iCvsNpq <-  list(
  bymNB_mun_NQC_M_iC=bymNB_mun_NQC_M_iC,
  bymNB_mun_NQC_M_npq=bymNB_mun_NQC_M_npq,
  bymNB_mun_NQC_G_iC=bymNB_mun_NQC_G_iC,
  bymNB_mun_NQC_G_npq=bymNB_mun_NQC_G_npq,
  bymNB_mun_NQC_L_iC=bymNB_mun_NQC_L_iC,
  bymNB_mun_NQC_L_npq=bymNB_mun_NQC_L_npq)

stargazer(compaVar("iC", extractDIC(vctrs::vec_c(mods_mun_iCvsNpq), round = 2), bestFam = F), type="text", summary=F, rownames = F)
stargazer(mod_tableauPropre(mods_mun_iCvsNpq), type="text", summary=F, rownames=F)
```
Les coefficients sont quasiment identiques! Meilleur DIC avec iC. donc nous ne continuerons qu'avec iC!

## 1.3 - Modèles spatio-temporels

### Bernardinelli
$$
\omega: \text{Tendance globale linéaire} \\
t_j: \text{temps j} \\
\delta_i: \text{tendance différentielle, indique à quel point la tendance temporelle de la région i diffère de la tendance globale }\\  \omega.
$$
$$
log(\theta_{ij})= \boldsymbol{\beta X} + b_i + \nu_i + (\omega*\text{indCovid}_{i,j} + \delta_i) * t_j
$$

Inclure l'indicateur covid temporel!

```{r}
mun_NQC_pre <- mun_NQC
mun_NQC_post <- mun_NQC
mun_NQC_2 <- mun_NQC
mrc_NQC_pre <- mrc_NQC
mrc_NQC_post <- mrc_NQC
mrc_NQC_2 <- mrc_NQC

annee_mun <- as.numeric(as.character(acc_PA_mun_NQC_M$An)) + 1 - min(as.numeric(as.character(acc_PA_mun_NQC_M$An)))
annee_mrc <- as.numeric(as.character(acc_PA_mrc_NQC_M$An)) + 1 - min(as.numeric(as.character(acc_PA_mrc_NQC_M$An)))

annee_mun_pre <- ifelse(acc_PA_mun_NQC_M$ind_covid=="Pre-Covid", annee_mun, 0)
annee_mun_post <- ifelse(acc_PA_mun_NQC_M$ind_covid=="Post-Covid", annee_mun, 0) 

annee_mrc_pre <- ifelse(acc_PA_mrc_NQC_M$ind_covid=="Pre-Covid", annee_mrc, 0)
annee_mrc_post <- ifelse(acc_PA_mrc_NQC_M$ind_covid=="Post-Covid", annee_mrc, 0) 


cor(annee_mun, as.numeric(acc_PA_mun_NQC_M$ind_covid))
cor(annee_mrc, as.numeric(acc_PA_mrc_NQC_M$ind_covid))
cor(annee_mrc, as.numeric(acc_PA_mrc_NQC_M$avg_CP1))
```

#### Entraînements des modèles
```{r}
bernarNB_mun_NQC_M_iC_interac <- inla(update(form, . ~ . + 
                                               f(mun_NQC, model = "bym", graph = W_mun_NQC, scale.model=TRUE) + 
                                               f(mun_NQC_pre, annee_mun_pre, model = "iid") + 
                                               f(mun_NQC_post, annee_mun_post, model = "iid") + 
                                               annee_mun:ind_covid), 
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mun_NQC_M,
                control.compute = list(dic = TRUE))

bernarNB_mun_NQC_M_iC_interac_2 <- inla(update(form, . ~ . + 
                                               f(mun_NQC, model = "bym", graph = W_mun_NQC, scale.model=TRUE) + 
                                               f(mun_NQC_2, annee_mun_pre, model = "iid") + 
                                        
                                               annee_mun:ind_covid), 
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mun_NQC_M,
                control.compute = list(dic = TRUE))
summary(bernarNB_mun_NQC_M_iC_interac_2)

bernarNB_mun_NQC_M_iC_interac_plein <- inla(update(form, . ~ . + 
                                               f(mun_NQC, model = "bym", graph = W_mun_NQC, scale.model=TRUE) + 
                                               f(mun_NQC_pre, annee_mun_pre, model = "iid") + 
                                               f(mun_NQC_post, annee_mun_post, model = "iid") + 
                                               annee_mun*ind_covid), 
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mun_NQC_M,
                control.compute = list(dic = TRUE))


bernarNB_mun_NQC_M_iC <- inla(update(form, . ~ . + ind_covid + 
                                       f(mun_NQC, model = "bym", graph = W_mun_NQC, scale.model=TRUE) +
                                       f(mun_NQC_2, annee_mun, model = "iid") + 
                                       annee_mun), 
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mun_NQC_M,
                control.compute = list(dic = TRUE))
bernarNB_mun_NQC_G_iC_interac <- inla(update(form, . ~ . + f(mun_NQC, model = "bym", graph = W_mun_NQC, scale.model=TRUE) + f(mun_NQC_pre, annee_mun_pre, model = "iid") + f(mun_NQC_post, annee_mun_post, model = "iid") + annee_mun:ind_covid), 
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mun_NQC_G,
                control.compute = list(dic = TRUE))
bernarNB_mun_NQC_G_iC <- inla(update(form, . ~ . + ind_covid + f(mun_NQC, model = "bym", graph = W_mun_NQC, scale.model=TRUE) + f(mun_NQC_2, annee_mun, model = "iid") + annee_mun), 
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mun_NQC_G,
                control.compute = list(dic = TRUE))
bernarNB_mun_NQC_L_iC_interac <- inla(update(form, . ~ . + f(mun_NQC, model = "bym", graph = W_mun_NQC, scale.model=TRUE) + f(mun_NQC_pre, annee_mun_pre, model = "iid") + f(mun_NQC_post, annee_mun_post, model = "iid") + annee_mun:ind_covid), 
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mun_NQC_L,
                control.compute = list(dic = TRUE))
bernarNB_mun_NQC_L_iC <- inla(update(form, . ~ . + ind_covid + f(mun_NQC, model = "bym", graph = W_mun_NQC, scale.model=TRUE) + f(mun_NQC_2, annee_mun, model = "iid") + annee_mun), 
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mun_NQC_L,
                control.compute = list(dic = TRUE))
```


```{r}
bernarNB_mrc_NQC_M_iC_interac <- inla(update(form, . ~ . + f(mrc_NQC, model = "bym", graph = W_mrc_NQC, scale.model=TRUE) + f(mrc_NQC_pre, annee_mrc_pre, model = "iid") + f(mrc_NQC_post, annee_mrc_post, model = "iid") + annee_mrc:ind_covid), 
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mrc_NQC_M,
                control.compute = list(dic = TRUE))
summary(bernarNB_mrc_NQC_M_iC_interac)

# test <- inla(nombreAccidents ~ f(mrc_NQC, model = "bym", graph = W_mrc_NQC, scale.model=TRUE) + f(mrc_NQC_pre, annee_mrc_pre, model = "iid") + f(mrc_NQC_post, annee_mrc_post, model = "iid") + annee_mrc_pre + annee_mrc_post, 
#                 family = "nbinomial",
#                 E=`nombreAccidents_VKT`,
#                 data = acc_PA_mrc_NQC_M,
#                 control.compute = list(dic = TRUE))
# summary(test)

bernarNB_mrc_NQC_M_iC <- inla(update(form, . ~ . + ind_covid + f(mrc_NQC, model = "bym", graph = W_mrc_NQC, scale.model=TRUE) + f(mrc_NQC_2, annee_mrc, model = "iid") + annee_mrc), 
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mrc_NQC_M,
                control.compute = list(dic = TRUE))
bernarNB_mrc_NQC_G_iC_interac <- inla(update(form, . ~ . + f(mrc_NQC, model = "bym", graph = W_mrc_NQC, scale.model=TRUE) + f(mrc_NQC_pre, annee_mrc_pre, model = "iid") + f(mrc_NQC_post, annee_mrc_post, model = "iid") + annee_mrc:ind_covid), 
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mrc_NQC_G,
                control.compute = list(dic = TRUE))
bernarNB_mrc_NQC_G_iC <- inla(update(form, . ~ . + ind_covid + f(mrc_NQC, model = "bym", graph = W_mrc_NQC, scale.model=TRUE) + f(mrc_NQC_2, annee_mrc, model = "iid") + annee_mrc), 
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mrc_NQC_G,
                control.compute = list(dic = TRUE))
bernarNB_mrc_NQC_L_iC_interac <- inla(update(form, . ~ . + f(mrc_NQC, model = "bym", graph = W_mrc_NQC, scale.model=TRUE) + f(mrc_NQC_pre, annee_mrc_pre, model = "iid") + f(mrc_NQC_post, annee_mrc_post, model = "iid") + annee_mrc:ind_covid), 
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mrc_NQC_L,
                control.compute = list(dic = TRUE))
bernarNB_mrc_NQC_L_iC <- inla(update(form, . ~ . + ind_covid + f(mrc_NQC, model = "bym", graph = W_mrc_NQC, scale.model=TRUE) + f(mrc_NQC_2, annee_mrc, model = "iid") + annee_mrc), 
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mrc_NQC_L,
                control.compute = list(dic = TRUE))

mods_mun_bernar <- list(
  bernarNB_mun_NQC_M_iC=bernarNB_mun_NQC_M_iC,
  bernarNB_mun_NQC_M_iC_interac=bernarNB_mun_NQC_M_iC_interac,
  bernarNB_mun_NQC_M_iC_interac_plein=bernarNB_mun_NQC_M_iC_interac_plein,
  bernarNB_mun_NQC_G_iC=bernarNB_mun_NQC_G_iC,
  bernarNB_mun_NQC_G_iC_interac=bernarNB_mun_NQC_G_iC_interac,
  bernarNB_mun_NQC_L_iC=bernarNB_mun_NQC_L_iC,
  bernarNB_mun_NQC_L_iC_interac=bernarNB_mun_NQC_L_iC_interac)

mods_mrc_bernar <- list(
  bernarNB_mrc_NQC_M_iC=bernarNB_mrc_NQC_M_iC,
  bernarNB_mrc_NQC_M_iC_interac=bernarNB_mrc_NQC_M_iC_interac,
  bernarNB_mrc_NQC_G_iC=bernarNB_mrc_NQC_G_iC,
  bernarNB_mrc_NQC_G_iC_interac=bernarNB_mrc_NQC_G_iC_interac,
  bernarNB_mrc_NQC_L_iC=bernarNB_mrc_NQC_L_iC,
  bernarNB_mrc_NQC_L_iC_interac=bernarNB_mrc_NQC_L_iC_interac)


extractDIC(vctrs::vec_c(mods_mun_bernar))

stargazer(compaVar("Interaction", extractDIC(vctrs::vec_c(mods_mun_bernar)), bestFam = F), type="text", summary=F, rownames = F)

stargazer(mod_tableauPropre(mods_mun_bernar), type="text", summary=F, rownames=F)

summary(bernarNB_mun_NQC_M_iC_interac)
extractDIC(vctrs::vec_c(mods_mrc_bernar))

stargazer(compaVar("Interaction", extractDIC(vctrs::vec_c(mods_mun_bernar, mods_mrc_bernar)), bestFam = F), type="text", summary=F, rownames = F)

stargazer(mod_tableauPropre(mods_mrc_bernar), type="text", summary=F, rownames=F)



# tab: coefs bernar ####
stargazer(mod_tableauPropre(list(
  bernarNB_mun_NQC_M_iC_interac=bernarNB_mun_NQC_M_iC_interac,
  bernarNB_mun_NQC_G_iC_interac=bernarNB_mun_NQC_G_iC_interac,
  bernarNB_mun_NQC_L_iC_interac=bernarNB_mun_NQC_L_iC_interac)) %>% filter(
  Coefficients %in% c("Gravité", "annee_mun:ind_covidPre-Covid", "annee_mun:ind_covidPost-Covid") | is.na(Coefficients)) %>% mutate(across(everything(), ~replace(., . == "annee_mun", "année"))), type="latex", summary=F, rownames=F)


summary(bernarNB_mun_NQC_M_iC_interac)

# stargazer(mod_tableauPropre(list(
#   bernarNB_mun_NQC_M_iC_interac=bernarNB_mun_NQC_M_iC_interac,
#   bymNB_mun_NQC_M = bymNB_mun_NQC_M), difSignificativité = T), type="text", summary=F, rownames=F)
# 
# stargazer(mod_tableauPropre(list(
#   bernarNB_mun_NQC_G_iC_interac=bernarNB_mun_NQC_G_iC_interac,
#   bymNB_mun_NQC_G = bymNB_mun_NQC_G), difSignificativité = T), type="text", summary=F, rownames=F)
# 
# stargazer(mod_tableauPropre(list(
#   bernarNB_mun_NQC_L_iC_interac=bernarNB_mun_NQC_L_iC_interac,
#   bymNB_mun_NQC_L = bymNB_mun_NQC_L), difSignificativité = T), type="text", summary=F, rownames=F)


stargazer(compaVar("Interaction", extractDIC(list(
  bernarNB_mun_NQC_M_iC_interac=bernarNB_mun_NQC_M_iC_interac,
  bernarNB_mun_NQC_M_iC=bernarNB_mun_NQC_M_iC,
  bernarNB_mun_NQC_M_iC_interac=bernarNB_mun_NQC_M_iC_interac,
  bernarNB_mun_NQC_M_iC=bernarNB_mun_NQC_M_iC,
  bernarNB_mun_NQC_L_iC_interac=bernarNB_mun_NQC_L_iC_interac,
  bernarNB_mun_NQC_L_iC=bernarNB_mun_NQC_L_iC
)), bestFam = F), type="text", summary=F, rownames = F)

bernarNB_mun_NQC_M_iC_interac$summary.fixed[13:14,]
bernarNB_mun_NQC_G_iC_interac$summary.fixed[13:14,]
bernarNB_mun_NQC_L_iC_interac$summary.fixed[13:14,]

```
DIC très très semblables! On ne trouve pas réellement de meilleurs modèles. donc restons avec le modèle plus simple. Les coefficients signifs sont identiques!

Intéressant: Les pentes pour accidents mortels, bien que non significatives, sont els seules à s'inverser avec la COVID. De plus, ind_covid pour mortel reste positif, mais grave l'y rejoint... mais bon, non signifs!

#### Carte
```{r}
fV_carte(acc_PA_mrc_NQC_M, bernarNB_mrc_NQC_M_iC$summary.fitted.values, qc_mrc_NQC, nrow=2)
sum(bernarNB_mrc_NQC_M_iC$summary.fitted.values$mean)

sum(bernarNB_mrc_NQC_M_iC$summary.fitted.values$mean * acc_PA_mrc_NQC_M$nombreAccidents_VKT)

# Effets aléatoires spatiaux
fV_carte(acc_PA_mrc_NQC_M %>% filter(An==2021), bernarNB_mrc_NQC_M_iC$summary.random$mrc_NQC[1:length(unique(mrc_NQC)),], qc_mrc_NQC, id = "X2021", titre = "Effets aléatoires spatiaux")

# Effets temporels
tempo_pre <- tibble(ind_covid="Pre-Covid", effetTempo=bernarNB_mrc_NQC_M_iC_interac$summary.fixed$mean[13] + bernarNB_mrc_NQC_M_iC_interac$summary.random$mrc_NQC_pre$mean + bernarNB_mrc_NQC_M_iC$summary.random$mrc_NQC$mean[1:length(unique(mrc_NQC))])

tempo_post <- tibble(ind_covid="Post-Covid", effetTempo=bernarNB_mrc_NQC_M_iC_interac$summary.fixed$mean[14] + bernarNB_mrc_NQC_M_iC_interac$summary.random$mrc_NQC_post$mean + bernarNB_mrc_NQC_M_iC$summary.random$mrc_NQC$mean[1:length(unique(mrc_NQC))])

tempo <- rbind(tempo_pre, tempo_post)

# colnames(tempo_pre)
# colnames(tempo_post)

jdDCarte <- acc_PA_mrc_NQC_M %>% filter(An %in% c(2021, 2022)) %>% arrange(An, CD_MRC)
jdDCarte2 <- st_sf(cbind(rbind(qc_mrc_NQC, qc_mrc_NQC), tempo))
tm_shape(jdDCarte2) +
  tm_fill("effetTempo",
          id="effetTempo", , palette= viridis::viridis(10), n = 10) +
  tm_facets(by="ind_covid", free.scales = T, nrow=1) +
  tm_borders(lwd = 0.3, alpha = 0.4) +
  tm_layout(panel.labels = c("Pré-Covid", "Post-Covid"))


# Effets temporels
tempo_pre <- tibble(ind_covid="Pre-Covid", effetTempo=bernarNB_mrc_NQC_M_iC_interac$summary.random$mrc_NQC_pre$mean)
# bernarNB_mrc_NQC_M_iC_interac$summary.fixed$mean[13] + 
tempo_post <- tibble(ind_covid="Post-Covid", effetTempo= bernarNB_mrc_NQC_M_iC_interac$summary.random$mrc_NQC_post$mean)
# bernarNB_mrc_NQC_M_iC_interac$summary.fixed$mean[14] + 
tempo <- rbind(tempo_pre, tempo_post)


jdDCarte <- acc_PA_mrc_NQC_M %>% filter(An %in% c(2021, 2022)) %>% arrange(An, CD_MRC)
jdDCarte2 <- st_sf(cbind(rbind(qc_mrc_NQC, qc_mrc_NQC), tempo))

tm_shape(jdDCarte2) +
  tm_fill("effetTempo",
          id="effetTempo", n=10, palette = ) +
  tm_facets(by="ind_covid", free.scales = T, nrow = 1) +
  tm_borders(lwd = 0.3, alpha = 0.4) +
  tm_layout(panel.labels = c("Pré-Covid", "Post-Covid"))

```


### Knorr-Held

```{r}
annee_mrc_2 <- annee_mrc
mrcAnnee <- 1:dim(acc_PA_mrc_NQC_M)[1]

annee_mun_2 <- annee_mun
munAnnee <- 1:dim(acc_PA_mun_NQC_M)[1]
```


```{r}
KH_NB_mun_NQC_M <- inla(update(form, . ~ . + 
                          f(mun_NQC, model = "bym", graph = W_mun_NQC, scale.model=TRUE)  + 
                          f(annee_mun, model = "rw1") + 
                          f(annee_mun_2, model = "iid") + 
                          f(munAnnee, model = "iid")),
                family = "nbinomial",
                E = `nombreAccidents_VKT`,
                data = acc_PA_mun_NQC_M,
                control.compute = list(dic = TRUE))
KH_NB_mun_NQC_G <- inla(update(form, . ~ . + 
                          f(mun_NQC, model = "bym", graph = W_mun_NQC, scale.model=TRUE)  + 
                          f(annee_mun, model = "rw1") + 
                          f(annee_mun_2, model = "iid") + 
                          f(munAnnee, model = "iid")),
                family = "nbinomial",
                E = `nombreAccidents_VKT`,
                data = acc_PA_mun_NQC_G,
                control.compute = list(dic = TRUE))
KH_NB_mun_NQC_L <- inla(update(form, . ~ . + 
                          f(mun_NQC, model = "bym", graph = W_mun_NQC, scale.model=TRUE)  + 
                          f(annee_mun, model = "rw1") + 
                          f(annee_mun_2, model = "iid") + 
                          f(munAnnee, model = "iid")),
                family = "nbinomial",
                E = `nombreAccidents_VKT`,
                data = acc_PA_mun_NQC_L,
                control.compute = list(dic = TRUE))

KH_NB_mrc_NQC_M <- inla(update(form, . ~ . + 
                          f(mrc_NQC, model = "bym", graph = W_mrc_NQC, scale.model=TRUE)  + 
                          f(annee_mrc, model = "rw1") + 
                          f(annee_mrc_2, model = "iid") + 
                          f(mrcAnnee, model = "iid")),
                family = "nbinomial",
                E = `nombreAccidents_VKT`,
                data = acc_PA_mrc_NQC_M,
                control.compute = list(dic = TRUE))
KH_NB_mrc_NQC_G <- inla(update(form, . ~ . + 
                          f(mrc_NQC, model = "bym", graph = W_mrc_NQC, scale.model=TRUE)  + 
                          f(annee_mrc, model = "rw1") + 
                          f(annee_mrc_2, model = "iid") + 
                          f(mrcAnnee, model = "iid")),
                family = "nbinomial",
                E = `nombreAccidents_VKT`,
                data = acc_PA_mrc_NQC_G,
                control.compute = list(dic = TRUE))

KH_NB_mrc_NQC_L <- inla(update(form, . ~ . + 
                          f(mrc_NQC, model = "bym", graph = W_mrc_NQC, scale.model=TRUE)  + 
                          f(annee_mrc, model = "rw1") + 
                          f(annee_mrc_2, model = "iid") + 
                          f(mrcAnnee, model = "iid")),
                family = "nbinomial",
                E = `nombreAccidents_VKT`,
                data = acc_PA_mrc_NQC_L,
                control.compute = list(dic = TRUE))


mods_KH <- list(KH_NB_mun_NQC_M=KH_NB_mun_NQC_M,
                # KH_NB_mrc_NQC_M=KH_NB_mrc_NQC_M,
                KH_NB_mun_NQC_G=KH_NB_mun_NQC_G,
                # KH_NB_mrc_NQC_G=KH_NB_mrc_NQC_G,
                KH_NB_mun_NQC_L=KH_NB_mun_NQC_L)
                # KH_NB_mrc_NQC_L=KH_NB_mrc_NQC_L)


stargazer(mod_tableauPropre(mods_KH), type="text", summary=F, rownames=F)

stargazer(mod_tableauPropre(list(
  KH_NB_mun_NQC_M=KH_NB_mun_NQC_M,
  bymNB_mun_NQC_M=bymNB_mun_NQC_M), difSignificativité = T), type="text", summary=F, rownames=F)

stargazer(mod_tableauPropre(list(
  KH_NB_mun_NQC_G=KH_NB_mun_NQC_G,
  bymNB_mun_NQC_G=bymNB_mun_NQC_G), difSignificativité = T), type="text", summary=F, rownames=F)

stargazer(mod_tableauPropre(list(
  KH_NB_mun_NQC_L=KH_NB_mun_NQC_L,
  bymNB_mun_NQC_L=bymNB_mun_NQC_L), difSignificativité = T), type="text", summary=F, rownames=F)

compaVar("Modèle", extractDIC(vctrs::vec_c(mods_KH, 
                                           list(
                                          bymNB_mun_NQC_M=bymNB_mun_NQC_M, bymNB_mun_NQC_G=bymNB_mun_NQC_G, bymNB_mun_NQC_L=bymNB_mun_NQC_L
                                          ))))


# 
# fV_carte(acc_PA_mun_NQC_M[which(acc_PA_mun_NQC_M$An %in% c(2017, 2018, 2019, 2020, 2021, 2022)),], KH_NB_mun_NQC_M$summary.fitted.values[which(acc_PA_mun_NQC_M$An %in% c(2017, 2018, 2019, 2020, 2021, 2022)),], qc_muncp_NQC, scales = F)
# 
# #acc_PA_mun_NQC_M$nombreAccidents_VKT[which(acc_PA_mun_NQC_M$An==2020)]
# # mapview(qc_muncp_NQC)
# 

y=NULL
y_min=NULL
y_max=NULL
Région <- NULL
Gravité <- NULL
for (i in names(mods_KH)){
  reg_temp <- ifelse(grepl("mun", i), "Munic.", "MRC")
  Gravité <- c(Gravité,
                   ifelse(grepl("_M", i), "Mortel",
                          ifelse(grepl("_GM", i), "Grave + Mortel",
                                 ifelse(grepl("_L", i), "Léger",
                                        ifelse(grepl("_G", i), "Grave", "")))))
  Région <- c(Région, reg_temp)
  if (reg_temp=="Munic."){
    temp_y=mods_KH[[i]]$summary.random$annee_mun$mean + mods_KH[[i]]$summary.random$annee_mun_2$mean
    temp_y_min <- mods_KH[[i]]$summary.random$annee_mun$`0.025quant` + mods_KH[[i]]$summary.random$annee_mun_2$`0.025quant`
    temp_y_max <- mods_KH[[i]]$summary.random$annee_mun$`0.975quant` + mods_KH[[i]]$summary.random$annee_mun_2$`0.975quant`
    }

  else {
    temp_y=mods_KH[[i]]$summary.random$annee_mrc$mean + mods_KH[[i]]$summary.random$annee_mrc_2$mean
    temp_y_min <- mods_KH[[i]]$summary.random$annee_mrc$`0.025quant` + mods_KH[[i]]$summary.random$annee_mrc_2$`0.025quant`
    temp_y_max <- mods_KH[[i]]$summary.random$annee_mrc$`0.975quant` + mods_KH[[i]]$summary.random$annee_mrc_2$`0.975quant`
    }
  y = c(y, temp_y)
  y_min = c(y_min, temp_y_min)
  y_max = c(y_max, temp_y_max)
}


Gravité  <- rep(Gravité, each=9)
Région  <- rep(Région, each=9)
x=rep(2014:2022,6)
df <- data.frame(Gravité, Région, x,y, y_min, y_max)
df$Gravité <- factor(df$Gravité, levels = c("Mortel", "Grave", "Léger"))
df$Région <- factor(df$Région, levels = c("Munic.", "MRC"))


p1 <- ggplot(df %>% filter(Région=="Munic."), aes(x = x, y = y)) +
  geom_point(size = 3, color = "steelblue") +
  geom_line(color = "steelblue") +
  # geom_errorbar(aes(ymin = y_min, ymax = y_max), width = 0.2, color = "darkred") +
  facet_wrap(~ Région+Gravité, scales = "free_y") +
  labs(x = "Année", y = "Sommes des effets aléatoires temporels", title = "Effets aléatoires sommés temporels par année et gravité") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14)
  )

p2 <- ggplot(df %>% filter(Région=="Munic."), aes(x = x, y = y)) +
  geom_point(size = 3, color = "steelblue") +
  geom_line(color = "steelblue") +
  geom_errorbar(aes(ymin = y_min, ymax = y_max), width = 0.2, color = "darkred") +
  facet_wrap(~ Région+Gravité, scales = "free_y") +
  labs(x = "Année", y = "Sommes des effets aléatoires temporels", title = "Effets aléatoires temporels sommés par année et gravité (avec intervalle de crédibilité)") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14)
  )

library(ggpubr)
ggarrange(p1, p2, nrow=2)

# temp <- tibble(An = as.factor(2014:2022), tempEffAlea = KH_NB_mun_NQC_M$summary.random$annee_mun$mean + KH_NB_mun_NQC_M$summary.random$annee_mun_2$mean)
# temp2<-left_join(acc_PA_mun_NQC_G, temp)

# summary(abs(temp2$tempEffAlea/KH_NB_mun_NQC_M$summary.linear.predictor$mean))
# mean(abs(temp2$tempEffAlea/KH_NB_mun_NQC_G$summary.linear.predictor$mean))
# mean(abs(temp2$tempEffAlea/KH_NB_mun_NQC_L$summary.linear.predictor$mean))
```

Knorr-Held ne sert pas à grand chose rendu là! Pas d'indicateur Covid rien. mis à part peut-être confirmer que les années post-covid sont vraiment spécial

## 1.4 PM 

```{r}
mois <- 1:dim(acc_PM_mrc_NQC_M)[1]

bymNB_mrc_NQC_M_iC_mois <- inla(update(form, . ~ . + ind_covid +
                                f(mrc_PM_NQC, model = "bym", graph = W_mrc, scale.model=TRUE) + 
                                f(mois, model="seasonal", season.length=12)), 
                family = "nbinomial",
                E = nombreAccidents_VKT,
                data = acc_PM_mrc_NQC_M,
                control.compute = list(dic = TRUE))

bymNB_mrc_NQC_G_iC_mois <- inla(update(form, . ~ . + ind_covid +
                                f(mrc_PM_NQC, model = "bym", graph = W_mrc, scale.model=TRUE) + 
                                f(mois, model="seasonal", season.length=12)), 
                family = "nbinomial",
                E = nombreAccidents_VKT,
                data = acc_PM_mrc_NQC_G,
                control.compute = list(dic = TRUE))

bymNB_mrc_NQC_L_iC_mois <- inla(update(form, . ~ . + ind_covid +
                                f(mrc_PM_NQC, model = "bym", graph = W_mrc, scale.model=TRUE) + 
                                f(mois, model="seasonal", season.length=12)), 
                family = "nbinomial",
                E = nombreAccidents_VKT,
                data = acc_PM_mrc_NQC_L,
                control.compute = list(dic = TRUE))


mods_PAPM <- list(
  bymNB_mrc_NQC_M_iC=bymNB_mrc_NQC_M_iC,
  bymNB_mrc_NQC_M_iC_mois=bymNB_mrc_NQC_M_iC_mois,
  bymNB_mrc_NQC_G_iC=bymNB_mrc_NQC_G_iC,
  bymNB_mrc_NQC_G_iC_mois=bymNB_mrc_NQC_G_iC_mois,
  bymNB_mrc_NQC_L_iC=bymNB_mrc_NQC_L_iC,
  bymNB_mrc_NQC_L_iC_mois=bymNB_mrc_NQC_L_iC_mois)

# extractDIC(vctrs::vec_c(mods_PAPM))

# stargazer(compaVar("iC", extractDIC(vctrs::vec_c(mods, mods_iC)), bestFam = F), type="text", summary=F, rownames = F)

stargazer(mod_tableauPropre(mods_PAPM) %>% filter(
  !(Coefficients %in% c("Modèle", "Région", "Covid-19", "Distribution", "Exposition", "NQC", "DIC"))), type="text", summary=F, rownames=F)

# pourcVar(bymNB_mrc_NQC_M_iC_mois)
# 
stargazer(mod_tableauPropre(list(
  # bymNB_mun_NQC_M_iC=bymNB_mun_NQC_M_iC,
  bymNB_mrc_NQC_M_iC=bymNB_mrc_NQC_M_iC,
  bymNB_mrc_NQC_M_iC_mois=bymNB_mrc_NQC_M_iC_mois), difSignificativité = T), type="text", summary=F, rownames=F)

stargazer(mod_tableauPropre(list(
  bymNB_mrc_NQC_G_iC=bymNB_mrc_NQC_G_iC,
  bymNB_mrc_NQC_G_iC_mois=bymNB_mrc_NQC_G_iC_mois), difSignificativité = T), type="text", summary=F, rownames=F)

stargazer(mod_tableauPropre(list(
  bymNB_mrc_NQC_L_iC=bymNB_mrc_NQC_L_iC,
  bymNB_mrc_NQC_L_iC_mois=bymNB_mrc_NQC_L_iC_mois), difSignificativité = T), type="text", summary=F, rownames=F)


```


```{r}
length(bymNB_mrc_NQC_M_iC_mois$summary.random$mois$mean)


df <- data.frame(matrix(bymNB_mrc_NQC_M_iC_mois$summary.random$mois$mean, ncol = 10476 / 12, byrow = F)) %>% tibble()
df$id <- 1:nrow(df)
df_long1 <- df %>%
  pivot_longer(cols = -id, names_to = "segment", values_to = "value")
df_long1$ind_covid <- acc_PM_mrc_NQC_M$ind_covid
ggplot(df_long1, aes(x = id, y = value, group = segment)) +
  geom_line() 
# ggplot(df_long1, aes(x = as.factor(id), y = value, group = segment)) +
#   geom_line()+ facet_wrap(~ ind_covid)
ggplot(df_long1, aes(x = as.factor(id), y = value, group = segment)) +
  geom_point() + facet_wrap(~ ind_covid)

df <- acc_PM_mrc_M %>% group_by(Mois, ind_covid) %>% summarise(nbAcc=mean(nombreAccidents))  

#%>% .$nbAcc %>% as.numeric(), nrow=12, byrow = T)) %>% tibble()
# df$id <- 1:nrow(df)
# df_long2 <- df %>%
#   pivot_longer(cols = -id, names_to = "segment", values_to = "value")

ggplot(df, aes(x = Mois, y =nbAcc)) +
  geom_line() + facet_wrap(~ ind_covid)

ggplot(df_long1, aes(x = as.factor(id), y = scale(value))) +
  geom_point() + 
  geom_line(df, mapping=aes(x = Mois, y = scale(nbAcc))) +
  facet_wrap(~ ind_covid) 
```


#### npq
```{r}
qc_npq_moy <- qc_npi %>% group_by(Region, Year, Month) %>% summarise(avg_CP1 = mean(CovidPolicy1))

df <- expand.grid(Year = 2014:2022, Month = 1:12)
n <- dim(df)[1] + length(unique(qc_npq_moy$Region))
n_An <- dim(df)[1]
compteur=1
qc_npq_moy_sep <- qc_npq_moy %>%
  group_by(Region) %>%
  group_split()
df_complet <- data.frame(Region = rep(NA, n), Year = rep(NA, n), Month = rep(NA,n), avg_CP1 = rep(NA, n))

for (i in qc_npq_moy_sep) {
  temp <- right_join(i, df)
  temp[, 1] <- apply(temp[, 1], 2, function(x) zoo::na.locf(x, na.rm = FALSE, fromLast = F))
  temp$avg_CP1 <- ifelse(is.na(temp$avg_CP1), 0, temp$avg_CP1)
  # temp$avg_CP2 <- ifelse(is.na(temp$avg_CP2), 0, temp$avg_CP2)
  temp <- temp %>% arrange(Year, Month)
  df_complet[((compteur-1)*n_An+1):((compteur)*n_An),] <- temp
  compteur = compteur+1
}

qc_npq_moy <- df_complet
qc_npq_moy$YearF <- as.factor(qc_npq_moy$Year)
qc_npq_moy$RegionF <- as.factor(qc_npq_moy$Region)
acc_PM_mrc_NQC_M <- left_join(acc_PM_mrc_NQC_M, qc_npq_moy, join_by(CD_RA==RegionF, An==YearF, Mois==Month))

bymNB_mrc_NQC_M_npq_mois <- inla(update(form, . ~ . + avg_CP1 +
                                f(mrc_PM_NQC, model = "bym", graph = W_mrc, scale.model=TRUE) + 
                                f(mois, model="seasonal", season.length=12)), 
                family = "nbinomial",
                E = nombreAccidents_VKT,
                data = acc_PM_mrc_NQC_M,
                control.compute = list(dic = TRUE))

mod_tableauPropre(list(bymNB_mrc_NQC_M_npq_mois=bymNB_mrc_NQC_M_npq_mois))


```
npq_mois - mortel non significatif


# Q.2 Qu'est-ce qui explique cet effet temporel en 2020


## 3 variables à tester en ajoutant au modèle iC

### Avec logistique

Création de jdD
```{r}
df_logis_M <- data_acc %>% 
  group_by(NO_SEQ_COLL) %>%
  mutate(points=mean(points)) %>%
  ungroup() %>%
  distinct(NO_SEQ_COLL, .keep_all = T) %>%
  select(NO_SEQ_COLL, gravite, DT_ACCDN, an, NB_DECES_PIETON, NB_DECES_MOTO, NB_DECES_VELO, NB_BLESSES_PIETON, NB_BLESSES_MOTO, NB_BLESSES_VELO, VITESSE_AUTOR, points, NB_VEH_IMPLIQUES_ACCDN, CAUSE_SIMPLIF, CD_GENRE_ACCDN_simp, indDispSecFautif, CD_MUNCP) %>%
  filter(an>=2014, gravite=="Mortel") %>%
  mutate(indUV = ifelse(NB_DECES_PIETON > 0 | (NB_DECES_PIETON == 0 & NB_BLESSES_PIETON > 0) | NB_DECES_MOTO > 0 | (NB_DECES_MOTO == 0 & NB_BLESSES_MOTO > 0) | NB_DECES_VELO > 0 | (NB_DECES_VELO == 0 & NB_BLESSES_VELO > 0), 1, 0),
         ind_PostCovid = ifelse(DT_ACCDN >= as.Date("2020-03-13"), 1, 0),
         ind_1Veh =  ifelse(NB_VEH_IMPLIQUES_ACCDN== 1, 1, 0)) %>%
  arrange(CD_MUNCP) %>% 
  dplyr::rename(vitesseAutorisee = VITESSE_AUTOR, Genre=CD_GENRE_ACCDN_simp, Cause=CAUSE_SIMPLIF, nbVehImpliqué = NB_VEH_IMPLIQUES_ACCDN) %>%
  mutate(count_genre = 1, 
         count_cause = 1,
         Genre = ifelse(is.na(Genre), "autre", Genre),
         Cause = ifelse(is.na(Cause), "Rien à signaler", Cause),
         Genre2 = Genre,
         Cause2 = Cause) %>%
  pivot_wider(names_from = Genre, values_from = count_genre, values_fill = 0, names_prefix = "genre_") %>%
  pivot_wider(names_from = Cause, values_from = count_cause, values_fill = 0, names_prefix = "cause_")


# unique(df_logis_M$Genre)

df_logis_M$Genre2 <- ifelse(is.na(df_logis_M$Genre2), "autre", df_logis_M$Genre2)
df_logis_M$Cause2 <- ifelse(is.na(df_logis_M$Cause2), "Rien à signaler", df_logis_M$Cause2)

df_logis_M$Genre2 <- relevel(as.factor(df_logis_M$Genre2), ref = "autre")
df_logis_M$Cause2 <- relevel(as.factor(df_logis_M$Cause2), ref = "Rien à signaler")
df_logis_M$indDispSecFautif <- relevel(as.factor(df_logis_M$indDispSecFautif), ref="Respecté")

  # table(is.na(df_logis_M))
  # 
  # df_logis_M$indUV %>% as.numeric %>% sum
  # acc_PA_mrc_M %>% select(nbAcc_UV) %>% sum
  # 
  # df_logis_M$ind_1Veh %>% sum
  # acc_PA_mrc_M$nb1Veh %>% sum
  # 
  # df_logis_M$NB_VEH_IMPLIQUES_ACCDN %>% sum
  # acc_PA_mrc_M$nbVeh %>% sum
  # 
  # (df_logis_M$points * df_logis_M$NB_VEH_IMPLIQUES_ACCDN) %>% sum
  # data_acc %>% filter(gravite=="Mortel") %>% .$points %>% sum

cor_df <- df_logis_M %>%
  select(ind_PostCovid,
                indUV,
                ind_1Veh,
                vitesseAutorisee,
                points,
                indDispSecFautif,
                nbVehImpliqué,
                `genre_sans collision`,
                `genre_collision avec piéton`,
                `genre_collision avec véhicule`,
                `genre_collision avec cycliste`,
                `genre_collision avec animal`,
                `genre_objet fixe`,
                `genre_autre`,
                `cause_Comportement risqué`,
                `cause_Infraction au Code de la route`,
                `cause_Distraction`,
                `cause_État du conducteur`, 
                `cause_Autres`,
                `cause_Environnement routier`,
                `cause_Rien à signaler`,
                `cause_Défauts mécaniques`) %>%
  mutate(indDispSecFautif=as.numeric(as.factor(indDispSecFautif)))

cor_matrix <- cor(cor_df)
cor_upper <- cor_matrix
cor_upper[lower.tri(cor_upper, diag = TRUE)] <- NA
high_cor_pairs <- which(abs(cor_upper) > (0.6), arr.ind = TRUE)
result_mun <- data.frame(
  var1 = rownames(cor_matrix)[high_cor_pairs[, 1]],
  var2 = colnames(cor_matrix)[high_cor_pairs[, 2]],
  correlation = cor_matrix[high_cor_pairs]
)
stargazer(result_mun, type="text", summary=F)

  
df_logis_G <- data_acc %>% 
  group_by(NO_SEQ_COLL) %>%
  mutate(points=mean(points)) %>%
  ungroup() %>%
  distinct(NO_SEQ_COLL, .keep_all = T) %>%
  select(NO_SEQ_COLL, gravite, DT_ACCDN, an, NB_DECES_PIETON, NB_DECES_MOTO, NB_DECES_VELO, NB_BLESSES_PIETON, NB_BLESSES_MOTO, NB_BLESSES_VELO, VITESSE_AUTOR, points, NB_VEH_IMPLIQUES_ACCDN, CAUSE_SIMPLIF, CD_GENRE_ACCDN_simp, indDispSecFautif, CD_MUNCP) %>%
  filter(an>=2014, gravite=="Grave") %>%
  mutate(indUV = ifelse(NB_DECES_PIETON > 0 | (NB_DECES_PIETON == 0 & NB_BLESSES_PIETON > 0) | NB_DECES_MOTO > 0 | (NB_DECES_MOTO == 0 & NB_BLESSES_MOTO > 0) | NB_DECES_VELO > 0 | (NB_DECES_VELO == 0 & NB_BLESSES_VELO > 0), 1, 0),
         ind_PostCovid = ifelse(DT_ACCDN >= as.Date("2020-03-13"), 1, 0),
         ind_1Veh =  ifelse(NB_VEH_IMPLIQUES_ACCDN== 1, 1, 0)) %>%
  arrange(CD_MUNCP) %>% 
  dplyr::rename(vitesseAutorisee = VITESSE_AUTOR, Genre=CD_GENRE_ACCDN_simp, Cause=CAUSE_SIMPLIF, nbVehImpliqué = NB_VEH_IMPLIQUES_ACCDN) %>%
  mutate(count_genre = 1, 
         count_cause = 1,
         Genre = ifelse(is.na(Genre), "autre", Genre),
         Cause = ifelse(is.na(Cause), "Rien à signaler", Cause),
         Genre2 = Genre,
         Cause2 = Cause) %>%
  pivot_wider(names_from = Genre, values_from = count_genre, values_fill = 0, names_prefix = "genre_") %>%
  pivot_wider(names_from = Cause, values_from = count_cause, values_fill = 0, names_prefix = "cause_")

df_logis_G$Genre2 <- ifelse(is.na(df_logis_G$Genre2), "autre", df_logis_G$Genre2)
df_logis_G$Cause2 <- ifelse(is.na(df_logis_G$Cause2), "Rien à signaler", df_logis_G$Cause2)

df_logis_G$Genre2 <- relevel(as.factor(df_logis_G$Genre2), ref = "autre")
df_logis_G$Cause2 <- relevel(as.factor(df_logis_G$Cause2), ref = "Rien à signaler")
df_logis_G$indDispSecFautif <- relevel(as.factor(df_logis_G$indDispSecFautif), ref="Respecté")


  # table(is.na(df_logis_G))
  # 
  # df_logis_G$indUV %>% as.numeric %>% sum
  # acc_PA_mrc_G %>% select(nbAcc_UV) %>% sum
  # 
  # df_logis_G$ind_1Veh %>% sum
  # acc_PA_mrc_G$nb1Veh %>% sum
  # 
  # df_logis_G$nbVehImpliqué %>% sum
  # acc_PA_mrc_G$nbVeh %>% sum
  # 
  # (df_logis_G$points * df_logis_G$nbVehImpliqué) %>% sum
  # data_acc %>% filter(gravite=="Grave") %>% .$points %>% sum
  
  

df_logis_L <- data_acc %>% 
  group_by(NO_SEQ_COLL) %>%
  mutate(points=mean(points)) %>%
  ungroup() %>%
  distinct(NO_SEQ_COLL, .keep_all = T) %>%
  select(NO_SEQ_COLL, gravite, DT_ACCDN, an, NB_DECES_PIETON, NB_DECES_MOTO, NB_DECES_VELO, NB_BLESSES_PIETON, NB_BLESSES_MOTO, NB_BLESSES_VELO, VITESSE_AUTOR, points, NB_VEH_IMPLIQUES_ACCDN, CAUSE_SIMPLIF, CD_GENRE_ACCDN_simp, indDispSecFautif, CD_MUNCP) %>%
  filter(an>=2014, gravite=="Léger") %>%
  mutate(indUV = ifelse(NB_DECES_PIETON > 0 | (NB_DECES_PIETON == 0 & NB_BLESSES_PIETON > 0) | NB_DECES_MOTO > 0 | (NB_DECES_MOTO == 0 & NB_BLESSES_MOTO > 0) | NB_DECES_VELO > 0 | (NB_DECES_VELO == 0 & NB_BLESSES_VELO > 0), 1, 0),
         ind_PostCovid = ifelse(DT_ACCDN >= as.Date("2020-03-13"), 1, 0),
         ind_1Veh =  ifelse(NB_VEH_IMPLIQUES_ACCDN== 1, 1, 0)) %>%
  arrange(CD_MUNCP) %>% 
  dplyr::rename(vitesseAutorisee = VITESSE_AUTOR, Genre=CD_GENRE_ACCDN_simp, Cause=CAUSE_SIMPLIF, nbVehImpliqué = NB_VEH_IMPLIQUES_ACCDN) %>%
  mutate(count_genre = 1, 
         count_cause = 1,
         Genre = ifelse(is.na(Genre), "autre", Genre),
         Cause = ifelse(is.na(Cause), "Rien à signaler", Cause),
         Genre2 = Genre,
         Cause2 = Cause) %>%
  pivot_wider(names_from = Genre, values_from = count_genre, values_fill = 0, names_prefix = "genre_") %>%
  pivot_wider(names_from = Cause, values_from = count_cause, values_fill = 0, names_prefix = "cause_")

df_logis_L$Genre2 <- ifelse(is.na(df_logis_L$Genre2), "autre", df_logis_L$Genre2)
df_logis_L$Cause2 <- ifelse(is.na(df_logis_L$Cause2), "Rien à signaler", df_logis_L$Cause2)

df_logis_L$Genre2 <- relevel(as.factor(df_logis_L$Genre2), ref = "autre")
df_logis_L$Cause2 <- relevel(as.factor(df_logis_L$Cause2), ref = "Rien à signaler")
df_logis_L$indDispSecFautif <- relevel(as.factor(df_logis_L$indDispSecFautif), ref="Respecté")

#   table(is.na(df_logis_L))
# 
#   df_logis_L$indUV %>% as.numeric %>% sum
#   acc_PA_mrc_L %>% select(nbAcc_UV) %>% sum
# 
#   df_logis_L$ind_1Veh %>% sum
#   acc_PA_mrc_L$nb1Veh %>% sum
# 
#   df_logis_L$NB_VEH_IMPLIQUES_ACCDN %>% sum
#   acc_PA_mrc_L$nbVeh %>% sum
# 
#   (df_logis_L$points * df_logis_L$NB_VEH_IMPLIQUES_ACCDN) %>% sum
#   data_acc %>% filter(gravite=="Grave") %>% .$points %>% sum
```



Entrainement des modèles
```{r}
mun_logis_M <- as.integer(factor(df_logis_M$CD_MUNCP))
mun_logis_G <- as.integer(factor(df_logis_G$CD_MUNCP))
mun_logis_L <- as.integer(factor(df_logis_L$CD_MUNCP))

# df_logis_M <- acc_PA_mun_M %>% select(CD_MUN,
  #                       denistéLinéaire_routesMTMD,
  #                       pourcentage_moins5Ans,
  #                       pourcentage_femmes,
  #                       pourcentage_jeunes,
  #                       pourcentage_65AnsEtPlus,
  #                       pourcentage_baccalaureatOuPlus,
  #                       pourcentage_secondaireOuMoins,
  #                       pourcentage_chomeurs,
  #                       revenuMedian) %>%
  # distinct() %>%
  # right_join(df_logis_M, by = join_by(CD_MUN==CD_MUNCP))

# df <- df_logis_M %>% select(an, Genre) %>%
#   group_by(an, Genre) %>%
#   summarise(count = n()) %>% 
#   arrange(an) %>%
#   filter(Genre=="autre") %>% 
#   mutate(ind_covid=ifelse(an>=2020, 1, 0)) %>% 
#   group_by(ind_covid) %>%
#   summarise(autreMean = mean(count))
# df

# df_logis_M <- df_logis_M %>%
#   mutate(count_genre = 1, count_cause = 1) %>%
#   pivot_wider(names_from = Genre, values_from = count_genre, values_fill = 0, names_prefix = "genre_") %>%
#   pivot_wider(names_from = Cause, values_from = count_cause, values_fill = 0, names_prefix = "cause_")


# unique(df_logis_G$Cause)

# form_logis <- ind_PostGenreform_logis <- ind_PostCovid ~
#                 indUV +
#                 ind_1Veh +
#                 vitesseAutorisee +
#                 points +
#                 indDispSecFautif +
#                 Genre2 +
#                 Cause2 +
#                 nbVehImpliqué
  
form_logis <- ind_PostCovid ~ 
                indUV +
                # ind_1Veh +
                vitesseAutorisee +
                points + 
                indDispSecFautif +
                # nbVehImpliqué +
                genre_sans.collision +
                genre_collision.avec.piéton +
                genre_collision.avec.véhicule +
                genre_collision.avec.cycliste +
                genre_collision.avec.animal +
                genre_objet.fixe +
                genre_autre +
                cause_Comportement.risqué +
                cause_Infraction.au.Code.de.la.route +
                cause_Distraction +
                cause_État.du.conducteur + 
                cause_Autres +
                cause_Environnement.routier +
                cause_Rien.à.signaler +
                cause_Défauts.mécaniques

# df_logis_M$`collision avec animal` 

                # denistéLinéaire_routesMTMD +
                # pourcentage_moins5Ans +
                # pourcentage_femmes +
                # pourcentage_jeunes +
                # pourcentage_65AnsEtPlus +
                # pourcentage_baccalaureatOuPlus +
                # pourcentage_secondaireOuMoins +
                # pourcentage_chomeurs

unique(df_logis_M$Genre2)
logis_M_iC <- inla(update(form_logis, .~. + f(mun_logis_M, model="iid")),
                family = "binomial",
                data = df_logis_M,
                control.compute = list(dic = TRUE))
# mod_tableauPropre(list(logis_M_iC=logis_M_iC,
#                        logis_M_mun_iC=logis_M_mun_iC))

logis_M_mun_iC <- inla(update(form_logis, . ~ . + 
                               f(mun_logis_M, model = "bym", graph = W_mun, scale.model=TRUE)),
                family = "binomial",
                data = df_logis_M,
                control.compute = list(dic = TRUE))

logis_G_iC <- inla(form_logis,
                family = "binomial",
                data = df_logis_G,
                control.compute = list(dic = TRUE))

logis_G_mun_iC <- inla(update(form_logis, . ~ . + 
                               f(mun_logis_G, model = "bym", graph = W_mun, scale.model=TRUE)),
                family = "binomial",
                data = df_logis_G,
                control.compute = list(dic = TRUE))

logis_L_iC <- inla(form_logis,
                family = "binomial",
                data = df_logis_L,
                control.compute = list(dic = TRUE))

logis_L_mun_iC <- inla(update(form_logis, . ~ . + 
                               f(mun_logis_L, model = "bym", graph = W_mun, scale.model=TRUE)),
                family = "binomial",
                data = df_logis_L,
                control.compute = list(dic = TRUE))



mod_tableauPropre(list(logis_M_iC=logis_M_iC,
                       logis_M_mun_iC=logis_M_mun_iC,
                       logis_G_iC=logis_G_iC,
                       logis_G_mun_iC=logis_G_mun_iC,
                       logis_L_iC=logis_L_iC,
                       logis_L_mun_iC=logis_L_mun_iC))


mod_tableauPropre(list(logis_M_mun_iC=logis_M_mun_iC,
                       logis_G_mun_iC=logis_G_mun_iC,
                       logis_L_mun_iC=logis_L_mun_iC), difSignificativité = T)

# tab: coefs logis ####
stargazer(mod_tableauPropre(list(logis_M_mun_iC=logis_M_mun_iC,
                       logis_G_mun_iC=logis_G_mun_iC,
                       logis_L_mun_iC=logis_L_mun_iC), difSignificativité = F) %>% 
            filter(!Coefficients %in% c("Région", "Distribution", "Covid-19", "Exposition", "NQC", "DIC") | is.na(Coefficients)), 
          summary=F, type = "latex", rownames = F)

mod_tableauPropre(list(logis_M_mun_iC=logis_M_mun_iC,
                       logis_G_mun_iC=logis_G_mun_iC
                       # logis_L_mun_iC=logis_L_mun_iC
                       ), difCred = T)

summary(logis_M_mun_iC)

```
DIC: Tjrs meilleur avec SS, mais si peu...

indUV: Seul positif, remarquer aussi genre collision avec piéton et cycliste!
Genre sans collision
Semble y avoir aussi une augmentation des dispositifs de sécurité fautifs.

```{r}
pourcVarLogis <- function(modele){
  marg.hyper <- inla.hyperpar.sample(100000, modele)
  ret <- mean(1/marg.hyper[,2] / (1/marg.hyper[,2]+1/marg.hyper[,1]))
  ret
}

pourcVarLogis(logis_M_mun_iC)
pourcVarLogis(logis_G_mun_iC)
pourcVarLogis(logis_L_mun_iC)
```
Avec mortel et mun

### BYM avec ind_covid*var

#### Indicateur UV pour MRC PA
```{r}
# MRC, Mortel
acc_PA_mrc_NQC_M_UV1 <- acc_PA_mrc_NQC_M
acc_PA_mrc_NQC_M_UV2 <- acc_PA_mrc_NQC_M

acc_PA_mrc_NQC_M_UV1$indUV <- 0
acc_PA_mrc_NQC_M_UV2$indUV <- 1

acc_PA_mrc_NQC_M_UV1$nombreAccidents <- acc_PA_mrc_NQC_M$nombreAccidents - acc_PA_mrc_NQC_M$nbAcc_UV
acc_PA_mrc_NQC_M_UV2$nombreAccidents <- acc_PA_mrc_NQC_M$nbAcc_UV

acc_PA_mrc_NQC_M_UV1$nombreAccidents_VKT <- expected(population=acc_PA_mrc_NQC_M_UV1$vktPopu, cases=acc_PA_mrc_NQC_M_UV1$nombreAccidents, n.strata = 1)
acc_PA_mrc_NQC_M_UV2$nombreAccidents_VKT <- expected(population=acc_PA_mrc_NQC_M_UV2$vktPopu, cases=acc_PA_mrc_NQC_M_UV2$nombreAccidents, n.strata = 1)

acc_PA_mrc_NQC_M_indUV <- rbind(acc_PA_mrc_NQC_M_UV1, acc_PA_mrc_NQC_M_UV2)

# MRC, Grave
acc_PA_mrc_NQC_G_UV1 <- acc_PA_mrc_NQC_G
acc_PA_mrc_NQC_G_UV2 <- acc_PA_mrc_NQC_G

acc_PA_mrc_NQC_G_UV1$indUV <- 0
acc_PA_mrc_NQC_G_UV2$indUV <- 1

acc_PA_mrc_NQC_G_UV1$nombreAccidents <- acc_PA_mrc_NQC_G$nombreAccidents - acc_PA_mrc_NQC_G$nbAcc_UV
acc_PA_mrc_NQC_G_UV2$nombreAccidents <- acc_PA_mrc_NQC_G$nbAcc_UV

acc_PA_mrc_NQC_G_UV1$nombreAccidents_VKT <- expected(population=acc_PA_mrc_NQC_G_UV1$vktPopu, cases=acc_PA_mrc_NQC_G_UV1$nombreAccidents, n.strata = 1)
acc_PA_mrc_NQC_G_UV2$nombreAccidents_VKT <- expected(population=acc_PA_mrc_NQC_G_UV2$vktPopu, cases=acc_PA_mrc_NQC_G_UV2$nombreAccidents, n.strata = 1)

acc_PA_mrc_NQC_G_indUV <- rbind(acc_PA_mrc_NQC_G_UV1, acc_PA_mrc_NQC_G_UV2)

# MRC, Léger
acc_PA_mrc_NQC_L_UV1 <- acc_PA_mrc_NQC_L
acc_PA_mrc_NQC_L_UV2 <- acc_PA_mrc_NQC_L

acc_PA_mrc_NQC_L_UV1$indUV <- 0
acc_PA_mrc_NQC_L_UV2$indUV <- 1

acc_PA_mrc_NQC_L_UV1$nombreAccidents <- acc_PA_mrc_NQC_L$nombreAccidents - acc_PA_mrc_NQC_L$nbAcc_UV
acc_PA_mrc_NQC_L_UV2$nombreAccidents <- acc_PA_mrc_NQC_L$nbAcc_UV

acc_PA_mrc_NQC_L_UV1$nombreAccidents_VKT <- expected(population=acc_PA_mrc_NQC_L_UV1$vktPopu, cases=acc_PA_mrc_NQC_L_UV1$nombreAccidents, n.strata = 1)
acc_PA_mrc_NQC_L_UV2$nombreAccidents_VKT <- expected(population=acc_PA_mrc_NQC_L_UV2$vktPopu, cases=acc_PA_mrc_NQC_L_UV2$nombreAccidents, n.strata = 1)

acc_PA_mrc_NQC_L_indUV <- rbind(acc_PA_mrc_NQC_L_UV1, acc_PA_mrc_NQC_L_UV2)



# Mun, Mortel
acc_PA_mun_NQC_M_UV1 <- acc_PA_mun_NQC_M
acc_PA_mun_NQC_M_UV2 <- acc_PA_mun_NQC_M

acc_PA_mun_NQC_M_UV1$indUV <- 0
acc_PA_mun_NQC_M_UV2$indUV <- 1

acc_PA_mun_NQC_M_UV1$nombreAccidents <- acc_PA_mun_NQC_M$nombreAccidents - acc_PA_mun_NQC_M$nbAcc_UV
acc_PA_mun_NQC_M_UV2$nombreAccidents <- acc_PA_mun_NQC_M$nbAcc_UV

acc_PA_mun_NQC_M_UV1$nombreAccidents_VKT <- expected(population=acc_PA_mun_NQC_M_UV1$vktPopu, cases=acc_PA_mun_NQC_M_UV1$nombreAccidents, n.strata = 1)
acc_PA_mun_NQC_M_UV2$nombreAccidents_VKT <- expected(population=acc_PA_mun_NQC_M_UV2$vktPopu, cases=acc_PA_mun_NQC_M_UV2$nombreAccidents, n.strata = 1)

acc_PA_mun_NQC_M_indUV <- rbind(acc_PA_mun_NQC_M_UV1, acc_PA_mun_NQC_M_UV2)

# Mun, Grave
acc_PA_mun_NQC_G_UV1 <- acc_PA_mun_NQC_G
acc_PA_mun_NQC_G_UV2 <- acc_PA_mun_NQC_G

acc_PA_mun_NQC_G_UV1$indUV <- 0
acc_PA_mun_NQC_G_UV2$indUV <- 1

acc_PA_mun_NQC_G_UV1$nombreAccidents <- acc_PA_mun_NQC_G$nombreAccidents - acc_PA_mun_NQC_G$nbAcc_UV
acc_PA_mun_NQC_G_UV2$nombreAccidents <- acc_PA_mun_NQC_G$nbAcc_UV

acc_PA_mun_NQC_G_UV1$nombreAccidents_VKT <- expected(population=acc_PA_mun_NQC_G_UV1$vktPopu, cases=acc_PA_mun_NQC_G_UV1$nombreAccidents, n.strata = 1)
acc_PA_mun_NQC_G_UV2$nombreAccidents_VKT <- expected(population=acc_PA_mun_NQC_G_UV2$vktPopu, cases=acc_PA_mun_NQC_G_UV2$nombreAccidents, n.strata = 1)

acc_PA_mun_NQC_G_indUV <- rbind(acc_PA_mun_NQC_G_UV1, acc_PA_mun_NQC_G_UV2)

# Mun, Léger
acc_PA_mun_NQC_L_UV1 <- acc_PA_mun_NQC_L
acc_PA_mun_NQC_L_UV2 <- acc_PA_mun_NQC_L

acc_PA_mun_NQC_L_UV1$indUV <- 0
acc_PA_mun_NQC_L_UV2$indUV <- 1

acc_PA_mun_NQC_L_UV1$nombreAccidents <- acc_PA_mun_NQC_L$nombreAccidents - acc_PA_mun_NQC_L$nbAcc_UV
acc_PA_mun_NQC_L_UV2$nombreAccidents <- acc_PA_mun_NQC_L$nbAcc_UV

acc_PA_mun_NQC_L_UV1$nombreAccidents_VKT <- expected(population=acc_PA_mun_NQC_L_UV1$vktPopu, cases=acc_PA_mun_NQC_L_UV1$nombreAccidents, n.strata = 1)
acc_PA_mun_NQC_L_UV2$nombreAccidents_VKT <- expected(population=acc_PA_mun_NQC_L_UV2$vktPopu, cases=acc_PA_mun_NQC_L_UV2$nombreAccidents, n.strata = 1)

acc_PA_mun_NQC_L_indUV <- rbind(acc_PA_mun_NQC_L_UV1, acc_PA_mun_NQC_L_UV2)
```

#### Indicateur disSec pour MRC PA
```{r}
# MRC, Mortel
acc_PA_mrc_NQC_M_DSF1 <- acc_PA_mrc_NQC_M
acc_PA_mrc_NQC_M_DSF2 <- acc_PA_mrc_NQC_M

acc_PA_mrc_NQC_M_DSF1$indDSF <- 0
acc_PA_mrc_NQC_M_DSF2$indDSF <- 1

acc_PA_mrc_NQC_M_DSF1$nombreAccidents <- acc_PA_mrc_NQC_M$nombreAccidents - acc_PA_mrc_NQC_M$nbDispSecFautif
acc_PA_mrc_NQC_M_DSF2$nombreAccidents <- acc_PA_mrc_NQC_M$nbDispSecFautif

acc_PA_mrc_NQC_M_DSF1$nombreAccidents_VKT <- expected(population=acc_PA_mrc_NQC_M_DSF1$vktPopu, cases=acc_PA_mrc_NQC_M_DSF1$nombreAccidents, n.strata = 1)
acc_PA_mrc_NQC_M_DSF2$nombreAccidents_VKT <- expected(population=acc_PA_mrc_NQC_M_DSF2$vktPopu, cases=acc_PA_mrc_NQC_M_DSF2$nombreAccidents, n.strata = 1)

acc_PA_mrc_NQC_M_indDSF <- rbind(acc_PA_mrc_NQC_M_DSF1, acc_PA_mrc_NQC_M_DSF2)

# Mun, Mortel
acc_PA_mun_NQC_M_DSF1 <- acc_PA_mun_NQC_M
acc_PA_mun_NQC_M_DSF2 <- acc_PA_mun_NQC_M

acc_PA_mun_NQC_M_DSF1$indDSF <- 0
acc_PA_mun_NQC_M_DSF2$indDSF <- 1

acc_PA_mun_NQC_M_DSF1$nombreAccidents <- acc_PA_mun_NQC_M$nombreAccidents - acc_PA_mun_NQC_M$nbDispSecFautif
acc_PA_mun_NQC_M_DSF2$nombreAccidents <- acc_PA_mun_NQC_M$nbDispSecFautif

acc_PA_mun_NQC_M_DSF1$nombreAccidents_VKT <- expected(population=acc_PA_mun_NQC_M_DSF1$vktPopu, cases=acc_PA_mun_NQC_M_DSF1$nombreAccidents, n.strata = 1)
acc_PA_mun_NQC_M_DSF2$nombreAccidents_VKT <- expected(population=acc_PA_mun_NQC_M_DSF2$vktPopu, cases=acc_PA_mun_NQC_M_DSF2$nombreAccidents, n.strata = 1)

acc_PA_mun_NQC_M_indDSF <- rbind(acc_PA_mun_NQC_M_DSF1, acc_PA_mun_NQC_M_DSF2)

# MRC, Grave
acc_PA_mrc_NQC_G_DSF1 <- acc_PA_mrc_NQC_G
acc_PA_mrc_NQC_G_DSF2 <- acc_PA_mrc_NQC_G

acc_PA_mrc_NQC_G_DSF1$indDSF <- 0
acc_PA_mrc_NQC_G_DSF2$indDSF <- 1

acc_PA_mrc_NQC_G_DSF1$nombreAccidents <- acc_PA_mrc_NQC_G$nombreAccidents - acc_PA_mrc_NQC_G$nbDispSecFautif
acc_PA_mrc_NQC_G_DSF2$nombreAccidents <- acc_PA_mrc_NQC_G$nbDispSecFautif

acc_PA_mrc_NQC_G_DSF1$nombreAccidents_VKT <- expected(population=acc_PA_mrc_NQC_G_DSF1$vktPopu, cases=acc_PA_mrc_NQC_G_DSF1$nombreAccidents, n.strata = 1)
acc_PA_mrc_NQC_G_DSF2$nombreAccidents_VKT <- expected(population=acc_PA_mrc_NQC_G_DSF2$vktPopu, cases=acc_PA_mrc_NQC_G_DSF2$nombreAccidents, n.strata = 1)

acc_PA_mrc_NQC_G_indDSF <- rbind(acc_PA_mrc_NQC_G_DSF1, acc_PA_mrc_NQC_G_DSF2)

# Mun, Grave
acc_PA_mun_NQC_G_DSF1 <- acc_PA_mun_NQC_G
acc_PA_mun_NQC_G_DSF2 <- acc_PA_mun_NQC_G

acc_PA_mun_NQC_G_DSF1$indDSF <- 0
acc_PA_mun_NQC_G_DSF2$indDSF <- 1

acc_PA_mun_NQC_G_DSF1$nombreAccidents <- acc_PA_mun_NQC_G$nombreAccidents - acc_PA_mun_NQC_G$nbDispSecFautif
acc_PA_mun_NQC_G_DSF2$nombreAccidents <- acc_PA_mun_NQC_G$nbDispSecFautif

acc_PA_mun_NQC_G_DSF1$nombreAccidents_VKT <- expected(population=acc_PA_mun_NQC_G_DSF1$vktPopu, cases=acc_PA_mun_NQC_G_DSF1$nombreAccidents, n.strata = 1)
acc_PA_mun_NQC_G_DSF2$nombreAccidents_VKT <- expected(population=acc_PA_mun_NQC_G_DSF2$vktPopu, cases=acc_PA_mun_NQC_G_DSF2$nombreAccidents, n.strata = 1)

acc_PA_mun_NQC_G_indDSF <- rbind(acc_PA_mun_NQC_G_DSF1, acc_PA_mun_NQC_G_DSF2)

# MRC, Léger
acc_PA_mrc_NQC_L_DSF1 <- acc_PA_mrc_NQC_L
acc_PA_mrc_NQC_L_DSF2 <- acc_PA_mrc_NQC_L

acc_PA_mrc_NQC_L_DSF1$indDSF <- 0
acc_PA_mrc_NQC_L_DSF2$indDSF <- 1

acc_PA_mrc_NQC_L_DSF1$nombreAccidents <- acc_PA_mrc_NQC_L$nombreAccidents - acc_PA_mrc_NQC_L$nbDispSecFautif
acc_PA_mrc_NQC_L_DSF2$nombreAccidents <- acc_PA_mrc_NQC_L$nbDispSecFautif

acc_PA_mrc_NQC_L_DSF1$nombreAccidents_VKT <- expected(population=acc_PA_mrc_NQC_L_DSF1$vktPopu, cases=acc_PA_mrc_NQC_L_DSF1$nombreAccidents, n.strata = 1)
acc_PA_mrc_NQC_L_DSF2$nombreAccidents_VKT <- expected(population=acc_PA_mrc_NQC_L_DSF2$vktPopu, cases=acc_PA_mrc_NQC_L_DSF2$nombreAccidents, n.strata = 1)

acc_PA_mrc_NQC_L_indDSF <- rbind(acc_PA_mrc_NQC_L_DSF1, acc_PA_mrc_NQC_L_DSF2)

# Mun, Léger
acc_PA_mun_NQC_L_DSF1 <- acc_PA_mun_NQC_L
acc_PA_mun_NQC_L_DSF2 <- acc_PA_mun_NQC_L

acc_PA_mun_NQC_L_DSF1$indDSF <- 0
acc_PA_mun_NQC_L_DSF2$indDSF <- 1

acc_PA_mun_NQC_L_DSF1$nombreAccidents <- acc_PA_mun_NQC_L$nombreAccidents - acc_PA_mun_NQC_L$nbDispSecFautif
acc_PA_mun_NQC_L_DSF2$nombreAccidents <- acc_PA_mun_NQC_L$nbDispSecFautif

acc_PA_mun_NQC_L_DSF1$nombreAccidents_VKT <- expected(population=acc_PA_mun_NQC_L_DSF1$vktPopu, cases=acc_PA_mun_NQC_L_DSF1$nombreAccidents, n.strata = 1)
acc_PA_mun_NQC_L_DSF2$nombreAccidents_VKT <- expected(population=acc_PA_mun_NQC_L_DSF2$vktPopu, cases=acc_PA_mun_NQC_L_DSF2$nombreAccidents, n.strata = 1)

acc_PA_mun_NQC_L_indDSF <- rbind(acc_PA_mun_NQC_L_DSF1, acc_PA_mun_NQC_L_DSF2)
```

#### Indicateur 1VehImp pour MRC PA
```{r}
# MRC, Mortel
acc_PA_mrc_NQC_M_1Veh1 <- acc_PA_mrc_NQC_M
acc_PA_mrc_NQC_M_1Veh2 <- acc_PA_mrc_NQC_M

acc_PA_mrc_NQC_M_1Veh1$ind1Veh <- 0
acc_PA_mrc_NQC_M_1Veh2$ind1Veh <- 1

acc_PA_mrc_NQC_M_1Veh1$nombreAccidents <- acc_PA_mrc_NQC_M$nombreAccidents - acc_PA_mrc_NQC_M$nb1Veh
acc_PA_mrc_NQC_M_1Veh2$nombreAccidents <- acc_PA_mrc_NQC_M$nb1Veh
table(acc_PA_mrc_NQC_M_1Veh1$nombreAccidents>=0)

acc_PA_mrc_NQC_M_1Veh1$nombreAccidents_VKT <- expected(population=acc_PA_mrc_NQC_M_1Veh1$vktPopu, cases=acc_PA_mrc_NQC_M_1Veh1$nombreAccidents, n.strata = 1)
acc_PA_mrc_NQC_M_1Veh2$nombreAccidents_VKT <- expected(population=acc_PA_mrc_NQC_M_1Veh2$vktPopu, cases=acc_PA_mrc_NQC_M_1Veh2$nombreAccidents, n.strata = 1)

acc_PA_mrc_NQC_M_ind1Veh <- rbind(acc_PA_mrc_NQC_M_1Veh1, acc_PA_mrc_NQC_M_1Veh2)

# Mun, Mortel
acc_PA_mun_NQC_M_1Veh1 <- acc_PA_mun_NQC_M
acc_PA_mun_NQC_M_1Veh2 <- acc_PA_mun_NQC_M

acc_PA_mun_NQC_M_1Veh1$ind1Veh <- 0
acc_PA_mun_NQC_M_1Veh2$ind1Veh <- 1

acc_PA_mun_NQC_M_1Veh1$nombreAccidents <- acc_PA_mun_NQC_M$nombreAccidents - acc_PA_mun_NQC_M$nb1Veh
acc_PA_mun_NQC_M_1Veh2$nombreAccidents <- acc_PA_mun_NQC_M$nb1Veh
table(acc_PA_mun_NQC_M_1Veh1$nombreAccidents>=0)

acc_PA_mun_NQC_M_1Veh1$nombreAccidents_VKT <- expected(population=acc_PA_mun_NQC_M_1Veh1$vktPopu, cases=acc_PA_mun_NQC_M_1Veh1$nombreAccidents, n.strata = 1)
acc_PA_mun_NQC_M_1Veh2$nombreAccidents_VKT <- expected(population=acc_PA_mun_NQC_M_1Veh2$vktPopu, cases=acc_PA_mun_NQC_M_1Veh2$nombreAccidents, n.strata = 1)

acc_PA_mun_NQC_M_ind1Veh <- rbind(acc_PA_mun_NQC_M_1Veh1, acc_PA_mun_NQC_M_1Veh2)


# MRC, Grave
acc_PA_mrc_NQC_G_1Veh1 <- acc_PA_mrc_NQC_G
acc_PA_mrc_NQC_G_1Veh2 <- acc_PA_mrc_NQC_G

acc_PA_mrc_NQC_G_1Veh1$ind1Veh <- 0
acc_PA_mrc_NQC_G_1Veh2$ind1Veh <- 1

acc_PA_mrc_NQC_G_1Veh1$nombreAccidents <- acc_PA_mrc_NQC_G$nombreAccidents - acc_PA_mrc_NQC_G$nb1Veh
acc_PA_mrc_NQC_G_1Veh2$nombreAccidents <- acc_PA_mrc_NQC_G$nb1Veh
table(acc_PA_mrc_NQC_G_1Veh1$nombreAccidents>=0)

acc_PA_mrc_NQC_G_1Veh1$nombreAccidents_VKT <- expected(population=acc_PA_mrc_NQC_G_1Veh1$vktPopu, cases=acc_PA_mrc_NQC_G_1Veh1$nombreAccidents, n.strata = 1)
acc_PA_mrc_NQC_G_1Veh2$nombreAccidents_VKT <- expected(population=acc_PA_mrc_NQC_G_1Veh2$vktPopu, cases=acc_PA_mrc_NQC_G_1Veh2$nombreAccidents, n.strata = 1)

acc_PA_mrc_NQC_G_ind1Veh <- rbind(acc_PA_mrc_NQC_G_1Veh1, acc_PA_mrc_NQC_G_1Veh2)

# Mun, Grave
acc_PA_mun_NQC_G_1Veh1 <- acc_PA_mun_NQC_G
acc_PA_mun_NQC_G_1Veh2 <- acc_PA_mun_NQC_G

acc_PA_mun_NQC_G_1Veh1$ind1Veh <- 0
acc_PA_mun_NQC_G_1Veh2$ind1Veh <- 1

acc_PA_mun_NQC_G_1Veh1$nombreAccidents <- acc_PA_mun_NQC_G$nombreAccidents - acc_PA_mun_NQC_G$nb1Veh
acc_PA_mun_NQC_G_1Veh2$nombreAccidents <- acc_PA_mun_NQC_G$nb1Veh
table(acc_PA_mun_NQC_G_1Veh1$nombreAccidents>=0)

acc_PA_mun_NQC_G_1Veh1$nombreAccidents_VKT <- expected(population=acc_PA_mun_NQC_G_1Veh1$vktPopu, cases=acc_PA_mun_NQC_G_1Veh1$nombreAccidents, n.strata = 1)
acc_PA_mun_NQC_G_1Veh2$nombreAccidents_VKT <- expected(population=acc_PA_mun_NQC_G_1Veh2$vktPopu, cases=acc_PA_mun_NQC_G_1Veh2$nombreAccidents, n.strata = 1)

acc_PA_mun_NQC_G_ind1Veh <- rbind(acc_PA_mun_NQC_G_1Veh1, acc_PA_mun_NQC_G_1Veh2)


# MRC, Léger
acc_PA_mrc_NQC_L_1Veh1 <- acc_PA_mrc_NQC_L
acc_PA_mrc_NQC_L_1Veh2 <- acc_PA_mrc_NQC_L

acc_PA_mrc_NQC_L_1Veh1$ind1Veh <- 0
acc_PA_mrc_NQC_L_1Veh2$ind1Veh <- 1

acc_PA_mrc_NQC_L_1Veh1$nombreAccidents <- acc_PA_mrc_NQC_L$nombreAccidents - acc_PA_mrc_NQC_L$nb1Veh
acc_PA_mrc_NQC_L_1Veh2$nombreAccidents <- acc_PA_mrc_NQC_L$nb1Veh
table(acc_PA_mrc_NQC_L_1Veh1$nombreAccidents>=0)

acc_PA_mrc_NQC_L_1Veh1$nombreAccidents_VKT <- expected(population=acc_PA_mrc_NQC_L_1Veh1$vktPopu, cases=acc_PA_mrc_NQC_L_1Veh1$nombreAccidents, n.strata = 1)
acc_PA_mrc_NQC_L_1Veh2$nombreAccidents_VKT <- expected(population=acc_PA_mrc_NQC_L_1Veh2$vktPopu, cases=acc_PA_mrc_NQC_L_1Veh2$nombreAccidents, n.strata = 1)

acc_PA_mrc_NQC_L_ind1Veh <- rbind(acc_PA_mrc_NQC_L_1Veh1, acc_PA_mrc_NQC_L_1Veh2)

# Mun, Léger
acc_PA_mun_NQC_L_1Veh1 <- acc_PA_mun_NQC_L
acc_PA_mun_NQC_L_1Veh2 <- acc_PA_mun_NQC_L

acc_PA_mun_NQC_L_1Veh1$ind1Veh <- 0
acc_PA_mun_NQC_L_1Veh2$ind1Veh <- 1

acc_PA_mun_NQC_L_1Veh1$nombreAccidents <- acc_PA_mun_NQC_L$nombreAccidents - acc_PA_mun_NQC_L$nb1Veh
acc_PA_mun_NQC_L_1Veh2$nombreAccidents <- acc_PA_mun_NQC_L$nb1Veh
table(acc_PA_mun_NQC_L_1Veh1$nombreAccidents>=0)

acc_PA_mun_NQC_L_1Veh1$nombreAccidents_VKT <- expected(population=acc_PA_mun_NQC_L_1Veh1$vktPopu, cases=acc_PA_mun_NQC_L_1Veh1$nombreAccidents, n.strata = 1)
acc_PA_mun_NQC_L_1Veh2$nombreAccidents_VKT <- expected(population=acc_PA_mun_NQC_L_1Veh2$vktPopu, cases=acc_PA_mun_NQC_L_1Veh2$nombreAccidents, n.strata = 1)

acc_PA_mun_NQC_L_ind1Veh <- rbind(acc_PA_mun_NQC_L_1Veh1, acc_PA_mun_NQC_L_1Veh2)
```



#### Modèles
```{r}
# UV
bymNB_mrc_NQC_M_iC_indUV_interac <- inla(update(form, nombreAccidents ~ . + ind_covid * indUV + f(c(mrc_NQC,mrc_NQC), model = "bym", graph = W_mrc_NQC, scale.model=TRUE)), 
                family = "nbinomial",
                E = `nombreAccidents_VKT`,
                data = acc_PA_mrc_NQC_M_indUV,
                control.compute = list(dic = TRUE))
summary(bymNB_mrc_NQC_M_iC_indUV_interac)
mod_tableauPropre(list(bymNB_mrc_NQC_M_iC_indUV_interac=bymNB_mrc_NQC_M_iC_indUV_interac))

bymNB_mun_NQC_M_iC_indUV_interac <- inla(update(form, nombreAccidents ~ . + ind_covid * indUV + f(c(mun_NQC,mun_NQC), model = "bym", graph = W_mun_NQC, scale.model=TRUE)),
                # quantiles=c(0.05, 0.5, 0.95),
                family = "nbinomial",
                E = `nombreAccidents_VKT`,
                data = acc_PA_mun_NQC_M_indUV,
                control.compute = list(dic = TRUE))

# PtsMoyens
bymNB_mun_NQC_M_iC_pts_interac <- inla(update(form, . ~ . -ptsMoyens + ptsMoyens * ind_covid + f(mun_NQC, model = "bym", graph = W_mun_NQC, scale.model=TRUE)), 
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mun_NQC_M,
                control.compute = list(dic = TRUE))

bymNB_mrc_NQC_M_iC_pts_interac <- inla(update(form, . ~ . - ptsMoyens + ptsMoyens * ind_covid + f(mrc_NQC, model = "bym", graph = W_mrc_NQC, scale.model=TRUE)), 
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mrc_NQC_M,
                control.compute = list(dic = TRUE))

#DispSéc
bymNB_mrc_NQC_M_iC_DispSec_interac <- inla(update(form, . ~ . + indDSF * ind_covid + f(c(mrc_NQC,mrc_NQC), model = "bym", graph = W_mrc_NQC, scale.model=TRUE)), 
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mrc_NQC_M_indDSF,
                control.compute = list(dic = TRUE))
bymNB_mun_NQC_M_iC_DispSec_interac <- inla(update(form, . ~ . + indDSF * ind_covid + f(c(mun_NQC,mun_NQC), model = "bym", graph = W_mun_NQC, scale.model=TRUE)), 
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mun_NQC_M_indDSF,
                control.compute = list(dic = TRUE))

# 1Veh
bymNB_mrc_NQC_M_iC_1Veh_interac <- inla(update(form, . ~ . + ind1Veh * ind_covid + f(c(mrc_NQC,mrc_NQC), model = "bym", graph = W_mrc_NQC, scale.model=TRUE)), 
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mrc_NQC_M_ind1Veh,
                control.compute = list(dic = TRUE))
bymNB_mun_NQC_M_iC_1Veh_interac <- inla(update(form, . ~ . + ind1Veh * ind_covid + f(c(mun_NQC,mun_NQC), model = "bym", graph = W_mun_NQC, scale.model=TRUE)), 
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mun_NQC_M_ind1Veh,
                control.compute = list(dic = TRUE))


```

```{r}
# Comparaison mun vs MRC

## UV
mod_tableauPropre(list(
  bymNB_mun_NQC_M_iC_indUV_interac=bymNB_mun_NQC_M_iC_indUV_interac,
  bymNB_mrc_NQC_M_iC_indUV_interac=bymNB_mrc_NQC_M_iC_indUV_interac), difCred = T)
# densité, ptsMoyens vitesseAutorisee
# indCovid - 0, baisse indUV, mais hausse énorme indUV:postCovid

## DispSec
mod_tableauPropre(list(
  bymNB_mun_NQC_M_iC_DispSec_interac=bymNB_mun_NQC_M_iC_DispSec_interac,
  bymNB_mrc_NQC_M_iC_DispSec_interac=bymNB_mrc_NQC_M_iC_DispSec_interac), difCred = T)
# meme cov, pas grand chose de signif. ind covid, reste signif positif.

## 1Veh
mod_tableauPropre(list(
  bymNB_mun_NQC_M_iC_1Veh_interac=bymNB_mun_NQC_M_iC_1Veh_interac,
  bymNB_mrc_NQC_M_iC_1Veh_interac=bymNB_mrc_NQC_M_iC_1Veh_interac), difCred = T)
# mm covs, ind_covid n'est plus signif... c'est tout sinon

## ptsMoyens
mod_tableauPropre(list(
  bymNB_mun_NQC_M_iC_pts_interac=bymNB_mun_NQC_M_iC_pts_interac,
  bymNB_mrc_NQC_M_iC_pts_interac=bymNB_mrc_NQC_M_iC_pts_interac), difCred = T)
# ms covs, ind_covid pas signifs niveau mun, mais l'est niveau MRC!
# effet covid différent selon Mun et MRC! MRC concorde avec logis...

# Comparaison inter région

stargazer(mod_tableauPropre(list(
    bymNB_mun_NQC_M_iC_indUV_interac=bymNB_mun_NQC_M_iC_indUV_interac,
    bymNB_mun_NQC_M_iC_DispSec_interac=bymNB_mun_NQC_M_iC_DispSec_interac,
    bymNB_mun_NQC_M_iC_1Veh_interac=bymNB_mun_NQC_M_iC_1Veh_interac,
    bymNB_mun_NQC_M_iC_pts_interac=bymNB_mun_NQC_M_iC_pts_interac), difSignificativité = T), summary=F, type="text", rownames=F)

stargazer(mod_tableauPropre(list(
    bymNB_mrc_NQC_M_iC_indUV_interac=bymNB_mrc_NQC_M_iC_indUV_interac,
    bymNB_mrc_NQC_M_iC_DispSec_interac=bymNB_mrc_NQC_M_iC_DispSec_interac,
    bymNB_mrc_NQC_M_iC_1Veh_interac=bymNB_mrc_NQC_M_iC_1Veh_interac,
    bymNB_mrc_NQC_M_iC_pts_interac=bymNB_mrc_NQC_M_iC_pts_interac), difSignificativité = T), summary=F, type="text", rownames=F)
# Tout est semblable!

# Compa avec base

# tab: coef interac ####
stargazer(mod_tableauPropre(list(
    bymNB_mun_NQC_M_iC=bymNB_mun_NQC_M_iC,
    bymNB_mun_NQC_M_iC_indUV_interac=bymNB_mun_NQC_M_iC_indUV_interac,
    bymNB_mun_NQC_M_iC_DispSec_interac=bymNB_mun_NQC_M_iC_DispSec_interac,
    bymNB_mun_NQC_M_iC_1Veh_interac=bymNB_mun_NQC_M_iC_1Veh_interac,
    bymNB_mun_NQC_M_iC_pts_interac=bymNB_mun_NQC_M_iC_pts_interac), difSignificativité = F) %>% 
            filter(!Coefficients %in% c("Modèle", "Région", "Distribution", "Covid-19", "Interaction", "Exposition", "Usag. Vul.", "NQC", "1 véh. impliqué", "DIC") | is.na(Coefficients)),
  summary=F, type="text", rownames=F)

# tab: mrc coefs interac ####
stargazer(mod_tableauPropre(list(
    bymNB_mrc_NQC_M_iC=bymNB_mrc_NQC_M_iC,
    bymNB_mrc_NQC_M_iC_indUV_interac=bymNB_mrc_NQC_M_iC_indUV_interac,
    bymNB_mrc_NQC_M_iC_DispSec_interac=bymNB_mrc_NQC_M_iC_DispSec_interac,
    bymNB_mrc_NQC_M_iC_1Veh_interac=bymNB_mrc_NQC_M_iC_1Veh_interac,
    bymNB_mrc_NQC_M_iC_pts_interac=bymNB_mrc_NQC_M_iC_pts_interac), difSignificativité = F) %>% 
            filter(Coefficients %in% c("Gravité", "VariableÉtudié", "ind_covidPost-Covid", "ptsMoyens", "indUV", "ind_covidPost-Covid:indUV", "indDSF", "indDSF:ind_covidPost-Covid", "ind1Veh", "ind1Veh:ind_covidPost-Covid", "ptsMoyens:ind_covidPost-Covid") | is.na(Coefficients)), summary=F, type="text", rownames=F)

```
Pts est inverse de ce qu'on avait avec logis
Regarder ce que ca fait pour GL

#### Avec G,L

```{r}
# Grave
# UV
bymNB_mrc_NQC_G_iC_indUV_interac <- inla(update(form, nombreAccidents ~ . + ind_covid * indUV + f(c(mrc_NQC,mrc_NQC), model = "bym", graph = W_mrc_NQC, scale.model=TRUE)), 
                family = "nbinomial",
                E = `nombreAccidents_VKT`,
                data = acc_PA_mrc_NQC_G_indUV,
                control.compute = list(dic = TRUE))

bymNB_mun_NQC_G_iC_indUV_interac <- inla(update(form, nombreAccidents ~ . + ind_covid * indUV + f(c(mun_NQC,mun_NQC), model = "bym", graph = W_mun_NQC, scale.model=TRUE)),
                # quantiles=c(0.05, 0.5, 0.95),
                family = "nbinomial",
                E = `nombreAccidents_VKT`,
                data = acc_PA_mun_NQC_G_indUV,
                control.compute = list(dic = TRUE))

# PtsMoyens
bymNB_mun_NQC_G_iC_pts_interac <- inla(update(form, . ~ . + ptsMoyens * ind_covid + f(mun_NQC, model = "bym", graph = W_mun_NQC, scale.model=TRUE)), 
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mun_NQC_G,
                control.compute = list(dic = TRUE))

bymNB_mrc_NQC_G_iC_pts_interac <- inla(update(form, . ~ . + ptsMoyens * ind_covid + f(mrc_NQC, model = "bym", graph = W_mrc_NQC, scale.model=TRUE)), 
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mrc_NQC_G,
                control.compute = list(dic = TRUE))

#DispSéc
bymNB_mrc_NQC_G_iC_DispSec_interac <- inla(update(form, . ~ . + indDSF * ind_covid + f(c(mrc_NQC,mrc_NQC), model = "bym", graph = W_mrc_NQC, scale.model=TRUE)), 
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mrc_NQC_G_indDSF,
                control.compute = list(dic = TRUE))
bymNB_mun_NQC_G_iC_DispSec_interac <- inla(update(form, . ~ . + indDSF * ind_covid + f(c(mun_NQC,mun_NQC), model = "bym", graph = W_mun_NQC, scale.model=TRUE)), 
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mun_NQC_G_indDSF,
                control.compute = list(dic = TRUE))

# 1Veh
bymNB_mrc_NQC_G_iC_1Veh_interac <- inla(update(form, . ~ . + ind1Veh * ind_covid + f(c(mrc_NQC,mrc_NQC), model = "bym", graph = W_mrc_NQC, scale.model=TRUE)), 
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mrc_NQC_G_ind1Veh,
                control.compute = list(dic = TRUE))
bymNB_mun_NQC_G_iC_1Veh_interac <- inla(update(form, . ~ . + ind1Veh * ind_covid + f(c(mun_NQC,mun_NQC), model = "bym", graph = W_mun_NQC, scale.model=TRUE)), 
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mun_NQC_G_ind1Veh,
                control.compute = list(dic = TRUE))

# Léger
# UV
bymNB_mrc_NQC_L_iC_indUV_interac <- inla(update(form, nombreAccidents ~ . + ind_covid * indUV + f(c(mrc_NQC,mrc_NQC), model = "bym", graph = W_mrc_NQC, scale.model=TRUE)), 
                family = "nbinomial",
                E = `nombreAccidents_VKT`,
                data = acc_PA_mrc_NQC_L_indUV,
                control.compute = list(dic = TRUE))

bymNB_mun_NQC_L_iC_indUV_interac <- inla(update(form, nombreAccidents ~ . + ind_covid * indUV + f(c(mun_NQC,mun_NQC), model = "bym", graph = W_mun_NQC, scale.model=TRUE)),
                # quantiles=c(0.05, 0.5, 0.95),
                family = "nbinomial",
                E = `nombreAccidents_VKT`,
                data = acc_PA_mun_NQC_L_indUV,
                control.compute = list(dic = TRUE))

# PtsMoyens
bymNB_mun_NQC_L_iC_pts_interac <- inla(update(form, . ~ . + ptsMoyens * ind_covid + f(mun_NQC, model = "bym", graph = W_mun_NQC, scale.model=TRUE)), 
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mun_NQC_L,
                control.compute = list(dic = TRUE))

bymNB_mrc_NQC_L_iC_pts_interac <- inla(update(form, . ~ . + ptsMoyens * ind_covid + f(mrc_NQC, model = "bym", graph = W_mrc_NQC, scale.model=TRUE)), 
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mrc_NQC_L,
                control.compute = list(dic = TRUE))

#DispSéc
bymNB_mrc_NQC_L_iC_DispSec_interac <- inla(update(form, . ~ . + indDSF * ind_covid + f(c(mrc_NQC,mrc_NQC), model = "bym", graph = W_mrc_NQC, scale.model=TRUE)), 
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mrc_NQC_L_indDSF,
                control.compute = list(dic = TRUE))
bymNB_mun_NQC_L_iC_DispSec_interac <- inla(update(form, . ~ . + indDSF * ind_covid + f(c(mun_NQC,mun_NQC), model = "bym", graph = W_mun_NQC, scale.model=TRUE)), 
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mun_NQC_L_indDSF,
                control.compute = list(dic = TRUE))

# 1Veh
bymNB_mrc_NQC_L_iC_1Veh_interac <- inla(update(form, . ~ . + ind1Veh * ind_covid + f(c(mrc_NQC,mrc_NQC), model = "bym", graph = W_mrc_NQC, scale.model=TRUE)), 
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mrc_NQC_L_ind1Veh,
                control.compute = list(dic = TRUE))
bymNB_mun_NQC_L_iC_1Veh_interac <- inla(update(form, . ~ . + ind1Veh * ind_covid + f(c(mun_NQC,mun_NQC), model = "bym", graph = W_mun_NQC, scale.model=TRUE)), 
                family = "nbinomial",
                E=`nombreAccidents_VKT`,
                data = acc_PA_mun_NQC_L_ind1Veh,
                control.compute = list(dic = TRUE))



# Compa avec base
## Grave
stargazer(mod_tableauPropre(list(
    bymNB_mun_NQC_G_iC=bymNB_mun_NQC_G_iC,
    bymNB_mun_NQC_G_iC_indUV_interac=bymNB_mun_NQC_G_iC_indUV_interac,
    bymNB_mun_NQC_G_iC_DispSec_interac=bymNB_mun_NQC_G_iC_DispSec_interac,
    bymNB_mun_NQC_G_iC_1Veh_interac=bymNB_mun_NQC_G_iC_1Veh_interac,
    bymNB_mun_NQC_G_iC_pts_interac=bymNB_mun_NQC_G_iC_pts_interac), difSignificativité = T), summary=F, rownames=F, type="text")
stargazer(mod_tableauPropre(list(
    bymNB_mun_NQC_G_iC=bymNB_mun_NQC_G_iC,
    bymNB_mun_NQC_G_iC_indUV_interac=bymNB_mun_NQC_G_iC_indUV_interac,
    bymNB_mun_NQC_G_iC_DispSec_interac=bymNB_mun_NQC_G_iC_DispSec_interac,
    bymNB_mun_NQC_G_iC_1Veh_interac=bymNB_mun_NQC_G_iC_1Veh_interac,
    bymNB_mun_NQC_G_iC_pts_interac=bymNB_mun_NQC_G_iC_pts_interac), difSignificativité = T) %>% 
            filter(Coefficients %in% c("Modèle", "Région", "Distribution", "Gravité", "VariableÉtudié", "ind_covidPost-Covid", "ptsMoyens", "indUV", "ind_covidPost-Covid:indUV", "indDSF", "indDSF:ind_covidPost-Covid", "ind1Veh", "ind1Veh:ind_covidPost-Covid", "ptsMoyens:ind_covidPost-Covid") | is.na(Coefficients))
    , summary=F, type="text", rownames=F)


# Compa avec base
## Léger
stargazer(mod_tableauPropre(list(
    bymNB_mun_NQC_L_iC=bymNB_mun_NQC_L_iC,
    bymNB_mun_NQC_L_iC_indUV_interac=bymNB_mun_NQC_L_iC_indUV_interac,
    bymNB_mun_NQC_L_iC_DispSec_interac=bymNB_mun_NQC_L_iC_DispSec_interac,
    bymNB_mun_NQC_L_iC_1Veh_interac=bymNB_mun_NQC_L_iC_1Veh_interac,
    bymNB_mun_NQC_L_iC_pts_interac=bymNB_mun_NQC_L_iC_pts_interac), difSignificativité = T), summary=F, rownames=F, type="text")

stargazer(mod_tableauPropre(list(
    bymNB_mun_NQC_L_iC=bymNB_mun_NQC_L_iC,
    bymNB_mun_NQC_L_iC_indUV_interac=bymNB_mun_NQC_L_iC_indUV_interac,
    bymNB_mun_NQC_L_iC_DispSec_interac=bymNB_mun_NQC_L_iC_DispSec_interac,
    bymNB_mun_NQC_L_iC_1Veh_interac=bymNB_mun_NQC_L_iC_1Veh_interac,
    bymNB_mun_NQC_L_iC_pts_interac=bymNB_mun_NQC_L_iC_pts_interac), difSignificativité = T) %>% 
            filter(Coefficients %in% c("Modèle", "Région", "Distribution", "Gravité", "VariableÉtudié", "ind_covidPost-Covid", "ptsMoyens", "indUV", "ind_covidPost-Covid:indUV", "indDSF", "indDSF:ind_covidPost-Covid", "ind1Veh", "ind1Veh:ind_covidPost-Covid", "ptsMoyens:ind_covidPost-Covid") | is.na(Coefficients))
    , summary=F, type="text", rownames=F)

# tab: coefs intrac MGL ####
stargazer(mod_tableauPropre(list(
    bymNB_mun_NQC_M_iC=bymNB_mun_NQC_M_iC,
    bymNB_mun_NQC_G_iC=bymNB_mun_NQC_G_iC,
    bymNB_mun_NQC_L_iC=bymNB_mun_NQC_L_iC,
    bymNB_mun_NQC_M_iC_indUV_interac=bymNB_mun_NQC_M_iC_indUV_interac,
    bymNB_mun_NQC_G_iC_indUV_interac=bymNB_mun_NQC_G_iC_indUV_interac,
    bymNB_mun_NQC_L_iC_indUV_interac=bymNB_mun_NQC_L_iC_indUV_interac,
    # bymNB_mun_NQC_G_iC_DispSec_interac=bymNB_mun_NQC_G_iC_DispSec_interac,
    # bymNB_mun_NQC_L_iC_DispSec_interac=bymNB_mun_NQC_L_iC_DispSec_interac,
    bymNB_mun_NQC_M_iC_1Veh_interac=bymNB_mun_NQC_M_iC_1Veh_interac,
    bymNB_mun_NQC_G_iC_1Veh_interac=bymNB_mun_NQC_G_iC_1Veh_interac,
    bymNB_mun_NQC_L_iC_1Veh_interac=bymNB_mun_NQC_L_iC_1Veh_interac)) %>%
    # bymNB_mun_NQC_G_iC_pts_interac=bymNB_mun_NQC_G_iC_pts_interac,
    # bymNB_mun_NQC_L_iC_pts_interac=bymNB_mun_NQC_L_iC_pts_interac), difSignificativité = T) %>% 
            filter(Coefficients %in% c("Gravité", "VariableÉtudié", "ind_covidPost-Covid", "ptsMoyens", "indUV", "ind_covidPost-Covid:indUV", "indDSF", "indDSF:ind_covidPost-Covid", "ind1Veh", "ind1Veh:ind_covidPost-Covid", "ptsMoyens:ind_covidPost-Covid") | is.na(Coefficients))
    , summary=F, type="latex", rownames=F)

```
Pas grande différence de l'indicateur tmeporel covid ni avec grave ou léger.
très difficile à mettre ensemble.

#### UV+1Veh

```{r}
sum(acc_PA_mun_NQC_M$nb1Veh_UV)/sum(acc_PA_mun_NQC_M$nb1Veh)
sum(acc_PA_mun_NQC_G$nb1Veh_UV)/sum(acc_PA_mun_NQC_G$nb1Veh)
sum(acc_PA_mun_NQC_L$nb1Veh_UV)/sum(acc_PA_mun_NQC_L$nb1Veh)

cor(acc_PA_mun_NQC_M$nb1Veh, acc_PA_mun_NQC_M$nbAcc_UV)


# Mun, Mortel
acc_PA_mun_NQC_M_UV_1Veh1 <- acc_PA_mun_NQC_M
acc_PA_mun_NQC_M_UV_1Veh2 <- acc_PA_mun_NQC_M
acc_PA_mun_NQC_M_UV_1Veh3 <- acc_PA_mun_NQC_M
acc_PA_mun_NQC_M_UV_1Veh4 <- acc_PA_mun_NQC_M

acc_PA_mun_NQC_M_UV_1Veh1$indUV <- 1
acc_PA_mun_NQC_M_UV_1Veh2$indUV <- 1
acc_PA_mun_NQC_M_UV_1Veh3$indUV <- 0
acc_PA_mun_NQC_M_UV_1Veh4$indUV <- 0
acc_PA_mun_NQC_M_UV_1Veh1$ind1Veh <- 1
acc_PA_mun_NQC_M_UV_1Veh2$ind1Veh <- 0
acc_PA_mun_NQC_M_UV_1Veh3$ind1Veh <- 1
acc_PA_mun_NQC_M_UV_1Veh4$ind1Veh <- 0

acc_PA_mun_NQC_M_UV_1Veh1$nombreAccidents <- acc_PA_mun_NQC_M$nb1Veh_UV # accidents avec UV et avec 1Veh
acc_PA_mun_NQC_M_UV_1Veh2$nombreAccidents <- acc_PA_mun_NQC_M$nbAcc_UV - acc_PA_mun_NQC_M$nb1Veh_UV # accidents avec UV sans 1Veh, accUV - accUV impliquant 1Veh
acc_PA_mun_NQC_M_UV_1Veh3$nombreAccidents <- acc_PA_mun_NQC_M$nb1Veh - acc_PA_mun_NQC_M$nb1Veh_UV # accidents sans UV avec 1Veh, acc1Veh - acc1Veh impliquant UV
acc_PA_mun_NQC_M_UV_1Veh4$nombreAccidents <- acc_PA_mun_NQC_M$nombreAccidents - acc_PA_mun_NQC_M$nb1Veh - acc_PA_mun_NQC_M$nbAcc_UV + acc_PA_mun_NQC_M$nb1Veh_UV

  # table((acc_PA_mun_NQC_M_UV_1Veh1$nombreAccidents + acc_PA_mun_NQC_M_UV_1Veh2$nombreAccidents + acc_PA_mun_NQC_M_UV_1Veh3$nombreAccidents + acc_PA_mun_NQC_M_UV_1Veh4$nombreAccidents) ==
  # acc_PA_mun_NQC_M$nombreAccidents)

acc_PA_mun_NQC_M_UV_1Veh1$nombreAccidents_VKT <- expected(population=acc_PA_mun_NQC_M_UV_1Veh1$vktPopu, cases=acc_PA_mun_NQC_M_UV_1Veh1$nombreAccidents, n.strata = 1)
acc_PA_mun_NQC_M_UV_1Veh2$nombreAccidents_VKT <- expected(population=acc_PA_mun_NQC_M_UV_1Veh2$vktPopu, cases=acc_PA_mun_NQC_M_UV_1Veh2$nombreAccidents, n.strata = 1)
acc_PA_mun_NQC_M_UV_1Veh3$nombreAccidents_VKT <- expected(population=acc_PA_mun_NQC_M_UV_1Veh3$vktPopu, cases=acc_PA_mun_NQC_M_UV_1Veh3$nombreAccidents, n.strata = 1)
acc_PA_mun_NQC_M_UV_1Veh4$nombreAccidents_VKT <- expected(population=acc_PA_mun_NQC_M_UV_1Veh4$vktPopu, cases=acc_PA_mun_NQC_M_UV_1Veh4$nombreAccidents, n.strata = 1)

acc_PA_mun_NQC_M_indUV_1Veh <- rbind(acc_PA_mun_NQC_M_UV_1Veh1, acc_PA_mun_NQC_M_UV_1Veh2, acc_PA_mun_NQC_M_UV_1Veh3, acc_PA_mun_NQC_M_UV_1Veh4)

dim(acc_PA_mun_NQC_M_indUV_1Veh)

# Mun, Grave
acc_PA_mun_NQC_G_UV_1Veh1 <- acc_PA_mun_NQC_G
acc_PA_mun_NQC_G_UV_1Veh2 <- acc_PA_mun_NQC_G
acc_PA_mun_NQC_G_UV_1Veh3 <- acc_PA_mun_NQC_G
acc_PA_mun_NQC_G_UV_1Veh4 <- acc_PA_mun_NQC_G

acc_PA_mun_NQC_G_UV_1Veh1$indUV <- 1
acc_PA_mun_NQC_G_UV_1Veh2$indUV <- 1
acc_PA_mun_NQC_G_UV_1Veh3$indUV <- 0
acc_PA_mun_NQC_G_UV_1Veh4$indUV <- 0
acc_PA_mun_NQC_G_UV_1Veh1$ind1Veh <- 1
acc_PA_mun_NQC_G_UV_1Veh2$ind1Veh <- 0
acc_PA_mun_NQC_G_UV_1Veh3$ind1Veh <- 1
acc_PA_mun_NQC_G_UV_1Veh4$ind1Veh <- 0

acc_PA_mun_NQC_G_UV_1Veh1$nombreAccidents <- acc_PA_mun_NQC_G$nb1Veh_UV # accidents avec UV et avec 1Veh
acc_PA_mun_NQC_G_UV_1Veh2$nombreAccidents <- acc_PA_mun_NQC_G$nbAcc_UV - acc_PA_mun_NQC_G$nb1Veh_UV # accidents avec UV sans 1Veh, accUV - accUV impliquant 1Veh
acc_PA_mun_NQC_G_UV_1Veh3$nombreAccidents <- acc_PA_mun_NQC_G$nb1Veh - acc_PA_mun_NQC_G$nb1Veh_UV # accidents sans UV avec 1Veh, acc1Veh - acc1Veh impliquant UV
acc_PA_mun_NQC_G_UV_1Veh4$nombreAccidents <- acc_PA_mun_NQC_G$nombreAccidents - acc_PA_mun_NQC_G$nb1Veh - acc_PA_mun_NQC_G$nbAcc_UV + acc_PA_mun_NQC_G$nb1Veh_UV


  # table((acc_PA_mun_NQC_G_UV_1Veh1$nombreAccidents + acc_PA_mun_NQC_G_UV_1Veh2$nombreAccidents + acc_PA_mun_NQC_G_UV_1Veh3$nombreAccidents + acc_PA_mun_NQC_G_UV_1Veh4$nombreAccidents) ==
  # acc_PA_mun_NQC_G$nombreAccidents)

acc_PA_mun_NQC_G_UV_1Veh1$nombreAccidents_VKT <- expected(population=acc_PA_mun_NQC_G_UV_1Veh1$vktPopu, cases=acc_PA_mun_NQC_G_UV_1Veh1$nombreAccidents, n.strata = 1)
acc_PA_mun_NQC_G_UV_1Veh2$nombreAccidents_VKT <- expected(population=acc_PA_mun_NQC_G_UV_1Veh2$vktPopu, cases=acc_PA_mun_NQC_G_UV_1Veh2$nombreAccidents, n.strata = 1)
acc_PA_mun_NQC_G_UV_1Veh3$nombreAccidents_VKT <- expected(population=acc_PA_mun_NQC_G_UV_1Veh3$vktPopu, cases=acc_PA_mun_NQC_G_UV_1Veh3$nombreAccidents, n.strata = 1)
acc_PA_mun_NQC_G_UV_1Veh4$nombreAccidents_VKT <- expected(population=acc_PA_mun_NQC_G_UV_1Veh4$vktPopu, cases=acc_PA_mun_NQC_G_UV_1Veh4$nombreAccidents, n.strata = 1)

acc_PA_mun_NQC_G_indUV_1Veh <- rbind(acc_PA_mun_NQC_G_UV_1Veh1, acc_PA_mun_NQC_G_UV_1Veh2, acc_PA_mun_NQC_G_UV_1Veh3, acc_PA_mun_NQC_G_UV_1Veh4)

dim(acc_PA_mun_NQC_G_indUV_1Veh)


table(acc_PA_mun_NQC_G_indUV_1Veh$indUV)
table(acc_PA_mun_NQC_G_indUV_1Veh$ind1Veh)
table(acc_PA_mun_NQC_G_indUV_1Veh$indUV==acc_PA_mun_NQC_G_indUV_1Veh$ind1Veh)




bymNB_mun_NQC_M_iC_indUV_interac_1Veh <- inla(update(form, nombreAccidents ~ . + ind1Veh*ind_covid + ind_covid * indUV +  + f(c(mun_NQC,mun_NQC, mun_NQC,mun_NQC), model = "bym", graph = W_mun_NQC, scale.model=TRUE)),
                # quantiles=c(0.05, 0.5, 0.95),
                family = "nbinomial",
                E = `nombreAccidents_VKT`,
                data = acc_PA_mun_NQC_M_indUV_1Veh,
                control.compute = list(dic = TRUE))


bymNB_mun_NQC_G_iC_indUV_interac_1Veh <- inla(update(form, nombreAccidents ~ . + ind_covid * indUV + ind_covid * ind1Veh + f(c(mun_NQC,mun_NQC, mun_NQC,mun_NQC), model = "bym", graph = W_mun_NQC, scale.model=TRUE)),
                # quantiles=c(0.05, 0.5, 0.95),
                family = "nbinomial",
                E = nombreAccidents_VKT,
                data = acc_PA_mun_NQC_G_indUV_1Veh,
                control.compute = list(dic = TRUE))

# tab: coefs 2var ####
stargazer(mod_tableauPropre(list(
  bymNB_mun_NQC_M_iC_1Veh_interac=bymNB_mun_NQC_M_iC_1Veh_interac,
  bymNB_mun_NQC_M_iC_indUV_interac=bymNB_mun_NQC_M_iC_indUV_interac,
  bymNB_mun_NQC_M_iC_indUV_interac_1Veh=bymNB_mun_NQC_M_iC_indUV_interac_1Veh
  ), difSignificativité = F) %>% filter(Coefficients %in% c("Gravité", "VariableÉtudié", "ind_covidPost-Covid", "indUV", "ind_covidPost-Covid:indUV", "indDSF", "indDSF:ind_covidPost-Covid", "ind1Veh", "ind1Veh:ind_covidPost-Covid", "ptsMoyens:ind_covidPost-Covid") | is.na(Coefficients))
, summary = F, rownames = F, type="latex")

mod_tableauPropre(list(
  bymNB_mun_NQC_G_iC_indUV_interac=bymNB_mun_NQC_G_iC_indUV_interac,
  bymNB_mun_NQC_G_iC_indUV_interac_1Veh=bymNB_mun_NQC_G_iC_indUV_interac_1Veh
  ), difSignificativité = T)


mod_tableauPropre(list(
  bymNB_mun_NQC_M_iC_indUV_interac_1Veh=bymNB_mun_NQC_M_iC_indUV_interac_1Veh,
  bymNB_mun_NQC_G_iC_indUV_interac_1Veh=bymNB_mun_NQC_G_iC_indUV_interac_1Veh
  ), difSignificativité = T)

summary(bymNB_mun_NQC_M_iC_indUV_interac_1Veh)
bymNB_mun_NQC_M_iC_indUV_interac

acc_PA_mun_NQC_M_indUV_1Veh %>% filter(indUV==1, ind1Veh==1) %>% .$nombreAccidents %>% sum
acc_PA_mun_NQC_M_indUV_1Veh %>% filter(indUV==0, ind1Veh==1) %>% .$nombreAccidents %>% sum
acc_PA_mun_NQC_M_indUV_1Veh %>% filter(indUV==1, ind1Veh==0) %>% .$nombreAccidents %>% sum
acc_PA_mun_NQC_M_indUV_1Veh %>% filter(indUV==0, ind1Veh==0) %>% .$nombreAccidents %>% sum
```



### Autres tentatives - nbAcc Ajusté
arrivent aux memes conclusions!

```{r}
acc_PA_mrc_NQC_M$nbAcc_AjUV <- acc_PA_mrc_NQC_M$nombreAccidents - acc_PA_mrc_NQC_M$nbAcc_UV
acc_PA_mun_NQC_M$nbAcc_AjUV <- acc_PA_mun_NQC_M$nombreAccidents - acc_PA_mun_NQC_M$nbAcc_UV
acc_PA_mrc_NQC_G$nbAcc_AjUV <- acc_PA_mrc_NQC_G$nombreAccidents - acc_PA_mrc_NQC_G$nbAcc_UV
acc_PA_mun_NQC_G$nbAcc_AjUV <- acc_PA_mun_NQC_G$nombreAccidents - acc_PA_mun_NQC_G$nbAcc_UV
acc_PA_mrc_NQC_L$nbAcc_AjUV <- acc_PA_mrc_NQC_L$nombreAccidents - acc_PA_mrc_NQC_L$nbAcc_UV
acc_PA_mun_NQC_L$nbAcc_AjUV <- acc_PA_mun_NQC_L$nombreAccidents - acc_PA_mun_NQC_L$nbAcc_UV

acc_PA_mun_NQC_M <- acc_PA_mun_NQC_M %>%
  mutate(E_UV=expected(population=vktPopu, cases=nbAcc_UV, n.strata = 1),
         E_AjUV=expected(population=vktPopu, cases=nbAcc_AjUV, n.strata = 1))
acc_PA_mrc_NQC_M <- acc_PA_mrc_NQC_M %>%
  mutate(E_UV=expected(population=vktPopu, cases=nbAcc_UV, n.strata = 1),
         E_AjUV=expected(population=vktPopu, cases=nbAcc_AjUV, n.strata = 1))

acc_PA_mun_NQC_G <- acc_PA_mun_NQC_G %>%
  mutate(E_UV=expected(population=vktPopu, cases=nbAcc_UV, n.strata = 1),
         E_AjUV=expected(population=vktPopu, cases=nbAcc_AjUV, n.strata = 1))
acc_PA_mrc_NQC_G <- acc_PA_mrc_NQC_G %>%
  mutate(E_UV=expected(population=vktPopu, cases=nbAcc_UV, n.strata = 1),
         E_AjUV=expected(population=vktPopu, cases=nbAcc_AjUV, n.strata = 1))

acc_PA_mun_NQC_L <- acc_PA_mun_NQC_L %>%
  mutate(E_UV=expected(population=vktPopu, cases=nbAcc_UV, n.strata = 1),
         E_AjUV=expected(population=vktPopu, cases=nbAcc_AjUV, n.strata = 1))
acc_PA_mrc_NQC_L <- acc_PA_mrc_NQC_L %>%
  mutate(E_UV=expected(population=vktPopu, cases=nbAcc_UV, n.strata = 1),
         E_AjUV=expected(population=vktPopu, cases=nbAcc_AjUV, n.strata = 1))

# MRC M
bymNB_mrc_NQC_M_iC_UV <- inla(update(form, nbAcc_UV ~ . + ind_covid + f(mrc_NQC, model = "bym", graph = W_mrc_NQC, scale.model=TRUE)),
                family = "nbinomial",
                E = `nombreAccidents_VKT`,
                data = acc_PA_mrc_NQC_M,
                control.compute = list(dic = TRUE))

bymNB_mrc_NQC_M_iC_ajUV <- inla(update(form, nbAcc_AjUV ~ . + ind_covid + f(mrc_NQC, model = "bym", graph = W_mrc_NQC, scale.model=TRUE)),
                family = "nbinomial",
                E = `nombreAccidents_VKT`,
                data = acc_PA_mrc_NQC_M,
                control.compute = list(dic = TRUE))
 
# mun M
bymNB_mun_NQC_M_iC_UV <- inla(update(form, nbAcc_UV ~ . + ind_covid + f(mun_NQC, model = "bym", graph = W_mun_NQC, scale.model=TRUE)),
                family = "nbinomial",
                E = E_UV,
                data = acc_PA_mun_NQC_M,
                control.compute = list(dic = TRUE))

bymNB_mun_NQC_M_iC_ajUV <- inla(update(form, nbAcc_AjUV ~ . + ind_covid + f(mun_NQC, model = "bym", graph = W_mun_NQC, scale.model=TRUE)),
                family = "nbinomial",
                E = E_AjUV,
                data = acc_PA_mun_NQC_M,
                control.compute = list(dic = TRUE))
 
# mun G
bymNB_mun_NQC_G_iC_UV <- inla(update(form, nbAcc_UV ~ . + ind_covid + f(mun_NQC, model = "bym", graph = W_mun_NQC, scale.model=TRUE)),
                family = "nbinomial",
                E = E_UV,
                data = acc_PA_mun_NQC_G,
                control.compute = list(dic = TRUE))

bymNB_mun_NQC_G_iC_ajUV <- inla(update(form, nbAcc_AjUV ~ . + ind_covid + f(mun_NQC, model = "bym", graph = W_mun_NQC, scale.model=TRUE)),
                family = "nbinomial",
                E = E_AjUV,
                data = acc_PA_mun_NQC_G,
                control.compute = list(dic = TRUE))

mods_UV_M <- list(bymNB_mun_NQC_M_iC=bymNB_mun_NQC_M_iC,
                bymNB_mun_NQC_M_iC_UV=bymNB_mun_NQC_M_iC_UV,
                bymNB_mun_NQC_M_iC_ajUV=bymNB_mun_NQC_M_iC_ajUV)
# extractDIC(vctrs::vec_c(mods_UV_M), bestFam = F) # aucune utilité, pas les memes données



# tab: coef nbAccUV ####
stargazer(mod_tableauPropre(mods_UV_M, difSignificativité = F)  %>% filter(!Coefficients %in% c("Modèle", "Région", "Distribution", "Covid-19", "Exposition", "NQC") | is.na(Coefficients)), summary = F, rownames = F, type="latex")


# mods_UV_G <- list(
#                 bymNB_mun_NQC_G_iC=bymNB_mun_NQC_G_iC,
#                 bymNB_mun_NQC_G_iC_UV=bymNB_mun_NQC_G_iC_UV,
#                 bymNB_mun_NQC_G_iC_ajUV=bymNB_mun_NQC_G_iC_ajUV)
# 
# stargazer(mod_tableauPropre(mods_UV_M, difSignificativité = F), type="text", summary=F, rownames=F)
# 
# stargazer(mod_tableauPropre(mods_UV_G, difSignificativité = T), type="text", summary=F, rownames=F)

```

```{r}
# M
acc_PA_mrc_NQC_M$nbAcc_Aj1Veh <- acc_PA_mrc_NQC_M$nombreAccidents - acc_PA_mrc_NQC_M$nb1Veh
acc_PA_mun_NQC_M$nbAcc_Aj1Veh <- acc_PA_mun_NQC_M$nombreAccidents - acc_PA_mun_NQC_M$nb1Veh
# G
acc_PA_mrc_NQC_G$nbAcc_Aj1Veh <- acc_PA_mrc_NQC_G$nombreAccidents - acc_PA_mrc_NQC_G$nb1Veh
acc_PA_mun_NQC_G$nbAcc_Aj1Veh <- acc_PA_mun_NQC_G$nombreAccidents - acc_PA_mun_NQC_G$nb1Veh
# L
acc_PA_mrc_NQC_L$nbAcc_Aj1Veh <- acc_PA_mrc_NQC_L$nombreAccidents - acc_PA_mrc_NQC_L$nb1Veh
acc_PA_mun_NQC_L$nbAcc_Aj1Veh <- acc_PA_mun_NQC_L$nombreAccidents - acc_PA_mun_NQC_L$nb1Veh

# Expected
acc_PA_mun_NQC_M <- acc_PA_mun_NQC_M %>%
  mutate(E_1Veh=expected(population=vktPopu, cases=nb1Veh, n.strata = 1),
         E_Aj1Veh=expected(population=vktPopu, cases=nbAcc_Aj1Veh, n.strata = 1))
acc_PA_mrc_NQC_M <- acc_PA_mrc_NQC_M %>%
  mutate(E_1Veh=expected(population=vktPopu, cases=nb1Veh, n.strata = 1),
         E_Aj1Veh=expected(population=vktPopu, cases=nbAcc_Aj1Veh, n.strata = 1))

acc_PA_mun_NQC_G <- acc_PA_mun_NQC_G %>%
  mutate(E_1Veh=expected(population=vktPopu, cases=nb1Veh, n.strata = 1),
         E_Aj1Veh=expected(population=vktPopu, cases=nbAcc_Aj1Veh, n.strata = 1))
acc_PA_mrc_NQC_G <- acc_PA_mrc_NQC_G %>%
  mutate(E_1Veh=expected(population=vktPopu, cases=nb1Veh, n.strata = 1),
         E_Aj1Veh=expected(population=vktPopu, cases=nbAcc_Aj1Veh, n.strata = 1))

acc_PA_mun_NQC_L <- acc_PA_mun_NQC_L %>%
  mutate(E_1Veh=expected(population=vktPopu, cases=nb1Veh, n.strata = 1),
         E_Aj1Veh=expected(population=vktPopu, cases=nbAcc_Aj1Veh, n.strata = 1))
acc_PA_mrc_NQC_L <- acc_PA_mrc_NQC_L %>%
  mutate(E_1Veh=expected(population=vktPopu, cases=nb1Veh, n.strata = 1),
         E_Aj1Veh=expected(population=vktPopu, cases=nbAcc_Aj1Veh, n.strata = 1))

# MRC M
bymNB_mrc_NQC_M_iC_1Veh <- inla(update(form, nb1Veh ~ . + ind_covid + f(mrc_NQC, model = "bym", graph = W_mrc_NQC, scale.model=TRUE)),
                family = "nbinomial",
                E = `nombreAccidents_VKT`,
                data = acc_PA_mrc_NQC_M,
                control.compute = list(dic = TRUE))

bymNB_mrc_NQC_M_iC_aj1Veh <- inla(update(form, nbAcc_Aj1Veh ~ . + ind_covid + f(mrc_NQC, model = "bym", graph = W_mrc_NQC, scale.model=TRUE)),
                family = "nbinomial",
                E = `nombreAccidents_VKT`,
                data = acc_PA_mrc_NQC_M,
                control.compute = list(dic = TRUE))
 
# mun M
bymNB_mun_NQC_M_iC_1Veh <- inla(update(form, nb1Veh ~ . + ind_covid + f(mun_NQC, model = "bym", graph = W_mun_NQC, scale.model=TRUE)),
                family = "nbinomial",
                E = E_1Veh,
                data = acc_PA_mun_NQC_M,
                control.compute = list(dic = TRUE))

bymNB_mun_NQC_M_iC_aj1Veh <- inla(update(form, nbAcc_Aj1Veh ~ . + ind_covid + f(mun_NQC, model = "bym", graph = W_mun_NQC, scale.model=TRUE)),
                family = "nbinomial",
                E = E_Aj1Veh,
                data = acc_PA_mun_NQC_M,
                control.compute = list(dic = TRUE))
 
# mun G
bymNB_mun_NQC_G_iC_1Veh <- inla(update(form, nb1Veh ~ . + ind_covid + f(mun_NQC, model = "bym", graph = W_mun_NQC, scale.model=TRUE)),
                family = "nbinomial",
                E = E_1Veh,
                data = acc_PA_mun_NQC_G,
                control.compute = list(dic = TRUE))

bymNB_mun_NQC_G_iC_aj1Veh <- inla(update(form, nbAcc_Aj1Veh ~ . + ind_covid + f(mun_NQC, model = "bym", graph = W_mun_NQC, scale.model=TRUE)),
                family = "nbinomial",
                E = E_Aj1Veh,
                data = acc_PA_mun_NQC_G,
                control.compute = list(dic = TRUE))

mods_1Veh_M <- list(bymNB_mun_NQC_M_iC=bymNB_mun_NQC_M_iC,
                bymNB_mun_NQC_M_iC_1Veh=bymNB_mun_NQC_M_iC_1Veh,
                bymNB_mun_NQC_M_iC_aj1Veh=bymNB_mun_NQC_M_iC_aj1Veh)
# extractDIC(vctrs::vec_c(mods_1Veh_M), bestFam = F) # aucune utilité, pas les memes données
stargazer(mod_tableauPropre(mods_1Veh_M, difSignificativité = T), type="text", summary=F, rownames=F)

mods_1Veh_G <- list(
                bymNB_mun_NQC_G_iC=bymNB_mun_NQC_G_iC,
                bymNB_mun_NQC_G_iC_1Veh=bymNB_mun_NQC_G_iC_1Veh,
                bymNB_mun_NQC_G_iC_aj1Veh=bymNB_mun_NQC_G_iC_aj1Veh)


stargazer(mod_tableauPropre(mods_1Veh_M, difSignificativité = T), type="text", summary=F, rownames=F)

stargazer(mod_tableauPropre(mods_1Veh_G, difSignificativité = T), type="text", summary=F, rownames=F)

```

```{r}
bymNB_mun_NQC_M_iC_UV1Veh <- inla(update(form, nombreAccidents ~ . + ind_covid * nbAcc_UV + ind_covid * nb1Veh + f(mun_NQC, model = "bym", graph = W_mun_NQC, scale.model=TRUE)),
                family = "nbinomial",
                E = nombreAccidents_VKT,
                data = acc_PA_mun_NQC_M,
                control.compute = list(dic = TRUE))

mod_tableauPropre(list(bymNB_mun_NQC_M_iC_UV1Veh=bymNB_mun_NQC_M_iC_UV1Veh))
 
cor(acc_PA_mun_NQC_M$nombreAccidents, acc_PA_mun_NQC_M$nbAcc_UV)
cor(acc_PA_mun_NQC_M$nombreAccidents, acc_PA_mun_NQC_M$nb1Veh)
cor(acc_PA_mun_NQC_M$nombreAccidents, acc_PA_mun_NQC_M$nb1Veh_UV)
cor(acc_PA_mun_NQC_M$nbAcc_UV, acc_PA_mun_NQC_M$nb1Veh)

cor(acc_PA_mun_NQC_M$nb1Veh_UV, acc_PA_mun_NQC_M$nbAcc_UV)
cor(acc_PA_mun_NQC_M$nb1Veh_UV, acc_PA_mun_NQC_M$nb1Veh)

sum(acc_PA_mun_NQC_M$nb1Veh_UV)/sum(acc_PA_mun_NQC_M$nb1Veh)

acc_PA_mun_NQC_M$nbAcc_Aj1Veh_sansUV <- acc_PA_mun_NQC_M$nb1Veh - acc_PA_mun_NQC_M$nb1Veh_UV
table(acc_PA_mun_NQC_M$nbAcc_Aj1Veh_sansUV>=0)

bymNB_mun_NQC_M_iC_1Veh_sanUV <- inla(update(form, nbAcc_Aj1Veh_sansUV ~ . + ind_covid + f(mun_NQC, model = "bym", graph = W_mun_NQC, scale.model=TRUE)),
                family = "nbinomial",
                E = E_1Veh,
                data = acc_PA_mun_NQC_M,
                control.compute = list(dic = TRUE))

mod_tableauPropre(list(
  bymNB_mun_NQC_M_iC_1Veh_sanUV=bymNB_mun_NQC_M_iC_1Veh_sanUV,
  bymNB_mun_NQC_M_iC_1Veh=bymNB_mun_NQC_M_iC_1Veh))
```
Ne semble pas être uniquement dû aux UV




